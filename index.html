<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procrasti-Nope</title>
    <link rel="icon" type="image/png" href="src/images/icon.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- External Stylesheet -->
    <link rel="stylesheet" href="style.css">
    
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Pre-emptive theme application to prevent flash of wrong theme -->
    <script>
        (function() {
            try {
                // Check local storage first (for guests)
                const guestData = localStorage.getItem('anonymousUserData');
                const storedSettings = guestData ? JSON.parse(guestData).settings : null;
                
                // If no guest data, check for a simpler theme setting (for logged-in users)
                const themeSetting = storedSettings ? storedSettings.theme : localStorage.getItem('userTheme');
                
                if (themeSetting) {
                    const isDark = themeSetting === 'dark' || (themeSetting === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                    if (isDark) {
                        document.documentElement.classList.add('dark-mode');
                    }
                }
            } catch (e) {
                console.error('Error applying initial theme:', e);
            }
        })();
    </script>
</head>
<body>
    <!-- Initial Loader -->
    <div id="loader-overlay">
        <div class="loader-box"></div>
    </div>

    <!-- Landing Page for first-time users (hidden by default) -->
    <div id="landing-page" style="display: none;">
        <div class="landing-container">
            <!-- Initial choices -->
            <div id="landing-choices">
                <h1 class="main-title" style="margin-bottom: 2rem;">Procrasti-Nope</h1>
                <div class="landing-buttons">
                    <button id="landing-login-btn" class="btn">Login / Sign Up</button>
                    <button id="landing-guest-btn" class="btn">Continue as Guest</button>
                </div>
            </div>
            <!-- Auth form container -->
            <div id="landing-auth-container" style="display: none;">
                <!-- Content is dynamically filled from the #account-modal-content template -->
            </div>
        </div>
    </div>

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" style="display: none;">
        <header class="sticky-header">
            <div class="header-content">
                <h1 class="main-title">Procrasti-Nope</h1>
                <p class="quote" id="quote-of-the-day">Loading a dose of motivation...</p>
            </div>
            <div class="header-controls">
                <button id="friends-btn-desktop" class="btn" aria-label="Open Friends Menu" aria-haspopup="dialog" aria-controls="friends-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <span>Friends</span>
                    <span id="friend-request-count" class="notification-badge"></span>
                </button>
                <button id="settings-btn" class="btn icon-btn" aria-label="Open Settings" aria-haspopup="dialog" aria-controls="settings-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <section class="player-progress-section">
            <div class="level-display">LVL <span id="player-level">1</span></div>
            <div class="xp-bar-container">
                <div id="xp-bar" class="xp-bar"></div>
                <span id="xp-text">0 / 100 XP</span>
            </div>
        </section>

        <main class="container">
            <div class="quests-layout">
                <section class="task-group mobile-visible" data-section="daily">
                    <header class="task-group-header">
                        <h2>Daily Quests</h2>
                        <button class="btn add-task-trigger-btn" data-list="daily" aria-label="Add Daily Quest" aria-haspopup="dialog" aria-controls="add-task-modal">+</button>
                    </header>
                    <div id="shared-quests-container" class="shared-quests-container">
                        <!-- Shared quests will be dynamically inserted here -->
                    </div>
                    <ul id="daily-task-list"></ul>
                    <div id="no-daily-tasks-message" style="display: none; text-align: center; padding: 2rem; opacity: 0.7;">
                        <p>No daily quests yet. Add one to start your day!</p>
                    </div>
                </section>
                <section class="task-group" data-section="main">
                    <header class="task-group-header">
                        <h2>Main Quests</h2>
                        <div class="header-actions">
                            <button id="add-standalone-task-btn" class="btn" aria-label="Add Quest" aria-haspopup="dialog" aria-controls="add-task-modal">Add Quest</button>
                            <button id="add-group-btn" class="btn" aria-label="Add Group" aria-haspopup="dialog" aria-controls="add-group-modal">Add Group</button>
                        </div>
                    </header>
                    <ul id="standalone-task-list"></ul>
                    <div id="general-task-list-container"></div>
                    <div id="no-general-tasks-message" style="display: none; text-align: center; padding: 2rem; opacity: 0.7;">
                        <p>No main quests on your list. Create a group or add a quest to get started!</p>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Mobile Navigation Bar -->
    <nav id="mobile-nav">
        <div class="mobile-nav-content">
            <button class="mobile-nav-btn active" data-section="daily" aria-label="Daily Quests">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linejoin="round"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"></path></svg>
                <span>Daily</span>
            </button>
            <button class="mobile-nav-btn" data-section="main" aria-label="Main Quests">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                <span>Main</span>
            </button>
            <button class="mobile-nav-btn" data-section="friends" aria-label="Friends" aria-haspopup="dialog" aria-controls="friends-modal">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span>Friends</span>
                 <span id="friend-request-count-mobile" class="notification-badge"></span>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    <div id="add-task-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="add-task-modal-title">
            <h2 id="add-task-modal-title">Add New Quest</h2>
            <form id="add-task-form">
                <input type="text" id="new-task-input" placeholder="e.g., Conquer the world..." required maxlength="30">
                <div id="weekly-goal-container" style="display: none;">
                    <label for="new-task-weekly-goal-slider">Weekly Goal: <span id="new-task-weekly-goal-display">None</span></label>
                    <div class="weekly-goal-slider-container">
                         <input type="range" id="new-task-weekly-goal-slider" min="0" max="7" value="0">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="add-task-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-task-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="edit-task-modal-title">
            <h2 id="edit-task-modal-title">Edit Quest</h2>
            <form id="edit-task-form">
                <input type="hidden" id="edit-task-id">
                <input type="text" id="edit-task-input" required maxlength="30">
                <div id="edit-weekly-goal-container" style="display: none;">
                    <label for="edit-task-weekly-goal-slider">Weekly Goal: <span id="edit-task-weekly-goal-display">3</span> days</label>
                    <div class="weekly-goal-slider-container">
                        <input type="range" id="edit-task-weekly-goal-slider" min="0" max="7" value="3">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="edit-task-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-group-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="add-group-modal-title">
            <h2 id="add-group-modal-title">Create New Group</h2>
            <form id="add-group-form">
                <input type="text" id="new-group-input" placeholder="e.g., Project Overlord" required maxlength="30">
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="add-group-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="timer-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="timer-modal-title">
            <h2 id="timer-modal-title">Set Task Timer</h2>
            <form id="timer-form">
                <div class="timer-slider-container">
                    <label for="timer-duration-slider">Duration: <span id="timer-duration-display">25</span></label>
                    <input type="range" id="timer-duration-slider" min="1" max="100" value="25">
                </div>
                <div class="timer-unit-selector">
                    <button type="button" class="btn timer-unit-btn" data-unit="seconds">Seconds</button>
                    <button type="button" class="btn timer-unit-btn selected" data-unit="minutes">Minutes</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="hours">Hours</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="days">Days</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="weeks">Weeks</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="months">Months</button>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="timer-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Start Timer</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="friends-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-label="Friends and Shares">
            <div id="friends-modal-bg">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><defs><filter id="f" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="40"></feGaussianBlur></filter></defs><g filter="url(#f)"><circle cx="400" cy="400" r="150" fill="var(--accent-blue)"></circle><circle cx="100" cy="200" r="100" fill="var(--accent-green)"></circle><circle cx="600" cy="150" r="120" fill="var(--accent-red)"></circle><circle cx="700" cy="650" r="180" fill="var(--accent-yellow)"></circle><circle cx="200" cy="700" r="90" fill="var(--accent-purple)"></circle></g></svg>
            </div>
            <div class="form-toggle">
                <button class="toggle-btn active" data-tab="my-friends">Friends</button>
                <button class="toggle-btn" data-tab="requests">Requests <span id="friend-request-count-modal" class="notification-badge"></span></button>
                <button class="toggle-btn" data-tab="shares">Shares <span id="shares-request-count-modal" class="notification-badge"></span></button>
                <button class="toggle-btn" data-tab="add-friend">Add</button>
            </div>
            
            <div id="my-friends-tab" class="tab-content active">
                <h3>My Friends</h3>
                <div class="friends-list-container"></div>
            </div>
            
            <div id="requests-tab" class="tab-content">
                <h3>Friend Requests</h3>
                <div class="friend-requests-container"></div>
            </div>

            <div id="shares-tab" class="tab-content">
                <h3>Incoming Shares</h3>
                <div class="incoming-shares-container">
                    <!-- Incoming shared quests will be dynamically inserted here -->
                </div>
            </div>

            <div id="add-friend-tab" class="tab-content">
                 <h3>Add Friend by Username</h3>
                 <form id="add-friend-form">
                    <input type="text" id="search-username-input" placeholder="Enter username..." required>
                    <button type="submit" class="btn icon-btn" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
                 </form>
                 <p class="friend-status-message"></p>
            </div>
            
            <div class="modal-actions"><button class="btn" data-close-modal="friends-modal">Close</button></div>
        </div>
    </div>
    
    <div id="share-quest-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="share-quest-modal-title">
            <h2 id="share-quest-modal-title">Share Quest With...</h2>
            <input type="hidden" id="share-quest-id-input">
            <div id="share-quest-friend-list" class="share-quest-friend-list">
                <!-- Friend list will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="btn" data-close-modal="share-quest-modal">Cancel</button>
            </div>
        </div>
    </div>

    <!-- NEW: Share Group Modal -->
    <div id="share-group-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="share-group-modal-title">
            <h2 id="share-group-modal-title">Share Group "<span id="share-group-name-display"></span>" With...</h2>
            <input type="hidden" id="share-group-id-input">
            <div id="share-group-friend-list" class="share-quest-friend-list">
                <!-- Friend list will be populated here -->
            </div>
            <div class="modal-actions">
                <button class="btn" data-close-modal="share-group-modal">Cancel</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title">
            <h2 id="settings-modal-title">Settings</h2>
            <div class="settings-group">
                <h3>Account</h3>
                <div class="account-actions">
                    <span id="user-display" style="display: none; align-items:center;"></span>
                    <button id="settings-login-btn" class="btn" aria-haspopup="dialog" aria-controls="account-modal">Login / Sign Up</button>
                    <button id="manage-account-btn" class="btn" style="display: none;" aria-haspopup="dialog" aria-controls="manage-account-modal">Manage Account</button>
                    <button id="logout-btn" class="btn" style="display: none;">Logout</button>
                </div>
            </div>
            <div class="settings-group">
                <h3>Theme</h3>
                <div class="theme-options" id="theme-options-buttons">
                    <button class="btn theme-btn" data-theme="light" aria-label="Light Theme"><svg class="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span>Light</span></button>
                    <button class="btn theme-btn" data-theme="dark" aria-label="Dark Theme"><svg class="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><span>Dark</span></button>
                    <button class="btn theme-btn" data-theme="system" aria-label="System Theme"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg><span>System</span></button>
                </div>
            </div>
            <div class="settings-group">
                <h3>Accent Color</h3>
                <div class="color-options" id="color-options">
                    <div class="color-swatch" data-color="var(--accent-red)" style="background-color: var(--accent-red);"></div><div class="color-swatch" data-color="var(--accent-orange)" style="background-color: var(--accent-orange);"></div><div class="color-swatch" data-color="var(--accent-amber)" style="background-color: var(--accent-amber);"></div><div class="color-swatch" data-color="var(--accent-yellow)" style="background-color: var(--accent-yellow);"></div><div class="color-swatch" data-color="var(--accent-lime)" style="background-color: var(--accent-lime);"></div><div class="color-swatch" data-color="var(--accent-green)" style="background-color: var(--accent-green);"></div><div class="color-swatch" data-color="var(--accent-teal)" style="background-color: var(--accent-teal);"></div><div class="color-swatch" data-color="var(--accent-cyan)" style="background-color: var(--accent-cyan);"></div><div class="color-swatch" data-color="var(--accent-blue)" style="background-color: var(--accent-blue);"></div><div class="color-swatch" data-color="var(--accent-indigo)" style="background-color: var(--accent-indigo);"></div><div class="color-swatch" data-color="var(--accent-purple)" style="background-color: var(--accent-purple);"></div><div class="color-swatch" data-color="var(--accent-pink)" style="background-color: var(--accent-pink);"></div>
                </div>
            </div>
            <div class="settings-group">
                <h3>Sound Volume</h3>
                <div class="volume-slider-container"><input type="range" id="volume-slider" min="0" max="1" step="0.01" aria-label="Volume"></div>
            </div>
             <div id="guest-data-management" class="settings-group">
                <h3 id="data-management-heading">Data (Local)</h3>
                <div class="data-actions">
                    <button id="export-data-btn" class="btn">Export Guest Data</button>
                    <button id="import-data-btn" class="btn">Import Guest Data</button>
                    <input type="file" id="import-file-input" style="display: none;" accept=".json">
                    <button id="reset-progress-btn" class="btn">Reset Progress</button>
                </div>
            </div>
            <div class="modal-actions"><button class="btn" data-close-modal="settings-modal">Close</button></div>
        </div>
    </div>
    
    <div id="account-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-label="Account Creation and Login"></div>
    </div>
    
    <div id="manage-account-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-label="Manage Account">
            <div id="reauth-container">
                <h2>Confirm Password</h2>
                <p style="margin-bottom: 1.5rem;">For your security, please enter your password to continue.</p>
                <form id="reauth-form" class="auth-form">
                    <div class="form-group">
                        <label for="reauth-password">Current Password</label>
                        <input type="password" id="reauth-password" required>
                    </div>
                    <button type="submit" class="btn modal-submit-btn" style="width: 100%;">Confirm</button>
                    <p class="error-message" id="reauth-error"></p>
                </form>
            </div>

            <div id="manage-forms-container" style="display: none;">
                <h2>Manage Account</h2>
                
                <form id="update-username-form" class="auth-form" style="margin-top: 2rem;">
                     <div class="settings-group">
                        <h3>Change Username</h3>
                        <p style="margin-bottom: 1rem; font-size: 0.9em; opacity: 0.8;">Changing your username will also update how you log in.</p>
                        <div class="form-group">
                            <label for="update-username-input">New Username</label>
                            <input type="text" id="update-username-input" required minlength="3" maxlength="15">
                        </div>
                        <button type="submit" class="btn modal-submit-btn">Update Username</button>
                        <p class="error-message" id="update-username-error"></p>
                        <p class="success-message" id="update-username-success"></p>
                    </div>
                </form>

                <form id="update-email-form" class="auth-form" style="margin-top: 2rem;">
                     <div class="settings-group">
                        <h3>Change Email</h3>
                         <p style="margin-bottom: 1rem; font-size: 0.9em; opacity: 0.8;">You will be asked to confirm your current password again.</p>
                        <div class="form-group">
                            <label for="update-email-password">Current Password</label>
                            <input type="password" id="update-email-password" required>
                        </div>
                        <div class="form-group">
                            <label for="update-email-input">New Email</label>
                            <input type="email" id="update-email-input" required>
                        </div>
                        <button type="submit" class="btn modal-submit-btn">Update Email</button>
                        <p class="error-message" id="update-email-error"></p>
                        <p class="success-message" id="update-email-success"></p>
                    </div>
                </form>

                <form id="update-password-form" class="auth-form" style="margin-top: 2rem;">
                    <div class="settings-group">
                        <h3>Change Password</h3>
                        <div class="form-group">
                            <label for="update-password-input">New Password</label>
                            <input type="password" id="update-password-input" required>
                        </div>
                        <button type="submit" class="btn modal-submit-btn">Update Password</button>
                        <p class="error-message" id="update-password-error"></p>
                        <p class="success-message" id="update-password-success"></p>
                    </div>
                </form>
                
                <div class="settings-group">
                    <h3>Reset Data</h3>
                    <p style="margin-bottom: 1rem; font-size: 0.9em; opacity: 0.8;">This will reset all your quests and progress in the cloud. It cannot be undone.</p>
                    <button type="button" id="reset-cloud-data-btn" class="btn" style="width: 100%;">Reset Cloud Data</button>
                </div>

                <div class="settings-group">
                    <h3>Delete Account</h3>
                    <p style="margin-bottom: 1rem; font-size: 0.9em; opacity: 0.8;">This is permanent and cannot be undone. All your data will be erased.</p>
                    <button type="button" id="delete-account-btn" class="btn" style="width: 100%; background-color: var(--accent-red); color: var(--text-on-accent); --shadow-color: var(--shadow-dark);">Delete My Account</button>
                </div>
            </div>
            <div class="modal-actions">
                 <button type="button" class="btn" data-close-modal="manage-account-modal">Close</button>
            </div>
        </div>
    </div>
    
    <div id="google-signin-loader-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 300px; text-align: center;" role="alertdialog" aria-modal="true" aria-labelledby="google-loader-title">
            <h2 id="google-loader-title" style="font-size: 1.5rem;">Connecting...</h2>
            <div class="loader-box" style="margin: 2rem auto;"></div>
            <p>Please complete the sign-in in the popup window.</p>
        </div>
    </div>

    <div id="username-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="username-modal-title">
            <h2 id="username-modal-title">Choose your Username</h2>
            <p style="margin-bottom: 1.5rem;">This will be your unique public name for login and adding friends.</p>
            <form id="username-form">
                <input type="text" id="new-username-input" placeholder="e.g., QuestMaster" required minlength="3" maxlength="15">
                <p class="error-message username-error"></p>
                <div class="modal-actions" style="justify-content: flex-end;">
                    <button type="submit" class="btn modal-submit-btn">Save Username</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="timer-menu-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;" role="dialog" aria-modal="true" aria-labelledby="timer-menu-title">
            <h2 id="timer-menu-title">Active Timer</h2><p style="margin-bottom: 1.5rem;">This quest has a timer running.</p>
            <div class="modal-actions" style="justify-content: space-around;">
                <button type="button" id="timer-menu-cancel-btn" class="btn">Cancel Timer</button>
                <button type="button" class="btn" data-close-modal="timer-menu-modal">Leave</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirm-title" aria-describedby="confirm-text">
            <h2 id="confirm-title">Are you sure?</h2>
            <p id="confirm-text" style="margin-bottom: 1.5rem;">This action cannot be undone.</p>
            <div class="modal-actions">
                <button type="button" id="confirm-cancel-btn" class="btn">Cancel</button>
                <button type="submit" id="confirm-action-btn" class="btn modal-submit-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Template for Auth Forms -->
    <template id="account-modal-content">
        <div class="form-toggle">
            <button class="toggle-btn active" data-tab="signup">Sign Up</button>
            <button class="toggle-btn" data-tab="login">Login</button>
        </div>
        <form class="auth-form" data-form="signup">
            <div class="form-group"><label for="signup-username">Username</label><input type="text" class="signup-username" required minlength="3" maxlength="15"></div>
            <div class="form-group"><label for="signup-email">Email</label><input type="email" class="signup-email" required></div>
            <div class="form-group"><label for="signup-password">Password</label><input type="password" class="signup-password" required></div>
            <button type="submit" class="btn modal-submit-btn" style="width: 100%;">Create Account</button>
            <p class="error-message signup-error"></p>
        </form>
        <form class="auth-form" data-form="login" style="display: none;">
             <div class="form-group"><label for="login-email">Email or Username</label><input type="text" class="login-email" required></div>
             <div class="form-group"><label for="login-password">Password</label><input type="password" class="login-password" required></div>
             <button type="submit" class="btn modal-submit-btn" style="width: 100%;">Login</button>
             <p class="error-message login-error"></p>
             <div class="form-divider">OR</div>
             <div class="google-signin-btn-container"></div>
        </form>
    </template>

    <!-- Main Application Script -->
    <script src="script.js" type="module" defer></script>
</body>
</html>