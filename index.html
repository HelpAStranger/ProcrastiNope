<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procrasti-Nope | Task Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Firebase SDKs (Updated Version) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions to the global scope to be used in the main script
        window.firebaseSDK = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot
        };
    </script>
    <style>
        /*
        ==========================================================================
        NEOBRUTALIST THEME & VARIABLES (REVAMPED)
        ==========================================================================
        */
        :root {
            --font-main: 'Inter', sans-serif;

            /* Light Theme - WARM & PASTEL */
            --bg-light: #FFF8E7; /* Soft Cream */
            --text-light: #4E443A; /* Warm Dark Brown */
            --border-light: #4E443A;
            --shadow-light: #4E443A;
            --surface-light: #FFFFFF;
            --text-on-accent: #4E443A; /* Dark text for light pastels */

            /* Dark Theme - WARM & PASTEL */
            --bg-dark: #2D261E; /* Dark Warm Brown */
            --text-dark: #EAE2D6; /* Warm Off-white */
            --border-dark: #EAE2D6;
            --shadow-dark: #EAE2D6;
            --surface-dark: #3E3529; /* Lighter Warm Brown */
            
            /* Light Theme Accent Colors */
            --accent-pink-light: #FFB7C5;
            --accent-blue-light: #99CCFF;
            --accent-green-light: #A7D4A8;
            --accent-orange-light: #FFB347;
            --accent-purple-light: #C7A2F4;
            --accent-yellow-light: #FFEE93;
            --accent-cyan-light: #A4DDED;
            --accent-red-light: #FF6961;
            --accent-lime-light: #D4E99E;
            --accent-indigo-light: #A5ADFF;
            --accent-teal-light: #87D7C8;
            --accent-amber-light: #FFCF8B;

            /* Base Accent Colors (default to light) */
            --accent-pink: var(--accent-pink-light);
            --accent-blue: var(--accent-blue-light);
            --accent-green: var(--accent-green-light);
            --accent-orange: var(--accent-orange-light);
            --accent-purple: var(--accent-purple-light);
            --accent-yellow: var(--accent-yellow-light);
            --accent-cyan: var(--accent-cyan-light);
            --accent-red: var(--accent-red-light);
            --accent-lime: var(--accent-lime-light);
            --accent-indigo: var(--accent-indigo-light);
            --accent-teal: var(--accent-teal-light);
            --accent-amber: var(--accent-amber-light);

            /* Default State (Light) */
            --bg: var(--bg-light);
            --text: var(--text-light);
            --border: var(--border-light);
            --shadow: var(--shadow-light);
            --surface: var(--surface-light);
            --accent: var(--accent-red);
            --shadow-color: var(--shadow);
            --noise-opacity: 0.05;


            /* Universal Settings */
            --border-width: 3px;
            --shadow-offset: 6px;
            --radius: 12px;
            --transition-speed: 0.2s;
        }

        .dark-mode {
            --bg: var(--bg-dark);
            --text: var(--text-dark);
            --border: var(--border-dark);
            --shadow: var(--shadow-dark);
            --surface: var(--surface-dark);
            --text-on-accent: var(--text-dark); /* Use light text for pastels in dark mode */
            --noise-opacity: 0.08;
            
            /* Dark Theme Accent Colors (Darker, more pastel) */
            --accent-pink-dark: #C98B96;
            --accent-blue-dark: #8A9EC4;
            --accent-green-dark: #8DAF8E;
            --accent-orange-dark: #D99A5B;
            --accent-purple-dark: #A991C4;
            --accent-yellow-dark: #CEC592;
            --accent-cyan-dark: #93B2BC;
            --accent-red-dark: #D97C75;
            --accent-lime-dark: #B4C290;
            --accent-indigo-dark: #9A9FDA;
            --accent-teal-dark: #7DAAA1;
            --accent-amber-dark: #D9B383;

            /* Remap Base Accent Colors to Dark Versions */
            --accent-pink: var(--accent-pink-dark);
            --accent-blue: var(--accent-blue-dark);
            --accent-green: var(--accent-green-dark);
            --accent-orange: var(--accent-orange-dark);
            --accent-purple: var(--accent-purple-dark);
            --accent-yellow: var(--accent-yellow-dark);
            --accent-cyan: var(--accent-cyan-dark);
            --accent-red: var(--accent-red-dark);
            --accent-lime: var(--accent-lime-dark);
            --accent-indigo: var(--accent-indigo-dark);
            --accent-teal: var(--accent-teal-dark);
            --accent-amber: var(--accent-amber-dark);
        }

        /*
        ==========================================================================
        BASE & LAYOUT
        ==========================================================================
        */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
        }
        
        /* Custom Scrollbar Styles */
        html {
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--surface);
        }

        body::-webkit-scrollbar {
            width: 14px;
        }

        body::-webkit-scrollbar-track {
            background: var(--surface);
            border-left: var(--border-width) solid var(--border);
        }

        body::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: var(--radius);
            border: var(--border-width) solid var(--border);
        }

        body::before {
            content: '';
            display: block;
            height: 10px;
            background-color: var(--accent);
            transition: background-color var(--transition-speed) ease;
        }
        
        /* Grainy Texture Overlay */
        body::after {
            content: "";
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MDAgNTAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuOCIgbnVtT2N0YXZlcz0iMyIgc3RpdGNoVGlsZXM9InN0aXRjaCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbHRlcj0idXJsKCNub2lzZSkiLz48L3N2Zz4=');
            background-size: 250px 250px;
            opacity: var(--noise-opacity);
            pointer-events: none;
            z-index: 10000;
            transition: opacity var(--transition-speed) ease;
            animation: grain 8s steps(10) infinite;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            overflow-x: hidden;
        }
        
        #app-wrapper {
            transition: filter 0.3s ease-in-out;
        }

        #app-wrapper.blur-background {
            filter: blur(5px);
            pointer-events: none;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .quests-layout {
            display: flex;
            flex-direction: column; /* Default: stack quests vertically */
        }

        /* For wider screens, display quests side-by-side */
        @media (min-width: 1024px) {
            .container {
                max-width: 1280px; /* Widen the container */
            }

            .quests-layout {
                flex-direction: row; /* Place items in a row */
                gap: 2rem; /* Add space between the two columns */
                align-items: flex-start; /* Align columns to the top */
            }

            .quests-layout > .task-group {
                flex: 1 1 0px; /* Allow each column to grow and take up equal space */
                margin-bottom: 0; /* Remove bottom margin as 'gap' handles spacing */
            }

            /* Hover effects for action buttons on desktop */
            .task-item .task-actions,
            .task-item .timer-clock-btn,
            .main-quest-group-header .group-actions {
                opacity: 0;
                transition: opacity var(--transition-speed) ease;
                pointer-events: none;
            }

            .task-item:hover .task-actions,
            .task-item:hover .timer-clock-btn,
            .main-quest-group-header:hover .group-actions,
            .task-item.timer-active .timer-clock-btn {
                opacity: 1;
                pointer-events: auto;
            }
        }
        
        /*
        ==========================================================================
        LOADING ANIMATION
        ==========================================================================
        */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .loader-box {
            width: 60px;
            height: 60px;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow);
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg) scale(1); border-radius: 0; }
            50% { transform: rotate(180deg) scale(0.8); border-radius: 50%; }
            100% { transform: rotate(360deg) scale(1); border-radius: 0; }
        }
        
        /*
        ==========================================================================
        LANDING PAGE
        ==========================================================================
        */
        #landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .landing-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            padding: 2.5rem 2rem;
            text-align: center;
        }

        .landing-buttons {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .landing-buttons .btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
        }
        #landing-back-btn {
            margin-top: 1.5rem;
        }


        /*
        ==========================================================================
        HEADER & PROGRESS
        ==========================================================================
        */
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: var(--bg);
            padding: 1.5rem 1rem;
            z-index: 10;
            border-bottom: var(--border-width) solid var(--border);
            box-shadow: 0 var(--shadow-offset) 0 var(--shadow);
            margin-bottom: 0; /* Adjusted */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content {
            text-align: left;
        }

        .header-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        #user-display {
            font-weight: 700;
        }
        
        .main-title {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: -2px;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: var(--accent);
        }
        .main-title:hover {
            transform: rotate(-2deg) scale(1.05);
        }


        .quote {
            font-size: 1rem;
            font-weight: 700;
            font-style: italic;
            opacity: 0.8;
        }
        
        .player-progress-section {
            background-color: var(--surface);
            border-bottom: var(--border-width) solid var(--border);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .level-display {
            background-color: var(--accent);
            color: var(--text-on-accent);
            font-weight: 900;
            padding: 0.5rem 1rem;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow);
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .level-display.level-up {
            animation: levelUpPulse 0.5s ease-in-out;
        }
        
        .xp-bar-container {
            flex-grow: 1;
            background-color: var(--bg);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            padding: 0.25rem;
            position: relative;
        }
        
        .xp-bar {
            width: 0%;
            height: 25px;
            background-color: var(--accent);
            border-radius: calc(var(--radius) / 2);
            transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        #xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            color: var(--text);
            mix-blend-mode: difference;
            filter: invert(1) grayscale(1);
        }
        .dark-mode #xp-text {
            mix-blend-mode: normal; /* Changed from unset */
            filter: none; /* Changed from unset */
            color: var(--text-dark); /* Explicitly set color for dark mode */
        }


        /*
        ==========================================================================
        TASK LIST & ITEMS
        ==========================================================================
        */
        .task-group {
            margin-bottom: 3rem;
        }

        .task-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: var(--border-width) solid var(--border);
        }
        
        .task-group-header .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .task-group-header h2 {
            font-size: 1.8rem;
            font-weight: 900;
        }

        .main-quest-group, .task-item {
            cursor: grab;
        }
        
        .sortable-ghost {
            opacity: 0.4;
            background-color: var(--accent);
        }
        
        /* Shake animation for all items during drag */
        body.is-dragging .task-item,
        body.is-dragging .main-quest-group {
            animation: shake-light 0.4s cubic-bezier(.36,.07,.19,.97) both infinite;
        }


        .main-quest-group {
            margin-bottom: 2rem;
            transition: all var(--transition-speed) ease;
        }
        
        .main-quest-group.removing {
             animation: slideOut 0.4s ease forwards;
        }

        .main-quest-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            position: relative;
            cursor: pointer;
        }

        .group-title-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-grow: 1;
        }

        .expand-icon {
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .main-quest-group.expanded .expand-icon {
            transform: rotate(90deg);
        }

        /* Emphasis for group headers */
        .main-quest-group-header::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: var(--border-width) dashed var(--border);
            border-radius: calc(var(--radius) * 0.5);
            opacity: 0.5;
            pointer-events: none; /* Fix: Allow clicks to pass through the overlay */
        }

        .main-quest-group-header h3 {
            font-size: 1.3rem;
            font-weight: 900;
        }

        .main-quest-group-header .group-actions {
            display: flex;
            gap: 0.5rem;
        }


        #daily-task-list, #standalone-task-list, .main-quest-group ul {
            list-style: none;
            min-height: 20px; /* Drop zone */
        }

        .main-quest-group ul.task-list-group {
            min-height: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out, margin-top 0.2s ease-out;
            margin-top: 0;
            padding: 0;
        }

        .main-quest-group:hover ul.task-list-group,
        .main-quest-group.expanded ul.task-list-group {
            max-height: 600px; /* Arbitrary large value to allow for many tasks */
            margin-top: 1rem;
            transition: max-height 0.25s ease-in;
        }
        
        #standalone-task-list {
            margin-bottom: 2rem;
        }


        .task-item {
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            transition: all var(--transition-speed) ease, max-height var(--transition-speed) ease;
            position: relative;
            overflow: hidden;
            max-height: 100px; /* Base height for transitions */
        }
        
        /* Standalone quests look like group headers */
        .task-item.standalone-quest {
             padding: 1rem;
        }
         .task-item.standalone-quest::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: var(--border-width) dashed var(--border);
            border-radius: calc(var(--radius) * 0.5);
            opacity: 0.5;
            pointer-events: none; /* Fix: Allow clicks to pass through the overlay */
        }
         .task-item.standalone-quest .task-text {
            font-size: 1.3rem;
            font-weight: 900;
        }

        .task-item.overdue {
            animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) infinite both;
            border-color: var(--accent-red);
            --shadow-color: var(--accent-red);
        }
        
        .task-item.daily-completed {
            max-height: 50px;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            opacity: 0.6;
            filter: grayscale(0.5);
            cursor: pointer; /* To indicate it's clickable for undo */
        }
        .task-item.daily-completed .task-text {
            text-decoration: line-through;
        }
        .task-item.daily-completed .task-controls {
            display: none;
        }

        /* Weekly goal met style */
        .task-item.weekly-goal-met {
            border-style: dashed;
            opacity: 0.8;
        }
        .task-item.weekly-goal-met::after {
            content: 'GOAL MET!';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-10deg);
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent);
            opacity: 0.1;
            pointer-events: none;
        }

        /* Add/Remove Animation */
        .task-item.adding {
            animation: slideIn 0.4s ease forwards;
        }

        .task-item.removing {
            animation: slideOut 0.4s ease forwards;
        }

        /* Completion Animation */
        .task-item.completed {
            animation: celebrate 0.8s ease-in-out forwards;
        }
        
        .task-item .task-content {
             display: flex;
             align-items: center;
             flex-grow: 1;
             flex-basis: 0; /* Important for flex wrapping */
             margin-right: 1rem;
        }

        .task-item .task-text {
            font-size: 1.1rem;
            font-weight: 700;
            outline: none;
            transition: all var(--transition-speed) ease;
            padding-bottom: 5px; 
            margin-right: 1rem;
        }
        
        .task-controls {
            display: flex;
            gap: 0.5rem;
            margin-left: auto; /* Push all controls to the right */
            align-items: center;
        }

        .task-item .task-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .streak-counter {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 700;
            margin-right: 1rem;
            color: var(--accent-orange);
        }

        .streak-counter svg {
            width: 20px;
            height: 20px;
        }
        
        /* NEW: Weekly Goal Tag Styling */
        .weekly-goal-tag {
            background-color: var(--accent);
            color: var(--text-on-accent);
            font-weight: 700;
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            border: var(--border-width) solid var(--border);
            box-shadow: 4px 4px 0 var(--shadow);
            flex-shrink: 0; /* Prevent from shrinking */
        }

        /*
        ==========================================================================
        TIMER CLOCK BUTTON
        ==========================================================================
        */
        .timer-clock-btn {
            position: relative;
        }

        .timer-clock-btn .progress-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px; /* Slightly larger than icon */
            height: 32px;
        }

        .timer-clock-btn .progress-ring-circle {
            transition: stroke-dashoffset 0.5s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            stroke: var(--accent);
            stroke-width: 3;
            fill: transparent;
        }
        
        /*
        ==========================================================================
        BUTTONS & CONTROLS
        ==========================================================================
        */
        .btn {
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            --shadow-color: var(--accent); /* Buttons get accent colored shadows */
            box-shadow: 4px 4px 0 var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }
        
        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--shadow-color);
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--shadow-color);
        }
        
        #settings-btn {
            background-color: var(--surface);
             --shadow-color: var(--shadow);
        }


        .btn.icon-btn {
            padding: 0.5rem;
            aspect-ratio: 1 / 1;
        }
        
        .btn.icon-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--text);
            stroke-width: var(--border-width);
            transition: transform 0.2s ease;
        }
        
        .btn.icon-btn:hover svg:not(.progress-ring) {
            transform: scale(1.1) rotate(5deg);
        }
        
        .complete-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: var(--border-width) solid var(--border);
            cursor: pointer;
            flex-shrink: 0;
            margin-right: 1rem;
            transition: all var(--transition-speed) ease;
            position: relative;
            background-color: var(--surface);
        }
        
        .complete-btn:hover {
            transform: scale(1.1);
        }
        
        .complete-btn.checked {
            background-color: var(--accent);
            border-color: var(--accent);
        }
        
        .complete-btn.checked::after {
            content: 'âœ”';
            color: var(--text-on-accent);
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .task-item.daily-completed .complete-btn {
            pointer-events: none;
        }
        
        /*
        ==========================================================================
        MODALS & PANELS (ADD TASK, SETTINGS)
        ==========================================================================
        */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease, visibility 0s var(--transition-speed);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }
        
        .modal-content {
            background-color: var(--bg);
            border: var(--border-width) solid var(--border);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            border-radius: var(--radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9) rotate(-3deg);
            transition: transform var(--transition-speed) cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        #account-modal .modal-content {
            max-width: 400px;
            padding: 1.5rem;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1) rotate(0deg);
        }
        
        .modal-content h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-weight: 900;
        }
        
        #new-task-input, #new-group-input, .form-group input, #new-task-weekly-goal {
            width: 100%;
            font-family: var(--font-main);
            font-size: 1.1rem;
            padding: 1rem;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            background: var(--surface);
            color: var(--text);
        }
        .form-group {
             margin-bottom: 1rem;
        }

        #new-task-input:focus, #new-group-input:focus, .form-group input:focus, #new-task-weekly-goal:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 var(--border-width) var(--accent);
        }
        
        #weekly-goal-container {
            margin-top: 1rem;
            border-top: var(--border-width) dashed var(--border);
            padding-top: 1rem;
        }
        
        #weekly-goal-container label {
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: block;
        }


        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-submit-btn {
            background-color: var(--accent);
            color: var(--text-on-accent);
            --shadow-color: var(--shadow);
        }
        
        .settings-group {
            margin-bottom: 2rem;
        }
        .settings-group h3 {
            margin-bottom: 1rem;
            font-weight: 700;
        }
        
        .settings-group .data-actions,
        .settings-group .account-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .theme-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .color-options {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            background-color: rgba(0,0,0,0.04);
            padding: 0.75rem;
            border-radius: var(--radius);
            border: var(--border-width) solid var(--border);
        }

        .dark-mode .color-options {
            background-color: rgba(255,255,255,0.04);
        }
        
        .theme-btn {
            gap: 0.5rem;
            --shadow-color: var(--shadow); /* Use normal shadow color */
        }
        .theme-btn svg {
             width: 20px;
             height: 20px;
             stroke-width: var(--border-width);
        }

        .theme-btn.selected {
            background-color: var(--accent);
            color: var(--text-on-accent);
        }
        .theme-btn.selected svg {
            stroke: var(--text-on-accent);
        }
        
        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: var(--border-width) solid var(--border);
            cursor: pointer;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            box-shadow: 0 0 0 var(--border-width) var(--border);
            transform: scale(1.1);
        }
        
        /* Volume and Timer Slider Styles */
        .volume-slider-container, .timer-slider-container {
            padding-top: 0.5rem;
        }
        .timer-slider-container {
            margin-bottom: 1.5rem;
        }
        .timer-slider-container label {
            font-weight: 700;
            margin-bottom: 0.75rem;
            display: block;
        }
        #timer-duration-display {
            background: var(--surface);
            padding: 0.25rem 0.5rem;
            border-radius: calc(var(--radius) / 2);
            border: var(--border-width) solid var(--border);
        }

        .timer-unit-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .timer-unit-btn {
            --shadow-color: var(--shadow);
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        .timer-unit-btn.selected {
            background-color: var(--accent);
            color: var(--text-on-accent);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: 50%;
            margin-top: -5px; /* Vertically center thumb for new track height */
            box-shadow: 4px 4px 0 var(--shadow);
            transition: all var(--transition-speed) ease;
        }
        input[type="range"]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: 50%;
            box-shadow: 4px 4px 0 var(--shadow);
            transition: all var(--transition-speed) ease;
        }
        input[type="range"]:active::-webkit-slider-thumb {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--shadow);
        }
        input[type="range"]:active::-moz-range-thumb {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--shadow);
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 16px;
            background: var(--accent);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
        }
        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 16px;
            background: var(--accent);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
        }
        
        /* Account Modal Specific Styles */
        .form-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .toggle-btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            background-color: var(--surface);
            border: none;
            color: var(--text);
            transition: all var(--transition-speed) ease;
        }
        .toggle-btn.active {
            background-color: var(--accent);
            color: var(--text-on-accent);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .form-divider {
            text-align: center;
            margin: 1.5rem 0;
            font-weight: 700;
            color: var(--text);
            opacity: 0.7;
        }
        
        .google-btn-custom {
            background-color: #4285F4;
            color: white;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: 4px 4px 0 var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
        }
        .google-btn-custom:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--shadow);
        }
        .google-btn-custom:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--shadow);
        }
        .dark-mode .google-btn-custom {
            border-color: var(--border-dark);
            box-shadow: 4px 4px 0 var(--shadow-dark);
        }
        .dark-mode .google-btn-custom:hover {
            box-shadow: 6px 6px 0 var(--shadow-dark);
        }
        .dark-mode .google-btn-custom:active {
            box-shadow: 2px 2px 0 var(--shadow-dark);
        }
        .google-btn-custom svg {
            width: 20px;
            height: 20px;
        }
        
        .error-message {
            color: var(--accent-red-light);
            font-weight: 700;
            text-align: center;
            margin-top: 1rem;
            min-height: 1.2em;
            padding: 0 0.5rem;
            line-height: 1.4;
        }
        
        /*
        ==========================================================================
        CONFETTI & CELEBRATIONS
        ==========================================================================
        */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            animation: confetti-fall 2s ease-out forwards;
        }
        
        .party-time-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            background: linear-gradient(-45deg, var(--accent-pink), var(--accent-blue), var(--accent-green), var(--accent-purple));
            background-size: 400% 400%;
            animation: party-bg 3s ease infinite, fade-out-party 1s 4s forwards;
            opacity: 0.3;
        }

        @keyframes party-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes fade-out-party {
            to { opacity: 0; }
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(150px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /*
        ==========================================================================
        ANIMATIONS
        ==========================================================================
        */
        @keyframes grain {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -10%); }
            20% { transform: translate(-15%, 5%); }
            30% { transform: translate(7%, -25%); }
            40% { transform: translate(-5%, 25%); }
            50% { transform: translate(-15%, 10%); }
            60% { transform: translate(15%, 0%); }
            70% { transform: translate(0%, 15%); }
            80% { transform: translate(3%, 35%); }
            90% { transform: translate(-10%, 10%); }
        }
        
        @keyframes shake { /* Overdue shake */
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }
        @keyframes shake-light { /* Dragging shake */
             0% { transform: rotate(0deg); }
             25% { transform: rotate(0.5deg); }
             50% { transform: rotate(0eg); }
             75% { transform: rotate(-0.5deg); }
             100% { transform: rotate(0deg); }
        }

        @keyframes levelUpPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(-5deg); box-shadow: 0 0 25px var(--accent); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
                max-height: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 100px; /* Base height */
                margin-bottom: 1.5rem;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
                max-height: 100px;
            }
            to {
                opacity: 0;
                transform: translateX(20px);
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-bottom: 0;
            }
        }
        
        @keyframes celebrate {
            0% { transform: scale(1); }
            20% { transform: scale(1.05) rotate(2deg); background-color: var(--accent); box-shadow: 0 0 20px var(--accent); }
            40% { transform: scale(0.95) rotate(-2deg); }
            60% { transform: scale(1.02); }
            100% {
                transform: translateX(100px) scale(0.5);
                opacity: 0;
                max-height: 0;
                padding: 0;
                margin-bottom: 0;
                border-width: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Initial Loader -->
    <div id="loader-overlay">
        <div class="loader-box"></div>
    </div>

    <!-- Landing Page for first-time users (hidden by default) -->
    <div id="landing-page" style="display: none;">
        <div class="landing-container">
            <!-- Initial choices -->
            <div id="landing-choices">
                <h1 class="main-title" style="margin-bottom: 2rem;">Procrasti-Nope</h1>
                <div class="landing-buttons">
                    <button id="landing-login-btn" class="btn">Login / Sign Up</button>
                    <button id="landing-guest-btn" class="btn">Continue as Guest</button>
                </div>
            </div>
            <!-- Auth form container -->
            <div id="landing-auth-container" style="display: none;">
                <!-- Content is dynamically filled from the #account-modal-content template -->
            </div>
        </div>
    </div>


    <div id="app-wrapper" style="display: none;">
        <header class="sticky-header">
            <div class="header-content">
                <h1 class="main-title">Procrasti-Nope</h1>
                <p class="quote" id="quote-of-the-day">Loading a dose of motivation...</p>
            </div>
            <div class="header-controls">
                <button id="settings-btn" class="btn icon-btn" aria-label="Open Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <section class="player-progress-section">
            <div class="level-display">LVL <span id="player-level">1</span></div>
            <div class="xp-bar-container">
                <div id="xp-bar" class="xp-bar"></div>
                <span id="xp-text">0 / 100 XP</span>
            </div>
        </section>

        <main class="container">
            <div class="quests-layout">
                <section class="task-group">
                    <header class="task-group-header">
                        <h2>Daily Quests</h2>
                        <button class="btn add-task-trigger-btn" data-list="daily" aria-label="Add Daily Quest">+</button>
                    </header>
                    <ul id="daily-task-list"></ul>
                    <div id="no-daily-tasks-message" style="display: none; text-align: center; padding: 2rem; opacity: 0.7;">
                        <p>No daily quests yet. Add one to start your day!</p>
                    </div>
                </section>

                <section class="task-group">
                    <header class="task-group-header">
                        <h2>Main Quests</h2>
                        <div class="header-actions">
                            <button id="add-standalone-task-btn" class="btn" aria-label="Add Quest">Add Quest</button>
                            <button id="add-group-btn" class="btn" aria-label="Add Group">Add Group</button>
                        </div>
                    </header>
                    <ul id="standalone-task-list"></ul>
                    <div id="general-task-list-container"></div>
                    <div id="no-general-tasks-message" style="display: none; text-align: center; padding: 2rem; opacity: 0.7;">
                        <p>No main quests on your list. Create a group or add a quest to get started!</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="add-task-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="add-task-modal-title">Add New Task</h2>
            <form id="add-task-form">
                <input type="text" id="new-task-input" placeholder="e.g., Conquer the world..." required>
                <div id="weekly-goal-container" style="display: none;">
                    <label for="new-task-weekly-goal">Set a Weekly Goal (Optional)</label>
                    <input type="number" id="new-task-weekly-goal" placeholder="e.g., 5 times a week" min="1">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="add-task-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Add</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-group-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Create New Group</h2>
            <form id="add-group-form">
                <input type="text" id="new-group-input" placeholder="e.g., Project Overlord" required>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="add-group-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="timer-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Set Task Timer</h2>
            <form id="timer-form">
                <div class="timer-slider-container">
                    <label for="timer-duration-slider">Duration: <span id="timer-duration-display">25</span></label>
                    <input type="range" id="timer-duration-slider" min="1" max="100" value="25">
                </div>
                <div class="timer-unit-selector">
                    <button type="button" class="btn timer-unit-btn" data-unit="seconds">Seconds</button>
                    <button type="button" class="btn timer-unit-btn selected" data-unit="minutes">Minutes</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="hours">Hours</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="days">Days</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="weeks">Weeks</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="months">Months</button>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="timer-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Start Timer</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Settings</h2>
            <div class="settings-group">
                <h3>Account</h3>
                <div class="account-actions">
                    <span id="user-display" style="display: none; align-items:center;"></span>
                    <button id="settings-login-btn" class="btn">Login / Sign Up</button>
                    <button id="logout-btn" class="btn" style="display: none;">Logout</button>
                </div>
            </div>
            <div class="settings-group">
                <h3>Theme</h3>
                <div class="theme-options" id="theme-options-buttons">
                    <button class="btn theme-btn" data-theme="light" aria-label="Light Theme"><svg class="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span>Light</span></button>
                    <button class="btn theme-btn" data-theme="dark" aria-label="Dark Theme"><svg class="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><span>Dark</span></button>
                    <button class="btn theme-btn" data-theme="system" aria-label="System Theme"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg><span>System</span></button>
                </div>
            </div>
            <div class="settings-group">
                <h3>Accent Color</h3>
                <div class="color-options" id="color-options">
                    <div class="color-swatch" data-color="var(--accent-red)" style="background-color: var(--accent-red);"></div><div class="color-swatch" data-color="var(--accent-orange)" style="background-color: var(--accent-orange);"></div><div class="color-swatch" data-color="var(--accent-amber)" style="background-color: var(--accent-amber);"></div><div class="color-swatch" data-color="var(--accent-yellow)" style="background-color: var(--accent-yellow);"></div><div class="color-swatch" data-color="var(--accent-lime)" style="background-color: var(--accent-lime);"></div><div class="color-swatch" data-color="var(--accent-green)" style="background-color: var(--accent-green);"></div><div class="color-swatch" data-color="var(--accent-teal)" style="background-color: var(--accent-teal);"></div><div class="color-swatch" data-color="var(--accent-cyan)" style="background-color: var(--accent-cyan);"></div><div class="color-swatch" data-color="var(--accent-blue)" style="background-color: var(--accent-blue);"></div><div class="color-swatch" data-color="var(--accent-indigo)" style="background-color: var(--accent-indigo);"></div><div class="color-swatch" data-color="var(--accent-purple)" style="background-color: var(--accent-purple);"></div><div class="color-swatch" data-color="var(--accent-pink)" style="background-color: var(--accent-pink);"></div>
                </div>
            </div>
            <div class="settings-group">
                <h3>Sound Volume</h3>
                <div class="volume-slider-container"><input type="range" id="volume-slider" min="0" max="1" step="0.01" aria-label="Volume"></div>
            </div>
             <div class="settings-group">
                <h3>Data (Local)</h3>
                <div class="data-actions">
                    <button id="export-data-btn" class="btn">Export Guest Data</button>
                    <button id="import-data-btn" class="btn">Import Guest Data</button>
                    <input type="file" id="import-file-input" style="display: none;" accept=".json">
                    <button id="reset-progress-btn" class="btn">Reset Progress</button>
                </div>
            </div>
            <div class="modal-actions"><button class="btn" data-close-modal="settings-modal">Close</button></div>
        </div>
    </div>
    
    <div id="account-modal" class="modal-overlay">
        <div class="modal-content"></div>
    </div>
    
    <div id="timer-menu-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;">
            <h2>Active Timer</h2><p style="margin-bottom: 1.5rem;">This quest has a timer running.</p>
            <div class="modal-actions" style="justify-content: space-around;">
                <button type="button" id="timer-menu-cancel-btn" class="btn">Cancel Timer</button>
                <button type="button" class="btn" data-close-modal="timer-menu-modal">Leave</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-title">Are you sure?</h2>
            <p id="confirm-text" style="margin-bottom: 1.5rem;">This action cannot be undone.</p>
            <div class="modal-actions">
                <button type="button" id="confirm-cancel-btn" class="btn">Cancel</button>
                <button type="submit" id="confirm-action-btn" class="btn modal-submit-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Template for Auth Forms -->
    <template id="account-modal-content">
        <div class="form-toggle">
            <button class="toggle-btn active" data-tab="signup">Sign Up</button>
            <button class="toggle-btn" data-tab="login">Login</button>
        </div>
        <form class="auth-form" data-form="signup">
            <div class="form-group"><label for="signup-email">Email</label><input type="email" class="signup-email" required></div>
            <div class="form-group"><label for="signup-password">Password</label><input type="password" class="signup-password" required></div>
            <button type="submit" class="btn modal-submit-btn" style="width: 100%;">Create Account</button>
            <p class="error-message signup-error"></p>
        </form>
        <form class="auth-form" data-form="login" style="display: none;">
             <div class="form-group"><label for="login-email">Email</label><input type="email" class="login-email" required></div>
             <div class="form-group"><label for="login-password">Password</label><input type="password" class="login-password" required></div>
             <button type="submit" class="btn modal-submit-btn" style="width: 100%;">Login</button>
             <p class="error-message login-error"></p>
             <div class="form-divider">OR</div>
             <div class="google-signin-btn-container"></div>
        </form>
    </template>

    <script type="module">
        // --- FIREBASE SETUP ---
        // IMPORTANT: Replace with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        let app, auth, db;
        let currentUser = null;
        let unsubscribeFromFirestore = null;
        let appInitialized = false;

        // --- DOM ELEMENTS FOR STARTUP ---
        const loaderOverlay = document.getElementById('loader-overlay');
        const landingPage = document.getElementById('landing-page');
        const appWrapper = document.getElementById('app-wrapper');
        const landingChoices = document.getElementById('landing-choices');
        const landingAuthContainer = document.getElementById('landing-auth-container');

        // --- Initialize Firebase and start the auth flow ---
        try {
            app = window.firebaseSDK.initializeApp(firebaseConfig);
            auth = window.firebaseSDK.getAuth(app);
            db = window.firebaseSDK.getFirestore(app);
            
            window.firebaseSDK.onAuthStateChanged(auth, user => {
                // This is the central function that reacts to login/logout
                if (unsubscribeFromFirestore) {
                    unsubscribeFromFirestore(); // Stop listening to old user's data
                    unsubscribeFromFirestore = null;
                }
                
                if (!user) { // User is logged out
                    appInitialized = false; // Allow re-initialization
                }

                currentUser = user;
                loaderOverlay.style.display = 'none';

                if (user || sessionStorage.getItem('isGuest')) {
                    landingPage.style.display = 'none';
                    appWrapper.style.display = 'block';
                    if (!appInitialized) { // Only start the app if it hasn't been initialized for this session
                        startTheApp(user);
                    }
                } else {
                    landingPage.style.display = 'flex';
                    appWrapper.style.display = 'none';
                    showLandingPage();
                }
            });
        } catch (err) {
            console.error("Firebase initialization failed:", err);
            loaderOverlay.innerHTML = '<p style="color: var(--text);">Error: Could not connect. Please check your Firebase config.</p>';
        }

        // --- LANDING PAGE / AUTH FLOW ---
        function showLandingPage() {
            landingAuthContainer.style.display = 'none';
            landingChoices.style.display = 'block';
        }

        function startTheApp(user) {
            appInitialized = true; // Mark as initialized for this session
            initializeAppLogic(user);
        }

        document.getElementById('landing-guest-btn').addEventListener('click', () => {
            sessionStorage.setItem('isGuest', 'true');
            // onAuthStateChanged will fire with a null user, but the guest check will pass and start the app
            window.firebaseSDK.onAuthStateChanged(auth, u => {}).apply();
        });

        document.getElementById('landing-login-btn').addEventListener('click', () => {
            showAuthFormsOnLanding('login');
        });

        function showAuthFormsOnLanding(initialTab) {
            landingChoices.style.display = 'none';
            landingAuthContainer.style.display = 'block';
            
            // This callback is triggered on successful authentication
            const onAuthSuccess = () => {
                 // onAuthStateChanged will automatically handle hiding the landing page and showing the app
            };
            
            setupAuthForms(landingAuthContainer, onAuthSuccess);
            
            landingAuthContainer.querySelector(`.toggle-btn[data-tab="${initialTab}"]`).click();
            
            // Add a back button if it doesn't exist
            if (!landingAuthContainer.querySelector('#landing-back-btn')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'landing-back-btn';
                backBtn.className = 'btn';
                backBtn.textContent = 'Back';
                backBtn.onclick = showLandingPage;
                landingAuthContainer.appendChild(backBtn);
            }
        }
        
        // --- MAIN APPLICATION LOGIC ---
        function initializeAppLogic(user) {
            // All app-specific variables and functions go here to keep them scoped
            let dailyTasks = [], standaloneMainQuests = [], generalTaskGroups = [];
            let playerData = { level: 1, xp: 0 };
            let settings = { theme: 'light', accentColor: 'var(--accent-red)', volume: 0.3 };
            let currentListToAdd = null, currentEditingTaskId = null;
            const activeTimers = {};
            
            const dailyTaskListContainer = document.getElementById('daily-task-list');
            const standaloneTaskListContainer = document.getElementById('standalone-task-list');
            const generalTaskListContainer = document.getElementById('general-task-list-container');
            const playerLevelEl = document.getElementById('player-level');
            const xpBarEl = document.getElementById('xp-bar');
            const xpTextEl = document.getElementById('xp-text');
            const levelDisplayEl = document.querySelector('.level-display');
            const addTaskTriggerBtnDaily = document.querySelector('.add-task-trigger-btn[data-list="daily"]');
            const addStandaloneTaskBtn = document.getElementById('add-standalone-task-btn');
            const addGroupBtn = document.getElementById('add-group-btn');
            const addTaskModal = document.getElementById('add-task-modal');
            const addTaskModalTitle = document.getElementById('add-task-modal-title');
            const addTaskForm = document.getElementById('add-task-form');
            const newTaskInput = document.getElementById('new-task-input');
            const weeklyGoalContainer = document.getElementById('weekly-goal-container');
            const weeklyGoalInput = document.getElementById('new-task-weekly-goal');
            const addGroupModal = document.getElementById('add-group-modal');
            const addGroupForm = document.getElementById('add-group-form');
            const newGroupInput = document.getElementById('new-group-input');
            const timerModal = document.getElementById('timer-modal');
            const timerForm = document.getElementById('timer-form');
            const timerDurationSlider = document.getElementById('timer-duration-slider');
            const timerDurationDisplay = document.getElementById('timer-duration-display');
            const timerUnitSelector = document.querySelector('.timer-unit-selector');
            const timerMenuModal = document.getElementById('timer-menu-modal');
            const timerMenuCancelBtn = document.getElementById('timer-menu-cancel-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const themeOptionsButtons = document.getElementById('theme-options-buttons');
            const colorOptions = document.getElementById('color-options');
            const volumeSlider = document.getElementById('volume-slider');
            const resetProgressBtn = document.getElementById('reset-progress-btn');
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');
            const settingsLoginBtn = document.getElementById('settings-login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');
            const accountModal = document.getElementById('account-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const confirmActionBtn = document.getElementById('confirm-action-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmText = document.getElementById('confirm-text');
            const noDailyTasksMessage = document.getElementById('no-daily-tasks-message');
            const noGeneralTasksMessage = document.getElementById('no-general-tasks-message');
            const quoteEl = document.getElementById('quote-of-the-day');
            const audioCtx = window.AudioContext ? new AudioContext() : null;
            let confirmCallback = null;

            async function saveData(data) {
                if (!user) { // Guest mode
                    localStorage.setItem('anonymousUserData', JSON.stringify(data));
                    return;
                }
                // Logged-in mode
                try {
                    const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                    await window.firebaseSDK.setDoc(userDocRef, { appData: data }, { merge: true });
                } catch (error) { console.error("Error saving data to Firestore: ", getCoolErrorMessage(error)); }
            }
            
            function loadAndDisplayData(data) {
                dailyTasks = data.dailyTasks || [];
                standaloneMainQuests = data.standaloneMainQuests || [];
                generalTaskGroups = data.generalTaskGroups || [];
                playerData = data.playerData || { level: 1, xp: 0 };
                settings = data.settings || { theme: 'light', accentColor: 'var(--accent-red)', volume: 0.3 };
                generalTaskGroups.forEach(group => {
                    if (typeof group.isExpanded === 'undefined') group.isExpanded = false;
                });
                renderAllLists();
                updateProgressUI();
                applySettings();
            }

            async function initialLoad() {
                if (!user) { // Guest mode
                    const localData = JSON.parse(localStorage.getItem('anonymousUserData')) || {};
                    loadAndDisplayData(localData);
                    return;
                }

                // Logged-in mode, setup real-time listener
                const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                unsubscribeFromFirestore = window.firebaseSDK.onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        loadAndDisplayData(docSnap.data().appData || {});
                    } else {
                        // This is a new user, load empty state
                        loadAndDisplayData({});
                    }
                }, (error) => { console.error("Error listening to Firestore:", getCoolErrorMessage(error)); });
            }

            function updateUserUI() {
                if (user) {
                    settingsLoginBtn.style.display = 'none';
                    logoutBtn.style.display = 'inline-flex';
                    userDisplay.textContent = `Logged in as: ${user.displayName || user.email}`;
                    userDisplay.style.display = 'flex';
                    exportDataBtn.disabled = true;
                    importDataBtn.disabled = true;
                } else { // Guest mode
                    settingsLoginBtn.style.display = 'inline-flex';
                    logoutBtn.style.display = 'none';
                    userDisplay.textContent = 'Playing as Guest';
                    userDisplay.style.display = 'flex';
                    exportDataBtn.disabled = false;
                    importDataBtn.disabled = false;
                }
            }
            const XP_PER_TASK = 35;
            const XP_PER_TIMER_MINUTE = 2;
            const getXpForNextLevel = (level) => 50 + (level * 50);
            const quotes = ["The secret of getting ahead is getting started.", "A year from now you may wish you had started today.", "The future depends on what you do today."];
            function showRandomQuote() { quoteEl.textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`; }
            function getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff)).setHours(0, 0, 0, 0);
            }
            const checkDailyReset = () => {
                const today = new Date().toDateString();
                const lastVisit = localStorage.getItem('lastVisitDate');
                if (today !== lastVisit) {
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    dailyTasks.forEach(task => {
                        if (task.completedToday && task.lastCompleted === yesterday) task.streak = (task.streak || 0) + 1;
                        else if (!task.completedToday) task.streak = 0;
                        task.completedToday = false;
                    });
                    localStorage.setItem('lastVisitDate', today);
                    saveState();
                }
            };
            function addXp(amount) {
                playerData.xp += Math.round(amount);
                if (playerData.xp < 0) playerData.xp = 0;
                const requiredXp = getXpForNextLevel(playerData.level);
                if (playerData.xp >= requiredXp) levelUp(requiredXp);
                updateProgressUI();
            }
            function levelUp(requiredXp) {
                playerData.level++;
                playerData.xp -= requiredXp;
                playSound('levelUp');
                levelDisplayEl.classList.add('level-up');
                levelDisplayEl.addEventListener('animationend', () => levelDisplayEl.classList.remove('level-up'), { once: true });
                const newRequiredXp = getXpForNextLevel(playerData.level);
                if (playerData.xp >= newRequiredXp) levelUp(newRequiredXp);
            }
            function updateProgressUI() {
                const requiredXp = getXpForNextLevel(playerData.level);
                const progressPercent = Math.min((playerData.xp / requiredXp) * 100, 100);
                playerLevelEl.textContent = playerData.level;
                xpTextEl.textContent = `${Math.floor(playerData.xp)} / ${requiredXp} XP`;
                xpBarEl.style.width = `${progressPercent}%`;
            }
            function checkOverdueTasks() {
                const now = Date.now();
                [...dailyTasks, ...standaloneMainQuests, ...generalTaskGroups.flatMap(g => g.tasks)].forEach(task => {
                    const taskEl = document.querySelector(`.task-item[data-id="${task.id}"]`);
                    if (!taskEl || task.completedToday) return;
                    taskEl.classList.toggle('overdue', (now - task.createdAt) > 86400000);
                });
            }
            function checkAllTasksCompleted() {
                const allDailiesDone = dailyTasks.length > 0 && dailyTasks.every(t => t.completedToday);
                const noStandaloneQuests = standaloneMainQuests.length === 0;
                const noGroupedQuests = generalTaskGroups.every(g => !g.tasks || g.tasks.length === 0);
                return { allDailiesDone, allTasksDone: allDailiesDone && noStandaloneQuests && noGroupedQuests };
            }
            function playSound(type) {
                if (!audioCtx || settings.volume === 0) return;
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                let v = settings.volume, d = 0.2;
                switch (type) {
                    case 'complete': o.type = 'sine'; o.frequency.setValueAtTime(440, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.2); break;
                    case 'levelUp': o.type = 'sawtooth'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.4); d = 0.4; v *= 1.2; break;
                    case 'add': case 'addGroup': o.type = 'triangle'; o.frequency.setValueAtTime(300, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1); d = 0.15; break;
                    case 'delete': o.type = 'square'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); break;
                    case 'hover': o.type = 'sine'; o.frequency.setValueAtTime(800, audioCtx.currentTime); v *= 0.2; d = 0.05; break;
                    case 'toggle': o.type = 'sawtooth'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(400, audioCtx.currentTime + 0.1); d = 0.1; break;
                    case 'open': o.type = 'triangle'; o.frequency.setValueAtTime(250, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(500, audioCtx.currentTime + 0.1); break;
                    case 'close': o.type = 'triangle'; o.frequency.setValueAtTime(500, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(250, audioCtx.currentTime + 0.1); break;
                }
                g.gain.setValueAtTime(0, audioCtx.currentTime); g.gain.linearRampToValueAtTime(v, audioCtx.currentTime + 0.01);
                o.start(audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d);
            }
            const renderDailyTasks = () => { dailyTaskListContainer.innerHTML = ''; noDailyTasksMessage.style.display = dailyTasks.length === 0 ? 'block' : 'none'; dailyTasks.forEach(task => dailyTaskListContainer.appendChild(createTaskElement(task, 'daily'))); };
            const renderStandaloneTasks = () => { standaloneTaskListContainer.innerHTML = ''; standaloneMainQuests.forEach(task => standaloneTaskListContainer.appendChild(createTaskElement(task, 'standalone'))); };
            const renderGeneralTasks = () => { generalTaskListContainer.innerHTML = ''; generalTaskGroups.forEach(group => generalTaskListContainer.appendChild(createGroupElement(group))); noGeneralTasksMessage.style.display = (standaloneMainQuests.length === 0 && generalTaskGroups.length === 0) ? 'block' : 'none'; };
            const createGroupElement = (group) => {
                const el = document.createElement('div'); el.className = 'main-quest-group'; if (group.isExpanded) el.classList.add('expanded'); el.dataset.groupId = group.id;
                el.innerHTML = `<header class="main-quest-group-header"><div class="group-title-container"><svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24"><path d="M10 8L16 12L10 16V8Z" fill="var(--text)"/></svg><h3>${group.name}</h3></div><div class="group-actions"><button class="btn icon-btn delete-group-btn" aria-label="Delete group"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button><button class="btn add-task-to-group-btn" aria-label="Add task">+</button></div></header><ul class="task-list-group" data-group-id="${group.id}"></ul>`;
                const ul = el.querySelector('ul'); if (group.tasks) group.tasks.forEach(task => ul.appendChild(createTaskElement(task, 'group'))); return el;
            };
            const createTaskElement = (task, type) => {
                const li = document.createElement('li'); li.className = 'task-item'; li.dataset.id = task.id; if (type === 'standalone') li.classList.add('standalone-quest');
                let streakHTML = ''; if (type === 'daily' && task.streak > 0) streakHTML = `<div class="streak-counter" title="Streak: ${task.streak}"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.653 9.473c.071.321.11.65.11.986 0 2.21-1.791 4-4 4s-4-1.79-4-4c0-.336.039-.665.11-.986C7.333 11.23 6 14.331 6 18h12c0-3.669-1.333-6.77-3.347-8.527zM12 2C9.239 2 7 4.239 7 7c0 .961.261 1.861.713 2.638C9.223 8.36 10.55 7.5 12 7.5s2.777.86 4.287 2.138C17 8.861 17 7.961 17 7c0-2.761-2.239-5-5-5z"/></svg><span>${task.streak}</span></div>`;
                let goalHTML = ''; if (type === 'daily' && task.weeklyGoal > 0) { goalHTML = `<div class="weekly-goal-tag" title="Weekly goal"><span>${task.weeklyCompletions}/${task.weeklyGoal}</span></div>`; if (task.weeklyCompletions >= task.weeklyGoal) li.classList.add('weekly-goal-met'); }
                li.innerHTML = `<button class="complete-btn"></button><div class="task-content">${streakHTML}<span class="task-text" contenteditable="false">${task.text}</span>${goalHTML}</div><div class="task-controls"><button class="btn icon-btn timer-clock-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><svg class="progress-ring" viewBox="0 0 24 24"><circle class="progress-ring-circle" r="10" cx="12" cy="12"/></svg></button><div class="task-actions"><button class="btn icon-btn edit-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button><button class="btn icon-btn delete-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button></div></div>`;
                if (task.completedToday) { li.classList.add('daily-completed'); li.querySelector('.complete-btn').classList.add('checked'); }
                if (task.timerStartTime && task.timerRemaining > 0) { const ring = li.querySelector('.progress-ring-circle'); if (ring) { const r = ring.r.baseVal.value, c = r * 2 * Math.PI; ring.style.strokeDasharray = `${c} ${c}`; const p = task.timerRemaining / task.timerDuration; ring.style.strokeDashoffset = c - p * c; } }
                else { const ring = li.querySelector('.progress-ring-circle'); if (ring) ring.style.strokeDasharray = '0, 999'; }
                return li;
            };
            const saveState = () => { const data = { dailyTasks, standaloneMainQuests, generalTaskGroups, playerData, settings }; saveData(data); };
            const addTask = (text, list, goal) => {
                const common = { id: Date.now().toString(), text, createdAt: Date.now() };
                if (list === 'daily') dailyTasks.push({ ...common, completedToday: false, lastCompleted: null, streak: 0, weeklyGoal: goal || 0, weeklyCompletions: 0, weekStartDate: getStartOfWeek(new Date()) });
                else if (list === 'standalone') standaloneMainQuests.push({ ...common });
                else { const g = generalTaskGroups.find(g => g.id === list); if (g) { if (!g.tasks) g.tasks = []; g.tasks.push({ ...common }); } }
                renderAllLists(); // Re-render immediately for snappy UI
                saveState(); 
                playSound('add');
            };
            const addGroup = (name) => { 
                generalTaskGroups.push({ id: 'group_' + Date.now(), name, tasks: [], isExpanded: false }); 
                renderAllLists(); // Re-render immediately
                saveState(); 
                playSound('addGroup'); 
            };
            const deleteGroup = (id) => { const name = generalTaskGroups.find(g => g.id === id)?.name || 'this group'; showConfirm(`Delete "${name}"?`, 'All tasks will be deleted.', () => { generalTaskGroups = generalTaskGroups.filter(g => g.id !== id); renderAllLists(); saveState(); playSound('delete'); }); };
            const findTaskAndContext = (id) => {
                let task = dailyTasks.find(t => t && t.id === id); if (task) return { task, list: dailyTasks, type: 'daily' };
                task = standaloneMainQuests.find(t => t && t.id === id); if(task) return { task, list: standaloneMainQuests, type: 'standalone'};
                for (const g of generalTaskGroups) { if (g && g.tasks) { const i = g.tasks.findIndex(t => t && t.id === id); if (i !== -1) return { task: g.tasks[i], list: g.tasks, group: g, type: 'group' }; } } return {};
            };
            const deleteTask = (id) => { stopTimer(id); const { list } = findTaskAndContext(id); if (list) { const i = list.findIndex(t => t.id === id); if(i > -1) list.splice(i, 1); } renderAllLists(); saveState(); playSound('delete'); };
            const completeTask = (id) => {
                stopTimer(id); const { task, type } = findTaskAndContext(id); if (!task) return;
                addXp(XP_PER_TASK); playSound('complete');
                if (type === 'daily') {
                    if(task.completedToday) return; task.completedToday = true; task.lastCompleted = new Date().toDateString();
                    if (task.weeklyGoal > 0) { const now = new Date(); if (task.weekStartDate < getStartOfWeek(now)) { task.weekStartDate = getStartOfWeek(now); task.weeklyCompletions = 1; } else { task.weeklyCompletions = (task.weeklyCompletions || 0) + 1; } }
                } else {
                    createConfetti(document.querySelector(`.task-item[data-id="${id}"]`));
                    const { list, group } = findTaskAndContext(id); if (list) { const i = list.findIndex(t => t.id === id); if (i > -1) list.splice(i, 1); }
                    if (group && (!group.tasks || group.tasks.length === 0)) { const i = generalTaskGroups.findIndex(g => g.id === group.id); if(i > -1) generalTaskGroups.splice(i, 1); }
                }
                saveState(); // Save state first
                renderAllLists(); // Then re-render to reflect changes
                const { allDailiesDone, allTasksDone } = checkAllTasksCompleted(); if (allTasksDone) createFullScreenConfetti(true); else if (allDailiesDone) createFullScreenConfetti(false);
            };
            const uncompleteDailyTask = (id) => { const task = dailyTasks.find(t => t.id === id); if (task && task.completedToday) { task.completedToday = false; if (task.weeklyGoal > 0 && task.lastCompleted === new Date().toDateString()) task.weeklyCompletions = Math.max(0, (task.weeklyCompletions || 0) - 1); addXp(-XP_PER_TASK); playSound('delete'); saveState(); renderAllLists(); } };
            const editTask = (id, text) => { const { task } = findTaskAndContext(id); if (task) { task.text = text; saveState(); } };
            function startTimer(id, mins) { const { task } = findTaskAndContext(id); if (!task) return; stopTimer(id); task.timerDuration = mins * 60; task.timerRemaining = task.timerDuration; task.timerStartTime = Date.now(); activeTimers[id] = setInterval(() => { task.timerRemaining = Math.max(0, task.timerDuration - ((Date.now() - task.timerStartTime) / 1000)); if (task.timerRemaining <= 0) { playSound('levelUp'); addXp(mins * XP_PER_TIMER_MINUTE); completeTask(id); } saveState(); renderAllLists(); }, 1000); saveState(); renderAllLists(); }
            function stopTimer(id) { if (activeTimers[id]) { clearInterval(activeTimers[id]); delete activeTimers[id]; const { task } = findTaskAndContext(id); if (task) { delete task.timerDuration; delete task.timerRemaining; delete task.timerStartTime; saveState(); renderAllLists(); } } }
            function resumeTimers() { [...dailyTasks, ...standaloneMainQuests, ...generalTaskGroups.flatMap(g => g.tasks)].forEach(t => { if(t && t.timerStartTime && t.timerDuration) { const r = t.timerDuration - ((Date.now() - t.timerStartTime) / 1000); if (r > 0) { t.timerRemaining = r; startTimer(t.id, t.timerRemaining / 60); } else { addXp(t.timerDuration / 60 * XP_PER_TIMER_MINUTE); stopTimer(t.id); completeTask(t.id); } } }); }
            document.querySelector('.quests-layout').addEventListener('click', (e) => {
                const taskItem = e.target.closest('.task-item'), groupHeader = e.target.closest('.main-quest-group-header');
                if (groupHeader) { const groupId = e.target.closest('.main-quest-group').dataset.groupId; if (e.target.closest('.add-task-to-group-btn')) { currentListToAdd = groupId; weeklyGoalContainer.style.display = 'none'; addTaskModalTitle.textContent = `Add to "${generalTaskGroups.find(g=>g.id===groupId).name}"`; openModal(addTaskModal); newTaskInput.focus(); } else if (e.target.closest('.delete-group-btn')) deleteGroup(groupId); else { const g = generalTaskGroups.find(g => g.id === groupId); if (g) g.isExpanded = !g.isExpanded; saveState(); renderAllLists(); } return; }
                if (taskItem) { const id = taskItem.dataset.id; currentEditingTaskId = id; if (taskItem.classList.contains('daily-completed')) { uncompleteDailyTask(id); return; } if (e.target.closest('.complete-btn')) completeTask(id); else if (e.target.closest('.delete-btn')) deleteTask(id); else if (e.target.closest('.timer-clock-btn')) { const { task } = findTaskAndContext(id); if (task && task.timerStartTime) openModal(timerMenuModal); else openModal(timerModal); } else if (e.target.closest('.edit-btn')) { const t = taskItem.querySelector('.task-text'); t.contentEditable = true; t.style.borderBottom = `2px solid ${settings.accentColor}`; t.focus(); document.execCommand('selectAll', false, null); } } 
            });
            document.querySelector('.quests-layout').addEventListener('focusout', (e) => { if (e.target.classList.contains('task-text') && e.target.isContentEditable) { const id = e.target.closest('.task-item').dataset.id; e.target.contentEditable = false; e.target.style.borderBottom = "none"; editTask(id, e.target.textContent); } });
            document.querySelector('.quests-layout').addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.target.isContentEditable) { e.preventDefault(); e.target.blur(); } });
            addTaskForm.addEventListener('submit', (e) => { e.preventDefault(); const t = newTaskInput.value.trim(); if (t && currentListToAdd) { addTask(t, currentListToAdd, parseInt(weeklyGoalInput.value, 10) || 0); newTaskInput.value = ''; weeklyGoalInput.value = ''; closeModal(addTaskModal); } });
            timerForm.addEventListener('submit', (e) => { e.preventDefault(); const v = parseInt(timerDurationSlider.value,10), u = timerUnitSelector.querySelector('.selected').dataset.unit; let m = 0; switch(u){ case 'seconds': m=v/60; break; case 'minutes': m=v; break; case 'hours': m=v*60; break; case 'days': m=v*1440; break; case 'weeks': m=v*10080; break; case 'months': m=v*43200; break; } if(m>0&&currentEditingTaskId){startTimer(currentEditingTaskId,m);closeModal(timerModal);currentEditingTaskId=null;} });
            timerMenuCancelBtn.addEventListener('click', () => { if (currentEditingTaskId) stopTimer(currentEditingTaskId); closeModal(timerMenuModal); });
            timerDurationSlider.addEventListener('input', () => timerDurationDisplay.textContent = timerDurationSlider.value);
            timerUnitSelector.addEventListener('click', (e) => { const t = e.target.closest('.timer-unit-btn'); if (t) { timerUnitSelector.querySelector('.selected').classList.remove('selected'); t.classList.add('selected'); playSound('toggle'); } });
            addGroupForm.addEventListener('submit', (e) => { e.preventDefault(); const n = newGroupInput.value.trim(); if (n) { addGroup(n); newGroupInput.value = ''; closeModal(addGroupModal); } });
            const openModal = (modal) => { appWrapper.classList.add('blur-background'); modal.classList.add('visible'); playSound('open'); };
            const closeModal = (modal) => { appWrapper.classList.remove('blur-background'); modal.classList.remove('visible'); playSound('close'); };
            addTaskTriggerBtnDaily.addEventListener('click', () => { currentListToAdd = 'daily'; weeklyGoalContainer.style.display = 'block'; addTaskModalTitle.textContent = 'Add Daily Quest'; openModal(addTaskModal); newTaskInput.focus(); });
            addStandaloneTaskBtn.addEventListener('click', () => { currentListToAdd = 'standalone'; weeklyGoalContainer.style.display = 'none'; addTaskModalTitle.textContent = 'Add Main Quest'; openModal(addTaskModal); newTaskInput.focus(); });
            addGroupBtn.addEventListener('click', () => { openModal(addGroupModal); newGroupInput.focus(); });
            settingsBtn.addEventListener('click', () => openModal(settingsModal));
            document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => closeModal(document.getElementById(btn.dataset.closeModal))));
            [addTaskModal, addGroupModal, settingsModal, confirmModal, timerModal, accountModal, timerMenuModal].forEach(m => { if (m) m.addEventListener('click', (e) => { if (e.target === m) closeModal(m); }); });
            function showConfirm(title, text, cb) { confirmTitle.textContent = title; confirmText.textContent = text; confirmCallback = cb; openModal(confirmModal); }
            confirmActionBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeModal(confirmModal); });
            confirmCancelBtn.addEventListener('click', () => closeModal(confirmModal));
            const applySettings = () => { document.documentElement.style.setProperty('--accent', settings.accentColor); document.querySelectorAll('.color-swatch').forEach(s => s.classList.toggle('selected', s.dataset.color === settings.accentColor)); if(typeof settings.volume==='undefined') settings.volume=0.3; volumeSlider.value = settings.volume; const d = window.matchMedia('(prefers-color-scheme: dark)').matches; document.documentElement.classList.toggle('dark-mode', settings.theme === 'dark' || (settings.theme === 'system' && d)); document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected')); const s = document.querySelector(`.theme-btn[data-theme="${settings.theme}"]`); if(s)s.classList.add('selected'); };
            themeOptionsButtons.addEventListener('click', (e) => { const t = e.target.closest('.theme-btn'); if (t) { settings.theme = t.dataset.theme; saveState(); applySettings(); playSound('toggle'); } });
            colorOptions.addEventListener('click', (e) => { if(e.target.classList.contains('color-swatch')) { settings.accentColor = e.target.dataset.color; saveState(); applySettings(); } });
            volumeSlider.addEventListener('input', () => { settings.volume = parseFloat(volumeSlider.value); saveState(); });
            volumeSlider.addEventListener('change', () => playSound('toggle'));
            resetProgressBtn.addEventListener('click', () => showConfirm('Reset all progress?', 'This cannot be undone.', () => { playerData = { level: 1, xp: 0 }; dailyTasks = []; standaloneMainQuests = []; generalTaskGroups = []; renderAllLists(); saveState(); playSound('delete'); }));
            exportDataBtn.addEventListener('click', () => { const d = localStorage.getItem('anonymousUserData'); const b = new Blob([d || '{}'], {type: "application/json"}), a = document.createElement("a"); a.href = URL.createObjectURL(b); a.download = `procrasti-nope_guest_backup.json`; a.click(); });
            importDataBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => { const f = e.target.files[0]; if(!f) return; showConfirm("Import Guest Data?", "This will overwrite current guest data.", () => { const r = new FileReader(); r.onload = (e) => { localStorage.setItem('anonymousUserData', e.target.result); initialLoad(); }; r.readAsText(f); }); e.target.value = ''; });
            document.body.addEventListener('mouseover', e => { const t = e.target.closest('.btn, .color-swatch, .complete-btn, .main-title'); if (!t || (e.relatedTarget && t.contains(e.relatedTarget))) return; playSound('hover'); });
            function initSortable() { const o = { animation: 150, group: 'tasks', onStart: () => document.body.classList.add('is-dragging'), onEnd: (e) => { document.body.classList.remove('is-dragging'); if (e.from !== e.to || e.oldIndex !== e.newIndex) { console.log("Reordering list..."); } } }; new Sortable(dailyTaskListContainer,{...o, onEnd:(e)=>{document.body.classList.remove('is-dragging');reorderList(dailyTasks,e.oldIndex,e.newIndex);}}); new Sortable(standaloneTaskListContainer,{...o, onEnd:(e)=>{document.body.classList.remove('is-dragging');reorderList(standaloneMainQuests,e.oldIndex,e.newIndex);}}); new Sortable(generalTaskListContainer,{animation:150,handle:'.main-quest-group-header',onStart:()=>document.body.classList.add('is-dragging'),onEnd:(e)=>{document.body.classList.remove('is-dragging');reorderList(generalTaskGroups,e.oldIndex,e.newIndex)}}); document.querySelectorAll('.task-list-group').forEach(l=>{new Sortable(l,{...o,onEnd:(e)=>{document.body.classList.remove('is-dragging');const id=e.to.dataset.groupId,g=generalTaskGroups.find(g=>g.id===id);if(g)reorderList(g.tasks,e.oldIndex,e.newIndex);}});}); }
            function reorderList(list, oldI, newI) { if (oldI === newI) return; const [item] = list.splice(oldI, 1); list.splice(newI, 0, item); saveState(); }
            function createConfetti(el) { if(!el) return; const r = el.getBoundingClientRect(); createFullScreenConfetti(false, { x: r.left + r.width / 2, y: r.top + r.height / 2 }); }
            function createFullScreenConfetti(party, o = null) {
                for (let i = 0; i < (party ? 200 : 100); i++) {
                    const c = document.createElement('div'); c.className = 'confetti';
                    const sx = o ? o.x : Math.random()*window.innerWidth, sy = o ? o.y : -20;
                    c.style.left=`${sx}px`; c.style.top=`${sy}px`; c.style.backgroundColor = ['var(--accent-pink)','var(--accent-blue)','var(--accent-green)','var(--accent-orange)','var(--accent-purple)'][Math.floor(Math.random()*5)];
                    document.body.appendChild(c);
                    const a = Math.random()*Math.PI*2, v=50+Math.random()*100, ex=Math.cos(a)*v*(Math.random()*5), ey=(Math.sin(a)*v)+(window.innerHeight-sy);
                    c.animate([{transform:'translate(0,0) rotate(0deg)',opacity:1},{transform:`translate(${ex}px, ${ey}px) rotate(${Math.random()*720}deg)`,opacity:0}],{duration:3000+Math.random()*2000,easing:'cubic-bezier(0.1,0.5,0.5,1)'}).onfinish=()=>c.remove();
                }
                if(party){const p=document.createElement('div');p.className='party-time-overlay';document.body.appendChild(p);setTimeout(()=>p.remove(),5000);}
            }
            const renderAllLists = () => { renderDailyTasks(); renderStandaloneTasks(); renderGeneralTasks(); checkOverdueTasks(); initSortable(); };
            
            settingsLoginBtn.addEventListener('click', () => {
                const accountModalContent = accountModal.querySelector('.modal-content');
                setupAuthForms(accountModalContent, () => {
                    closeModal(accountModal);
                    closeModal(settingsModal);
                });
                openModal(accountModal);
            });

            logoutBtn.addEventListener('click', () => {
                showConfirm("Logout?", "You will be returned to the landing page.", () => {
                    sessionStorage.removeItem('isGuest'); 
                    window.firebaseSDK.signOut(auth).catch(error => console.error("Logout Error:", getCoolErrorMessage(error)));
                });
            });

            const init = async () => {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applySettings);
                showRandomQuote();
                updateUserUI();
                await initialLoad();
                checkDailyReset();
                resumeTimers();
                setInterval(checkOverdueTasks, 60 * 1000);
            };

            init();
        }

        // =========================================================================
        // UTILITY/SHARED AUTH FUNCTIONS
        // =========================================================================

        /**
         * Returns a user-friendly, "cooler" error message from a Firebase error object.
         * @param {Error} error - The Firebase error object.
         * @returns {string} A friendly error message.
         */
        function getCoolErrorMessage(error) {
            const defaultMessage = "An unexpected error occurred. Please try again.";
            if (!error || !error.code) return defaultMessage;

            switch (error.code) {
                case 'auth/invalid-email': return "Hmm, that email doesn't look right. Check for typos?";
                case 'auth/user-disabled': return "This account has been disabled. Contact support for help.";
                case 'auth/user-not-found': return "No account found with this email. Time to sign up?";
                case 'auth/wrong-password': return "Incorrect password. Did you forget? It happens to the best of us!";
                case 'auth/email-already-in-use': return "An account with this email already exists. Try logging in!";
                case 'auth/weak-password': return "Password should be at least 6 characters long. Make it strong!";
                case 'auth/requires-recent-login': return "This is a sensitive action. Please log in again to continue.";
                case 'auth/popup-closed-by-user': return "Sign-in cancelled. Did you change your mind?";
                case 'auth/account-exists-with-different-credential': return "You've already signed up with this email using a different method (e.g., Google). Try logging in that way!";
                default:
                    console.error("Firebase Auth Error:", error);
                    return "Google Sign-In failed. Please ensure pop-ups are enabled and try again. Also, check your internet connection.";
            }
        }

        /**
         * Merges guest data from localStorage with existing cloud data.
         * @param {object} cloudData - The existing data from Firestore.
         * @returns {object} The merged data object.
         */
        function mergeGuestDataWithCloud(cloudData = {}) {
            const guestDataString = localStorage.getItem('anonymousUserData');
            if (!guestDataString) return cloudData;

            try {
                const guestData = JSON.parse(guestDataString);
                console.log("Merging guest data with cloud data...");

                const mergedData = JSON.parse(JSON.stringify(cloudData)); // Deep copy to avoid mutation

                // Use a Set to avoid duplicates based on task text
                const mergeTasks = (cloudTasks = [], guestTasks = []) => {
                    const existingTexts = new Set(cloudTasks.map(t => t.text));
                    const newTasks = guestTasks.filter(t => !existingTexts.has(t.text));
                    return [...cloudTasks, ...newTasks];
                };
                
                mergedData.dailyTasks = mergeTasks(cloudData.dailyTasks, guestData.dailyTasks);
                mergedData.standaloneMainQuests = mergeTasks(cloudData.standaloneMainQuests, guestData.standaloneMainQuests);
                
                // For groups, merge tasks within existing groups and add new groups
                if (guestData.generalTaskGroups) {
                    if (!mergedData.generalTaskGroups) mergedData.generalTaskGroups = [];
                    guestData.generalTaskGroups.forEach(guestGroup => {
                        const cloudGroup = mergedData.generalTaskGroups.find(cg => cg.name === guestGroup.name);
                        if (cloudGroup) {
                            cloudGroup.tasks = mergeTasks(cloudGroup.tasks, guestGroup.tasks);
                        } else {
                            mergedData.generalTaskGroups.push(guestGroup);
                        }
                    });
                }
                
                // For player data, combine XP and take the higher level
                if (guestData.playerData) {
                    if (!mergedData.playerData) {
                        mergedData.playerData = guestData.playerData;
                    } else {
                        mergedData.playerData.xp = (mergedData.playerData.xp || 0) + (guestData.playerData.xp || 0);
                        mergedData.playerData.level = Math.max(mergedData.playerData.level || 1, guestData.playerData.level || 1);
                        // A full XP recalculation would be better here, but this is a simple merge
                    }
                }
                
                return mergedData;

            } catch (e) {
                console.error("Failed to parse or merge guest data:", e);
                return cloudData; // Return original cloud data if merge fails
            }
        }

        /**
         * Handles the logic after a successful sign-in, including merging guest data.
         * @param {User} user - The user object from Firebase Auth.
         */
        async function handleSignInSuccess(user) {
            const isGuestBeforeSignIn = sessionStorage.getItem('isGuest') === 'true';
            
            if (isGuestBeforeSignIn) {
                const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                const docSnap = await window.firebaseSDK.getDoc(userDocRef);
                let finalData = {};
                
                if (docSnap.exists()) {
                    // User has existing data, merge it with guest data
                    finalData = mergeGuestDataWithCloud(docSnap.data().appData);
                } else {
                    // New user, just use the guest data as their starting data
                    const guestDataString = localStorage.getItem('anonymousUserData');
                    finalData = guestDataString ? JSON.parse(guestDataString) : {};
                }

                await window.firebaseSDK.setDoc(userDocRef, { appData: finalData });

                // Clean up guest state
                localStorage.removeItem('anonymousUserData');
                sessionStorage.removeItem('isGuest');
            }
        }


        /**
         * Sets up the authentication forms inside a given container element.
         * @param {HTMLElement} container - The element to populate with auth forms.
         * @param {Function} onSuccess - A callback function to run on successful login/signup.
         */
        function setupAuthForms(container, onSuccess) {
            const template = document.getElementById('account-modal-content');
            container.innerHTML = template.innerHTML;

            // Tab switching logic
            container.querySelector('.form-toggle').addEventListener('click', (e) => {
                if (e.target.matches('.toggle-btn')) {
                    const tab = e.target.dataset.tab;
                    container.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    container.querySelectorAll('.auth-form').forEach(form => form.style.display = form.dataset.form === tab ? 'block' : 'none');
                    container.querySelectorAll('.error-message').forEach(el => el.textContent = '');
                }
            });

            // Sign Up form
            container.querySelector('[data-form="signup"]').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = container.querySelector('.signup-email').value;
                const password = container.querySelector('.signup-password').value;
                const errorEl = container.querySelector('.signup-error');
                errorEl.textContent = '';
                try {
                    const userCredential = await window.firebaseSDK.createUserWithEmailAndPassword(auth, email, password);
                    await handleSignInSuccess(userCredential.user);
                    onSuccess();
                } catch (error) { errorEl.textContent = getCoolErrorMessage(error); }
            });

            // Login form
            container.querySelector('[data-form="login"]').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = container.querySelector('.login-email').value;
                const password = container.querySelector('.login-password').value;
                const errorEl = container.querySelector('.login-error');
                errorEl.textContent = '';
                try {
                    const userCredential = await window.firebaseSDK.signInWithEmailAndPassword(auth, email, password);
                    await handleSignInSuccess(userCredential.user);
                    onSuccess();
                } catch (error) { errorEl.textContent = getCoolErrorMessage(error); }
            });
            
            // Google Sign-In button
            const googleBtnContainer = container.querySelector('.google-signin-btn-container');
            if (googleBtnContainer) {
                const customBtn = document.createElement('button');
                customBtn.type = 'button';
                customBtn.className = 'google-btn-custom';
                customBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.222 0-9.618-3.22-11.28-7.581l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.015 35.258 44 30.036 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg> <span>Sign in with Google</span>`;
                googleBtnContainer.appendChild(customBtn);
                customBtn.addEventListener('click', async () => {
                    const provider = new window.firebaseSDK.GoogleAuthProvider();
                    try {
                        const result = await window.firebaseSDK.signInWithPopup(auth, provider);
                        await handleSignInSuccess(result.user);
                        onSuccess();
                    } catch (error) {
                         const errorEl = container.querySelector('.login-error');
                         if (errorEl) errorEl.textContent = getCoolErrorMessage(error);
                    }
                });
            }
        }
    </script>
</body>
</html>
