<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procrasti-Nope</title>
    <link rel="icon" type="image/png" href="src/images/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- Firebase SDKs (Updated Version) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            reauthenticateWithCredential,
            EmailAuthProvider,
            updatePassword,
            updateEmail,
            fetchSignInMethodsForEmail,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            writeBatch,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            updateDoc,
            arrayUnion,
            arrayRemove,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase functions to the global scope to be used in the main script
        window.firebaseSDK = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            reauthenticateWithCredential,
            EmailAuthProvider,
            updatePassword,
            updateEmail,
            fetchSignInMethodsForEmail,
            deleteUser,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            writeBatch,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            updateDoc,
            arrayUnion,
            arrayRemove,
            deleteDoc
        };
    </script>
    
    <!-- FIX: Pre-emptive theme application to prevent flash of wrong theme -->
    <script>
        (function() {
            try {
                // Check local storage first (for guests)
                const guestData = localStorage.getItem('anonymousUserData');
                const storedSettings = guestData ? JSON.parse(guestData).settings : null;
                
                // If no guest data, check for a simpler theme setting (for logged-in users)
                const themeSetting = storedSettings ? storedSettings.theme : localStorage.getItem('userTheme');
                
                if (themeSetting) {
                    const isDark = themeSetting === 'dark' || (themeSetting === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                    if (isDark) {
                        document.documentElement.classList.add('dark-mode');
                    }
                }
            } catch (e) {
                console.error('Error applying initial theme:', e);
            }
        })();
    </script>
    <style>
        /*
        ==========================================================================
        NEOBRUTALIST THEME & VARIABLES (REVAMPED)
        ==========================================================================
        */
        :root {
            --font-main: 'Inter', sans-serif;

            /* Light Theme - WARM & PASTEL */
            --bg-light: #FFF8E7; /* Soft Cream */
            --text-light: #4E443A; /* Warm Dark Brown */
            --border-light: #4E443A;
            --shadow-light: #4E443A;
            --surface-light: #FFFFFF;
            --text-on-accent: #4E443A; /* Dark text for light pastels */
            --surface-light-rgb: 255, 255, 255;

            /* Dark Theme - DEEPER & WARM (MODIFIED) */
            --bg-dark: #211B14; /* Warmer, less dark background */
            --text-dark: #EAE2D6; /* Warm Off-white */
            --border-dark: #EAE2D6;
            --shadow-dark: #655e5e;
            --surface-dark: #352D25; /* Warmer, lighter surface */
            --surface-dark-rgb: 53, 45, 37;
            
            /* Light Theme Accent Colors */
            --accent-pink-light: #FFB7C5;
            --accent-blue-light: #99CCFF;
            --accent-green-light: #A7D4A8;
            --accent-orange-light: #FFB347;
            --accent-purple-light: #C7A2F4;
            --accent-yellow-light: #FFEE93;
            --accent-cyan-light: #A4DDED;
            --accent-red-light: #FF6961;
            --accent-lime-light: #D4E99E;
            --accent-indigo-light: #A5ADFF;
            --accent-teal-light: #87D7C8;
            --accent-amber-light: #FFCF8B;

            /* Base Accent Colors (default to light) */
            --accent-pink: var(--accent-pink-light);
            --accent-blue: var(--accent-blue-light);
            --accent-green: var(--accent-green-light);
            --accent-orange: var(--accent-orange-light);
            --accent-purple: var(--accent-purple-light);
            --accent-yellow: var(--accent-yellow-light);
            --accent-cyan: var(--accent-cyan-light);
            --accent-red: var(--accent-red-light);
            --accent-lime: var(--accent-lime-light);
            --accent-indigo: var(--accent-indigo-light);
            --accent-teal: var(--accent-teal-light);
            --accent-amber: var(--accent-amber-light);

            /* Default State (Light) */
            --bg: var(--bg-light);
            --text: var(--text-light);
            --border: var(--border-light);
            --shadow: var(--shadow-light);
            --surface: var(--surface-light);
            --accent: var(--accent-red);
            --shadow-color: var(--shadow);
            --noise-opacity: 0.05;
            --surface-rgb: var(--surface-light-rgb);


            /* Universal Settings */
            --border-width: 3px;
            --shadow-offset: 6px;
            --radius: 12px;
            --transition-speed: 0.2s;
        }

        .dark-mode {
            --bg: var(--bg-dark);
            --text: var(--text-dark);
            --border: var(--border-dark);
            --shadow: var(--shadow-dark);
            --surface: var(--surface-dark);
            --text-on-accent: var(--text-dark); /* Use light text for pastels in dark mode */
            --noise-opacity: 0.08;
            --surface-rgb: var(--surface-dark-rgb);
            
            /* Dark Theme Accent Colors (Darker, more pastel) */
            --accent-pink-dark: #C98B96;
            --accent-blue-dark: #8A9EC4;
            --accent-green-dark: #8DAF8E;
            --accent-orange-dark: #D99A5B;
            --accent-purple-dark: #A991C4;
            --accent-yellow-dark: #CEC592;
            --accent-cyan-dark: #93B2BC;
            --accent-red-dark: #D97C75;
            --accent-lime-dark: #B4C290;
            --accent-indigo-dark: #9A9FDA;
            --accent-teal-dark: #7DAAA1;
            --accent-amber-dark: #D9B383;

            /* Remap Base Accent Colors to Dark Versions */
            --accent-pink: var(--accent-pink-dark);
            --accent-blue: var(--accent-blue-dark);
            --accent-green: var(--accent-green-dark);
            --accent-orange: var(--accent-orange-dark);
            --accent-purple: var(--accent-purple-dark);
            --accent-yellow: var(--accent-yellow-dark);
            --accent-cyan: var(--accent-cyan-dark);
            --accent-red: var(--accent-red-dark);
            --accent-lime: var(--accent-lime-dark);
            --accent-indigo: var(--accent-indigo-dark);
            --accent-teal: var(--accent-teal-dark);
            --accent-amber: var(--accent-amber-dark);
        }

        /*
        ==========================================================================
        BASE & LAYOUT
        ==========================================================================
        */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            /* Custom Scrollbar Styles */
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--surface);
            /* FIX: Prevent layout shift when modals open/close */
            scrollbar-gutter: stable;
        }

        body {
            min-height: 100vh; /* FIX: Allow body to grow with content */
        }
        
        body::-webkit-scrollbar {
            width: 14px;
        }

        body::-webkit-scrollbar-track {
            background: var(--surface);
            border-left: var(--border-width) solid var(--border);
        }

        body::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: var(--radius);
            border: var(--border-width) solid var(--border);
        }

        body::before {
            content: '';
            display: block;
            height: 10px;
            background-color: var(--accent);
            transition: background-color var(--transition-speed) ease;
        }
        
        /* Grainy Texture Overlay */
        body::after {
            content: "";
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MDAgNTAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuOCIgbnVtT2N0YXZlcz0iMyIgc3RpdGNoVGlsZXM9InN0aXRjaCIvPjwvZmlsdGVyPjxyZWN0IHdpZHRoPSIxMDAl" height="100%" filter="url(#noise)"/></svg>');
            background-size: 250px 250px;
            opacity: var(--noise-opacity);
            pointer-events: none;
            z-index: 10000;
            transition: opacity var(--transition-speed) ease;
            animation: grain 8s steps(10) infinite;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            overflow-x: hidden;
        }
        
        #app-wrapper {
            transition: filter 0.3s ease-in-out;
        }

        #app-wrapper.blur-background {
            filter: blur(5px);
            pointer-events: none;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem; /* FIX: Reduced padding to minimize gap */
        }
        
        /* IMPORT: Added padding for the bottom nav bar on mobile */
        main.container {
            padding-bottom: 100px;
        }


        .quests-layout {
            display: flex;
            flex-direction: column; /* Default: stack quests vertically */
        }
        
        /* On mobile, quest sections are toggled, not side-by-side */
        @media (max-width: 1023px) {
            .task-group {
                display: none; /* Hide all sections by default */
            }
            .task-group.mobile-visible {
                display: block; /* Show only the active one */
            }
        }

        /* For wider screens, display quests side-by-side */
        @media (min-width: 1024px) {
            .container {
                max-width: 1280px; /* Widen the container */
            }

            .quests-layout {
                flex-direction: row; /* Place items in a row */
                gap: 2rem; /* Add space between the two columns */
                align-items: flex-start; /* Align columns to the top */
            }

            .quests-layout > .task-group {
                flex: 1 1 0px; /* Allow each column to grow and take up equal space */
                margin-bottom: 0; /* Remove bottom margin as 'gap' handles spacing */
            }

            /* Hover effects for action buttons on desktop */
            .task-buttons-wrapper,
            .main-quest-group-header .group-actions {
                opacity: 0;
                transition: opacity var(--transition-speed) ease;
                pointer-events: none;
            }

            .task-item:hover .task-buttons-wrapper,
            .main-quest-group:hover .main-quest-group-header .group-actions,
            .task-item.timer-active .task-buttons-wrapper {
                opacity: 1;
                pointer-events: auto;
            }

            /* FIX: Allow completed quest text to wrap correctly on wide screens */
            .task-item.daily-completed .task-content {
                flex-grow: 1; /* Let the content area grow to fill space */
                margin-right: 0;
            }
        }
        
        /*
        ==========================================================================
        LOADING ANIMATION
        ==========================================================================
        */
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }

        .loader-box {
            width: 60px;
            height: 60px;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow);
            animation: spin 1.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg) scale(1); border-radius: 0; }
            50% { transform: rotate(180deg) scale(0.8); border-radius: 50%; }
            100% { transform: rotate(360deg) scale(1); border-radius: 0; }
        }
        
        /*
        ==========================================================================
        LANDING PAGE
        ==========================================================================
        */
        #landing-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .landing-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            padding: 2.5rem 2rem;
            text-align: center;
        }

        .landing-buttons {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .landing-buttons .btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
        }
        #landing-back-btn {
            margin-top: 1.5rem;
        }


        /*
        ==========================================================================
        HEADER & PROGRESS
        ==========================================================================
        */
        .sticky-header {
            position: sticky;
            top: 0;
            background-color: var(--bg);
            padding: 1.5rem 1rem;
            z-index: 10;
            border-bottom: var(--border-width) solid var(--border);
            box-shadow: 0 var(--shadow-offset) 0 var(--shadow);
            margin-bottom: 0; /* Adjusted */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content {
            text-align: left;
            flex-grow: 1; /* Allow content to take available space */
            min-width: 0; /* Critical for preventing overflow on flex items */
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0; /* Prevent controls from shrinking */
        }

        #user-display {
            font-weight: 700;
        }
        
        .main-title {
            font-size: 2.5rem;
            font-weight: 900;
            letter-spacing: -2px;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            color: var(--accent);
            display: inline-block; /* FIX: Shrink hitbox to content */
        }
        .main-title:hover {
            transform: rotate(-1deg) scale(1.02); /* FIX: Tone down animation */
        }


        .quote {
            font-size: 1rem;
            font-weight: 700;
            font-style: italic;
            opacity: 0.8;
        }
        
        .player-progress-section {
            background-color: var(--surface);
            border-bottom: var(--border-width) solid var(--border);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0; /* FIX: Removed space to reduce gap */
        }
        
        .level-display {
            background-color: var(--accent);
            color: var(--text-on-accent);
            font-weight: 900;
            padding: 0.5rem 1rem;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow);
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .level-display.level-up {
            animation: levelUpPulse 0.5s ease-in-out;
        }
        
        .xp-bar-container {
            flex-grow: 1;
            background-color: var(--bg);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            padding: 0.25rem;
            position: relative;
        }
        
        .xp-bar {
            width: 0%;
            height: 25px;
            background-color: var(--accent);
            border-radius: calc(var(--radius) / 2);
            transition: width 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        #xp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 700;
            color: var(--text);
            mix-blend-mode: difference;
            filter: invert(1) grayscale(1);
        }
        .dark-mode #xp-text {
            mix-blend-mode: normal; /* Changed from unset */
            filter: none; /* Changed from unset */
            color: var(--text-dark); /* Explicitly set color for dark mode */
        }
        
        /* Mobile Responsiveness for Header */
        @media (max-width: 640px) {
            .sticky-header {
                padding: 1rem;
                gap: 1rem;
            }
            .main-title {
                font-size: 1.8rem;
                letter-spacing: -1px;
            }
            .quote {
                display: none; /* Hide quote on small screens to save space */
            }
            .theme-btn span {
                display: none;
            }
            .theme-btn {
                padding: 0.75rem; /* Make it a square */
            }
        }
        
        /*
        ==========================================================================
        FRIENDS FEATURE & MOBILE NAV
        ==========================================================================
        */
        /* IMPORT: Desktop friends button */
        #friends-btn-desktop {
            display: none; /* Hidden on mobile by default */
        }
        @media (min-width: 1024px) {
            #friends-btn-desktop {
                display: flex; /* Visible on desktop */
                gap: 0.5rem;
                --shadow-color: var(--shadow);
            }
            #friends-btn-desktop svg {
                width: 20px;
                height: 20px;
            }
        }
        
        /* IMPORT: Mobile bottom navigation bar */
        #mobile-nav {
            display: none; /* Hidden on desktop */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background-color: var(--surface);
            border-top: var(--border-width) solid var(--border);
            box-shadow: 0px -6px 0 var(--shadow);
            z-index: 500;
            border-top-left-radius: var(--radius);
            border-top-right-radius: var(--radius);
            padding: 0 1rem;
            border-left: var(--border-width) solid var(--border);
            border-right: var(--border-width) solid var(--border);
        }
        .mobile-nav-content {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 100%;
            border: var(--border-width) dashed rgba(var(--surface-rgb), 0.2);
            border-bottom: none;
            border-radius: calc(var(--radius) - var(--border-width));
            padding-bottom: 5px;
            transform: translateY(2px);
        }
        .mobile-nav-btn {
            background-color: var(--surface);
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-family: var(--font-main);
            font-weight: 700;
            color: var(--text);
            opacity: 0.6;
            transition: all var(--transition-speed) ease;
            padding: 0.5rem;
            border-radius: var(--radius);
            border: var(--border-width) solid transparent;
            box-shadow: 4px 4px 0 transparent;
            flex: 1 1 0px;
        }
        .mobile-nav-btn span {
            font-weight: 900;
        }

        .mobile-nav-btn.active {
            opacity: 1;
            border-color: var(--border);
            box-shadow: 4px 4px 0 var(--shadow);
            transform: translateY(-5px);
            color: var(--accent);
            background-color: var(--bg);
        }

        .mobile-nav-btn.active svg {
            color: var(--accent);
        }
        
        .mobile-nav-btn svg {
            width: 28px;
            height: 28px;
            stroke: currentColor;
            stroke-width: var(--border-width);
        }
        @media (max-width: 1023px) {
            #mobile-nav {
                display: block; /* Show on mobile */
            }
        }
        
        /* IMPORT: Friends Modal */
        #friends-modal .modal-content {
            position: relative;
            overflow: hidden; /* To contain the animated background */
        }

        #friends-modal-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.1;
            overflow: hidden;
        }
        
        #friends-modal-bg svg {
            width: 200%;
            height: 200%;
            animation: bg-pan 40s linear infinite;
        }
        
        @keyframes bg-pan {
            0% { transform: translate(0, 0); }
            25% { transform: translate(-20%, 10%); }
            50% { transform: translate(0, -20%); }
            75% { transform: translate(10%, 10%); }
            100% { transform: translate(0, 0); }
        }
        
        /* NEW: Set min-height to prevent modal resizing between tabs */
        #friends-modal .tab-content {
            min-height: 250px;
        }

        #friends-modal h3 {
            font-weight: 900; /* Bolder headers */
        }
        
        .friends-list-container, .friend-requests-container {
            max-height: 300px;
            overflow-y: auto;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem;
            background-color: var(--surface);
        }
        
        .friend-item, .friend-request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: calc(var(--radius) / 2);
            gap: 0.75rem; /* Add gap for level display */
        }

        /* NEW: Bolder font for friend names */
        .friend-item .friend-name, 
        .friend-request-item span {
            font-weight: 700;
            flex-grow: 1; /* Allow name to take space */
        }


        .friend-item:not(:last-child), .friend-request-item:not(:last-child) {
            border-bottom: var(--border-width) dashed var(--border);
        }

        .friend-item-actions, .friend-request-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0; /* Prevent buttons from shrinking */
        }

        /* NEW: Friend Level Display Box */
        .friend-level-display {
            background-color: var(--accent);
            color: var(--text-on-accent);
            font-weight: 900;
            padding: 0.25rem 0.75rem;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: 4px 4px 0 var(--shadow);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        
        
        /* NEW: Neobrutalism styling for friend action buttons */
        .friend-item-actions .remove-friend-btn,
        .friend-request-actions .decline-request-btn {
            --shadow-color: var(--accent-red);
        }
        .friend-request-actions .accept-request-btn {
            --shadow-color: var(--accent-green);
        }

        #add-friend-form {
            display: flex;
            gap: 0.5rem;
        }
        
        #search-username-input { flex-grow: 1; }
        
        .friend-status-message {
            margin-top: 1rem;
            font-weight: 700;
            text-align: center;
            min-height: 1.2em;
        }


        /*
        ==========================================================================
        TASK LIST & ITEMS
        ==========================================================================
        */
        .task-group {
            margin-bottom: 3rem;
        }

        .task-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: var(--border-width) solid var(--border);
        }
        
        .task-group-header .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .task-group-header h2 {
            font-size: 1.8rem;
            font-weight: 900;
        }

        .main-quest-group, .task-item {
            cursor: grab;
        }
        
        .sortable-ghost {
            opacity: 0.4;
            background-color: var(--accent);
        }
        
        /* Shake animation for all items during drag */
        body.is-dragging .task-item,
        body.is-dragging .main-quest-group {
            animation: shake-light 0.4s cubic-bezier(.36,.07,.19,.97) both infinite;
        }


        .main-quest-group {
            margin-bottom: 1.5rem; /* FIX: Reduced spacing */
            transition: all var(--transition-speed) ease;
        }
        
        .main-quest-group.removing {
             animation: slideOut 0.4s ease forwards;
        }

        .main-quest-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            position: relative;
            cursor: pointer;
        }

        .group-title-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-grow: 1;
        }

        .expand-icon {
            transition: transform 0.2s ease;
            flex-shrink: 0;
            width: 28px; /* FIX: Increased icon size */
            height: 28px; /* FIX: Increased icon size */
        }

        .main-quest-group.expanded .expand-icon {
            transform: rotate(90deg);
        }

        /* Emphasis for group headers */
        .main-quest-group-header::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: var(--border-width) dashed var(--border);
            border-radius: calc(var(--radius) * 0.5);
            opacity: 0.5;
            pointer-events: none; /* Fix: Allow clicks to pass through the overlay */
        }

        .main-quest-group-header h3 {
            font-size: 1.3rem;
            font-weight: 900;
        }

        .main-quest-group-header .group-actions {
            display: flex;
            gap: 0.5rem;
        }


        #daily-task-list, #standalone-task-list, .main-quest-group ul {
            list-style: none;
        }
        
        /* FIX: Remove space from empty standalone quest list */
        #standalone-task-list:empty {
            display: none;
        }

        .main-quest-group ul.task-list-group {
            min-height: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out, margin-top 0.2s ease-out;
            margin-top: 0;
            padding: 0;
        }

        .main-quest-group:hover ul.task-list-group,
        .main-quest-group.expanded ul.task-list-group {
            max-height: 1000px; /* Increased max-height for very long lists */
            margin-top: 1rem;
            transition: max-height 0.25s ease-in;
            /* FIX: Add padding to prevent shadow clipping on child elements */
            padding-right: 0.5rem;
            padding-bottom: 0.5rem;
        }


        .task-item {
            display: flex;
            flex-wrap: wrap; 
            align-items: center;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            transition: all var(--transition-speed) ease, max-height var(--transition-speed) ease;
            position: relative;
            overflow: hidden;
            max-height: 100px; /* Base height for transitions */
        }
        
        /* Standalone quests look like group headers */
        .task-item.standalone-quest {
             padding: 1rem;
        }
         .task-item.standalone-quest::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: var(--border-width) dashed var(--border);
            border-radius: calc(var(--radius) * 0.5);
            opacity: 0.5;
            pointer-events: none; /* Fix: Allow clicks to pass through the overlay */
        }
         .task-item.standalone-quest .task-text {
            font-size: 1.3rem;
            font-weight: 900;
        }

        .task-item.overdue {
            animation: shake 0.8s cubic-bezier(.36,.07,.19,.97) infinite both;
            border-color: var(--accent-red);
            --shadow-color: var(--accent-red);
        }
        
        /* NEW: Style for when a timer finishes */
        .task-item.timer-finished {
            border-color: var(--accent-red);
            --shadow-color: var(--accent-red);
            animation: shake 0.7s cubic-bezier(.36,.07,.19,.97) 3; /* Shake 3 times and stop */
        }

        .task-item.daily-completed {
            max-height: 50px;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            opacity: 0.6;
            filter: grayscale(0.5);
            cursor: pointer; /* To indicate it's clickable for undo */
        }
        .task-item.daily-completed .task-text {
            text-decoration: line-through;
        }
        
        .task-item.daily-completed .task-buttons-wrapper {
            display: none;
        }

        /* Weekly goal met style */
        .task-item.weekly-goal-met {
            border-style: dashed;
            opacity: 0.8;
        }
        .task-item.weekly-goal-met::after {
            content: 'GOAL MET!';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-10deg);
            font-size: 2rem;
            font-weight: 900;
            color: var(--accent);
            opacity: 0.1;
            pointer-events: none;
        }
        
        /* Hide edit/delete when timer is active on any screen size */
        .task-item.timer-active .task-actions {
            display: none;
        }

        /* Add/Remove Animation */
        .task-item.adding {
            animation: slideIn 0.4s ease forwards;
        }

        .task-item.removing {
            animation: slideOut 0.4s ease forwards;
        }

        /* Completion Animation */
        .task-item.completed {
            animation: celebrate 0.8s ease-in-out forwards;
        }
        
        .task-item .task-content {
             display: flex;
             align-items: center;
             flex-grow: 1;
             flex-basis: 0; /* Important for flex wrapping */
             margin-right: 1rem;
             min-width: 0; /* ADDED: Prevents long text from pushing controls */
        }

        .task-item .task-text {
            font-size: 1.1rem;
            font-weight: 700;
            outline: none;
            transition: all var(--transition-speed) ease;
            padding-bottom: 5px; 
            margin-right: 1rem;
            word-break: break-word; /* Ensure long text wraps */
        }
        
        .task-buttons-wrapper {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
            align-items: center;
        }

        .task-item .task-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .streak-counter {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 700;
            margin-right: 1rem;
            color: var(--accent-orange);
        }

        .streak-counter svg {
            width: 20px;
            height: 20px;
        }
        
        /* NEW: Weekly Goal Tag Styling */
        .weekly-goal-tag {
            background-color: var(--accent);
            color: var(--text-on-accent);
            font-weight: 700;
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius);
            border: var(--border-width) solid var(--border);
            box-shadow: 4px 4px 0 var(--shadow);
            flex-shrink: 0; /* Prevent from shrinking */
        }

        /*
        ==========================================================================
        TIMER CLOCK BUTTON
        ==========================================================================
        */
        .timer-clock-btn {
            position: relative;
        }

        .timer-clock-btn .progress-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px; /* Slightly larger than icon */
            height: 32px;
        }

        .timer-clock-btn .progress-ring-circle {
            transition: stroke-dashoffset 0.5s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            stroke: var(--accent);
            stroke-width: 3;
            fill: transparent;
        }
        
        /*
        ==========================================================================
        BUTTONS & CONTROLS
        ==========================================================================
        */
        .btn {
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            --shadow-color: var(--accent); /* Buttons get accent colored shadows */
            box-shadow: 4px 4px 0 var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }
        
        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--shadow-color);
        }

        .btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--shadow-color);
        }
        
        #settings-btn {
            background-color: var(--surface);
             --shadow-color: var(--shadow);
        }


        .btn.icon-btn {
            padding: 0.5rem;
            aspect-ratio: 1 / 1;
        }
        
        .btn.icon-btn svg {
            width: 24px;
            height: 24px;
            stroke: var(--text);
            stroke-width: var(--border-width);
            transition: transform 0.2s ease;
        }
        
        .btn.icon-btn:hover svg:not(.progress-ring) {
            transform: scale(1.1) rotate(5deg);
        }
        
        .complete-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: var(--border-width) solid var(--border);
            cursor: pointer;
            flex-shrink: 0;
            margin-right: 1rem;
            transition: all var(--transition-speed) ease;
            position: relative;
            background-color: var(--surface);
        }
        
        .complete-btn:hover {
            transform: scale(1.1);
        }
        
        .complete-btn.checked {
            background-color: var(--accent);
            border-color: var(--accent);
        }
        
        .complete-btn.checked::after {
            content: 'âœ”';
            color: var(--text-on-accent);
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .task-item.daily-completed .complete-btn {
            pointer-events: none;
        }

        /*
        ==========================================================================
        MOBILE-SPECIFIC TASK INTERACTIONS
        ==========================================================================
        */
        @media (max-width: 1023px) {
            /* On mobile, action buttons are hidden until tap */
            .task-buttons-wrapper {
                opacity: 0;
                pointer-events: none;
                
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                justify-content: center;
                align-items: center;
                
                background-color: rgba(var(--surface-rgb), 0.7);
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
                z-index: 5;
                transition: opacity var(--transition-speed) ease;
                /* FIX: Add border radius to match parent container */
                border-radius: calc(var(--radius) - var(--border-width));
            }

            /* When a task is tapped, show the action buttons */
            .task-item.actions-visible .task-buttons-wrapper {
                opacity: 1;
                pointer-events: auto;
            }
            
            /* And blur the content behind the overlay */
            .task-item.actions-visible .task-content,
            .task-item.actions-visible .complete-btn {
                filter: blur(3px);
                transition: filter var(--transition-speed) ease;
                pointer-events: none; /* Prevent clicking blurred items */
            }
            
            /* EXCEPTION: If a timer is active, keep its button visible and not part of the overlay */
            .task-item.timer-active .task-buttons-wrapper {
                opacity: 1 !important;
                pointer-events: auto !important;
                position: static;
                width: auto;
                height: auto;
                background: transparent;
                backdrop-filter: none;
                -webkit-backdrop-filter: none;
                z-index: auto;
                margin-left: auto;
                border-radius: 0; /* Reset radius for this case */
            }
            
            /* NEW: Group Header Mobile Actions */
            .main-quest-group-header.actions-visible .group-actions {
                opacity: 1;
                pointer-events: auto;
            }
            .main-quest-group-header.actions-visible .group-title-container {
                filter: blur(3px);
                transition: filter var(--transition-speed) ease;
                pointer-events: none;
            }
        }
        
        /*
        ==========================================================================
        MODALS & PANELS (ADD TASK, SETTINGS)
        ==========================================================================
        */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease, visibility 0s var(--transition-speed);
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }
        
        .modal-content {
            background-color: var(--bg);
            border: var(--border-width) solid var(--border);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            border-radius: var(--radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            transform: scale(0.9) rotate(-3deg);
            transition: transform var(--transition-speed) cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        #account-modal .modal-content, #username-modal .modal-content, #manage-account-modal .modal-content {
            max-width: 400px;
            padding: 1.5rem;
        }
        
        .modal-overlay.visible .modal-content {
            transform: scale(1) rotate(0deg);
        }
        
        .modal-content h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            font-weight: 900;
        }
        
        #new-task-input, #new-group-input, .form-group input, #edit-task-input, #new-username-input, #search-username-input {
            width: 100%;
            font-family: var(--font-main);
            font-size: 1.1rem;
            padding: 1rem;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            background: var(--surface);
            color: var(--text);
        }
        .form-group {
             margin-bottom: 1rem;
        }

        #new-task-input:focus, #new-group-input:focus, .form-group input:focus, #edit-task-input:focus, #new-username-input:focus, #search-username-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 var(--border-width) var(--accent);
        }
        
        #weekly-goal-container, #edit-weekly-goal-container {
            margin-top: 1rem;
            border-top: var(--border-width) dashed var(--border);
            padding-top: 1rem;
        }
        
        #weekly-goal-container label, #edit-weekly-goal-container label {
            font-weight: 700;
            margin-bottom: 1rem; /* Increased space for slider */
            display: block;
        }


        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-submit-btn {
            background-color: var(--accent);
            color: var(--text-on-accent);
            --shadow-color: var(--shadow);
        }
        
        .settings-group {
            margin-bottom: 2rem;
        }
        
        .settings-group h3 {
            font-weight: 900;
            font-size: 1.1rem;
            border-bottom: var(--border-width) solid var(--border);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .settings-group .data-actions,
        .settings-group .account-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .theme-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .color-options {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            background-color: rgba(0,0,0,0.04);
            padding: 0.75rem;
            border-radius: var(--radius);
            border: var(--border-width) solid var(--border);
        }

        .dark-mode .color-options {
            background-color: rgba(255,255,255,0.04);
        }
        
        .theme-btn {
            gap: 0.5rem;
            --shadow-color: var(--shadow); /* Use normal shadow color */
        }
        .theme-btn svg {
             width: 20px;
             height: 20px;
             stroke-width: var(--border-width);
        }

        .theme-btn.selected {
            background-color: var(--accent);
            color: var(--text-on-accent);
        }
        .theme-btn.selected svg {
            stroke: var(--text-on-accent);
        }
        
        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: var(--border-width) solid var(--border);
            cursor: pointer;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        
        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            box-shadow: 0 0 0 var(--border-width) var(--border);
            transform: scale(1.1);
        }
        
        /* Volume and Timer Slider Styles */
        .volume-slider-container, .timer-slider-container, .weekly-goal-slider-container {
            padding-top: 0.5rem;
        }
        .timer-slider-container {
            margin-bottom: 1.5rem;
        }
        .timer-slider-container label {
            font-weight: 700;
            margin-bottom: 0.75rem;
            display: block;
        }
        #timer-duration-display {
            background: var(--surface);
            padding: 0.25rem 0.5rem;
            border-radius: calc(var(--radius) / 2);
            border: var(--border-width) solid var(--border);
        }

        .timer-unit-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .timer-unit-btn {
            --shadow-color: var(--shadow);
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }
        .timer-unit-btn.selected {
            background-color: var(--accent);
            color: var(--text-on-accent);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: 50%;
            margin-top: -5px; /* Vertically center thumb for new track height */
            box-shadow: 4px 4px 0 var(--shadow);
            transition: all var(--transition-speed) ease;
        }
        input[type="range"]::-moz-range-thumb {
            height: 24px;
            width: 24px;
            background-color: var(--surface);
            border: var(--border-width) solid var(--border);
            border-radius: 50%;
            box-shadow: 4px 4px 0 var(--shadow);
            transition: all var(--transition-speed) ease;
        }
        input[type="range"]:active::-webkit-slider-thumb {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--shadow);
        }
        input[type="range"]:active::-moz-range-thumb {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--shadow);
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 16px;
            background: var(--accent);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
        }
        input[type="range"]::-moz-range-track {
            width: 100%;
            height: 16px;
            background: var(--accent);
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
        }
        
        /* Account Modal Specific Styles */
        .form-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .toggle-btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 1rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            background-color: var(--surface);
            border: none;
            color: var(--text);
            transition: all var(--transition-speed) ease;
        }
        .toggle-btn.active {
            background-color: var(--accent);
            color: var(--text-on-accent);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        /* FIX: Neobrutalism for Auth forms */
        .auth-form .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .auth-form .form-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        /* IMPORT: Hide tab content that is not active */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .form-divider {
            text-align: center;
            margin: 1.5rem 0;
            font-weight: 700;
            color: var(--text);
            opacity: 0.7;
        }
        
        .google-btn-custom {
            background-color: #4285F4;
            color: white;
            border: var(--border-width) solid var(--border);
            border-radius: var(--radius);
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: 4px 4px 0 var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
        }
        .google-btn-custom:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--shadow);
        }
        .google-btn-custom:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--shadow);
        }
        .dark-mode .google-btn-custom {
            border-color: var(--border-dark);
            box-shadow: 4px 4px 0 var(--shadow-dark);
        }
        .dark-mode .google-btn-custom:hover {
            box-shadow: 6px 6px 0 var(--shadow-dark);
        }
        .dark-mode .google-btn-custom:active {
            box-shadow: 2px 2px 0 var(--shadow-dark);
        }
        .google-btn-custom svg {
            width: 20px;
            height: 20px;
        }
        
        .error-message, .success-message {
            font-weight: 700;
            text-align: center;
            margin-top: 1rem;
            min-height: 1.2em;
            padding: 0 0.5rem;
            line-height: 1.4;
        }

        .error-message {
            color: var(--accent-red-light);
        }
        .success-message {
            color: var(--accent-green-light);
        }
        
        /*
        ==========================================================================
        CONFETTI & CELEBRATIONS
        ==========================================================================
        */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            /* FIX: Use an animation that fades out instead of coming from the top */
            /* animation: confetti-fall 2s ease-out forwards; */
        }
        
        .party-time-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            background: linear-gradient(-45deg, var(--accent-pink), var(--accent-blue), var(--accent-green), var(--accent-purple));
            background-size: 400% 400%;
            animation: party-bg 3s ease infinite, fade-out-party 1s 4s forwards;
            opacity: 0.3;
        }

        @keyframes party-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes fade-out-party {
            to { opacity: 0; }
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(150px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /*
        ==========================================================================
        ANIMATIONS
        ==========================================================================
        */
        @keyframes grain {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-5%, -10%); }
            20% { transform: translate(-15%, 5%); }
            30% { transform: translate(7%, -25%); }
            40% { transform: translate(-5%, 25%); }
            50% { transform: translate(-15%, 10%); }
            60% { transform: translate(15%, 0%); }
            70% { transform: translate(0%, 15%); }
            80% { transform: translate(3%, 35%); }
            90% { transform: translate(-10%, 10%); }
        }
        
        @keyframes shake { /* Overdue shake */
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }
        @keyframes shake-light { /* Dragging shake */
             0% { transform: rotate(0deg); }
             25% { transform: rotate(0.5deg); }
             50% { transform: rotate(0eg); }
             75% { transform: rotate(-0.5deg); }
             100% { transform: rotate(0deg); }
        }

        @keyframes levelUpPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2) rotate(-5deg); box-shadow: 0 0 25px var(--accent); }
            100% { transform: scale(1); }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
                max-height: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 100px; /* Base height */
                margin-bottom: 1.5rem;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
                max-height: 100px;
            }
            to {
                opacity: 0;
                transform: translateX(20px);
                max-height: 0;
                padding-top: 0;
                padding-bottom: 0;
                margin-bottom: 0;
            }
        }
        
        @keyframes celebrate {
            0% { transform: scale(1); }
            20% { transform: scale(1.05) rotate(2deg); background-color: var(--accent); box-shadow: 0 0 20px var(--accent); }
            40% { transform: scale(0.95) rotate(-2deg); }
            60% { transform: scale(1.02); }
            100% {
                transform: translateX(100px) scale(0.5);
                opacity: 0;
                max-height: 0;
                padding: 0;
                margin-bottom: 0;
                border-width: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Initial Loader -->
    <div id="loader-overlay">
        <div class="loader-box"></div>
    </div>

    <!-- Landing Page for first-time users (hidden by default) -->
    <div id="landing-page" style="display: none;">
        <div class="landing-container">
            <!-- Initial choices -->
            <div id="landing-choices">
                <h1 class="main-title" style="margin-bottom: 2rem;">Procrasti-Nope</h1>
                <div class="landing-buttons">
                    <button id="landing-login-btn" class="btn">Login / Sign Up</button>
                    <button id="landing-guest-btn" class="btn">Continue as Guest</button>
                </div>
            </div>
            <!-- Auth form container -->
            <div id="landing-auth-container" style="display: none;">
                <!-- Content is dynamically filled from the #account-modal-content template -->
            </div>
        </div>
    </div>


    <div id="app-wrapper" style="display: none;">
        <header class="sticky-header">
            <div class="header-content">
                <h1 class="main-title">Procrasti-Nope</h1>
                <p class="quote" id="quote-of-the-day">Loading a dose of motivation...</p>
            </div>
            <div class="header-controls">
                <!-- IMPORT: Friends button for desktop -->
                <button id="friends-btn-desktop" class="btn" aria-label="Open Friends Menu">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <span>Friends</span>
                </button>
                <button id="settings-btn" class="btn icon-btn" aria-label="Open Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <section class="player-progress-section">
            <div class="level-display">LVL <span id="player-level">1</span></div>
            <div class="xp-bar-container">
                <div id="xp-bar" class="xp-bar"></div>
                <span id="xp-text">0 / 100 XP</span>
            </div>
        </section>

        <main class="container">
            <div class="quests-layout">
                <!-- IMPORT: Added data-section attribute and mobile-visible class -->
                <section class="task-group mobile-visible" data-section="daily">
                    <header class="task-group-header">
                        <h2>Daily Quests</h2>
                        <button class="btn add-task-trigger-btn" data-list="daily" aria-label="Add Daily Quest">+</button>
                    </header>
                    <ul id="daily-task-list"></ul>
                    <div id="no-daily-tasks-message" style="display: none; text-align: center; padding: 2rem; opacity: 0.7;">
                        <p>No daily quests yet. Add one to start your day!</p>
                    </div>
                </section>
                <!-- IMPORT: Added data-section attribute -->
                <section class="task-group" data-section="main">
                    <header class="task-group-header">
                        <h2>Main Quests</h2>
                        <div class="header-actions">
                            <button id="add-standalone-task-btn" class="btn" aria-label="Add Quest">Add Quest</button>
                            <button id="add-group-btn" class="btn" aria-label="Add Group">Add Group</button>
                        </div>
                    </header>
                    <ul id="standalone-task-list"></ul>
                    <div id="general-task-list-container"></div>
                    <div id="no-general-tasks-message" style="display: none; text-align: center; padding: 2rem; opacity: 0.7;">
                        <p>No main quests on your list. Create a group or add a quest to get started!</p>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- IMPORT: Mobile Navigation Bar (Moved outside app-wrapper) -->
    <nav id="mobile-nav">
        <div class="mobile-nav-content">
            <button class="mobile-nav-btn active" data-section="daily" aria-label="Daily Quests">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linejoin="round"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"></path></svg>
                <span>Daily</span>
            </button>
            <button class="mobile-nav-btn" data-section="main" aria-label="Main Quests">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                <span>Main</span>
            </button>
            <button class="mobile-nav-btn" data-section="friends" aria-label="Friends">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span>Friends</span>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    <div id="add-task-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="add-task-modal-title">Add New Quest</h2>
            <form id="add-task-form">
                <input type="text" id="new-task-input" placeholder="e.g., Conquer the world..." required maxlength="30">
                <div id="weekly-goal-container" style="display: none;">
                    <label for="new-task-weekly-goal-slider">Weekly Goal: <span id="new-task-weekly-goal-display">None</span></label>
                    <div class="weekly-goal-slider-container">
                         <input type="range" id="new-task-weekly-goal-slider" min="0" max="7" value="0">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="add-task-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Add</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-task-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="edit-task-modal-title">Edit Quest</h2>
            <form id="edit-task-form">
                <input type="hidden" id="edit-task-id">
                <input type="text" id="edit-task-input" required maxlength="30">
                <div id="edit-weekly-goal-container" style="display: none;">
                    <label for="edit-task-weekly-goal-slider">Weekly Goal: <span id="edit-task-weekly-goal-display">3</span> days</label>
                    <div class="weekly-goal-slider-container">
                        <input type="range" id="edit-task-weekly-goal-slider" min="0" max="7" value="3">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="edit-task-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-group-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Create New Group</h2>
            <form id="add-group-form">
                <input type="text" id="new-group-input" placeholder="e.g., Project Overlord" required maxlength="30">
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="add-group-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="timer-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Set Task Timer</h2>
            <form id="timer-form">
                <div class="timer-slider-container">
                    <label for="timer-duration-slider">Duration: <span id="timer-duration-display">25</span></label>
                    <input type="range" id="timer-duration-slider" min="1" max="100" value="25">
                </div>
                <div class="timer-unit-selector">
                    <button type="button" class="btn timer-unit-btn" data-unit="seconds">Seconds</button>
                    <button type="button" class="btn timer-unit-btn selected" data-unit="minutes">Minutes</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="hours">Hours</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="days">Days</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="weeks">Weeks</button>
                    <button type="button" class="btn timer-unit-btn" data-unit="months">Months</button>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" data-close-modal="timer-modal">Cancel</button>
                    <button type="submit" class="btn modal-submit-btn">Start Timer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- IMPORT: Friends Modal -->
    <div id="friends-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="friends-modal-bg">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 800"><defs><filter id="f" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur in="SourceGraphic" stdDeviation="40"></feGaussianBlur></filter></defs><g filter="url(#f)"><circle cx="400" cy="400" r="150" fill="var(--accent-blue)"></circle><circle cx="100" cy="200" r="100" fill="var(--accent-green)"></circle><circle cx="600" cy="150" r="120" fill="var(--accent-red)"></circle><circle cx="700" cy="650" r="180" fill="var(--accent-yellow)"></circle><circle cx="200" cy="700" r="90" fill="var(--accent-purple)"></circle></g></svg>
            </div>
            <div class="form-toggle">
                <button class="toggle-btn active" data-tab="my-friends">Friends</button>
                <button class="toggle-btn" data-tab="requests">Requests <span id="friend-request-count"></span></button>
                <button class="toggle-btn" data-tab="add-friend">Add</button>
            </div>
            
            <div id="my-friends-tab" class="tab-content active">
                <h3>My Friends</h3>
                <div class="friends-list-container">
                    <!-- Friend items will be injected here -->
                </div>
            </div>
            
            <div id="requests-tab" class="tab-content">
                <h3>Friend Requests</h3>
                <div class="friend-requests-container">
                    <!-- Friend request items will be injected here -->
                </div>
            </div>

            <div id="add-friend-tab" class="tab-content">
                 <h3>Add Friend by Username</h3>
                 <form id="add-friend-form">
                    <input type="text" id="search-username-input" placeholder="Enter username..." required>
                    <button type="submit" class="btn icon-btn" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button>
                 </form>
                 <p class="friend-status-message"></p>
            </div>
            
            <div class="modal-actions"><button class="btn" data-close-modal="friends-modal">Close</button></div>
        </div>
    </div>


    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Settings</h2>
            <div class="settings-group">
                <h3>Account</h3>
                <div class="account-actions">
                    <span id="user-display" style="display: none; align-items:center;"></span>
                    <button id="settings-login-btn" class="btn">Login / Sign Up</button>
                    <button id="manage-account-btn" class="btn" style="display: none;">Manage Account</button>
                    <button id="logout-btn" class="btn" style="display: none;">Logout</button>
                </div>
            </div>
            <div class="settings-group">
                <h3>Theme</h3>
                <div class="theme-options" id="theme-options-buttons">
                    <button class="btn theme-btn" data-theme="light" aria-label="Light Theme"><svg class="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span>Light</span></button>
                    <button class="btn theme-btn" data-theme="dark" aria-label="Dark Theme"><svg class="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><span>Dark</span></button>
                    <button class="btn theme-btn" data-theme="system" aria-label="System Theme"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg><span>System</span></button>
                </div>
            </div>
            <div class="settings-group">
                <h3>Accent Color</h3>
                <div class="color-options" id="color-options">
                    <div class="color-swatch" data-color="var(--accent-red)" style="background-color: var(--accent-red);"></div><div class="color-swatch" data-color="var(--accent-orange)" style="background-color: var(--accent-orange);"></div><div class="color-swatch" data-color="var(--accent-amber)" style="background-color: var(--accent-amber);"></div><div class="color-swatch" data-color="var(--accent-yellow)" style="background-color: var(--accent-yellow);"></div><div class="color-swatch" data-color="var(--accent-lime)" style="background-color: var(--accent-lime);"></div><div class="color-swatch" data-color="var(--accent-green)" style="background-color: var(--accent-green);"></div><div class="color-swatch" data-color="var(--accent-teal)" style="background-color: var(--accent-teal);"></div><div class="color-swatch" data-color="var(--accent-cyan)" style="background-color: var(--accent-cyan);"></div><div class="color-swatch" data-color="var(--accent-blue)" style="background-color: var(--accent-blue);"></div><div class="color-swatch" data-color="var(--accent-indigo)" style="background-color: var(--accent-indigo);"></div><div class="color-swatch" data-color="var(--accent-purple)" style="background-color: var(--accent-purple);"></div><div class="color-swatch" data-color="var(--accent-pink)" style="background-color: var(--accent-pink);"></div>
                </div>
            </div>
            <div class="settings-group">
                <h3>Sound Volume</h3>
                <div class="volume-slider-container"><input type="range" id="volume-slider" min="0" max="1" step="0.01" aria-label="Volume"></div>
            </div>
             <div class="settings-group">
                <h3 id="data-management-heading">Data (Local)</h3>
                <div class="data-actions">
                    <button id="export-data-btn" class="btn">Export Guest Data</button>
                    <button id="import-data-btn" class="btn">Import Guest Data</button>
                    <input type="file" id="import-file-input" style="display: none;" accept=".json">
                    <button id="reset-progress-btn" class="btn">Reset Progress</button>
                </div>
            </div>
            <div class="modal-actions"><button class="btn" data-close-modal="settings-modal">Close</button></div>
        </div>
    </div>
    
    <div id="account-modal" class="modal-overlay">
        <div class="modal-content"></div>
    </div>
    
    <div id="manage-account-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="reauth-container">
                <h2>Confirm Password</h2>
                <p style="margin-bottom: 1.5rem;">For your security, please enter your password to continue.</p>
                <form id="reauth-form" class="auth-form">
                    <div class="form-group">
                        <label for="reauth-password">Current Password</label>
                        <input type="password" id="reauth-password" required>
                    </div>
                    <button type="submit" class="btn modal-submit-btn" style="width: 100%;">Confirm</button>
                    <p class="error-message" id="reauth-error"></p>
                </form>
            </div>

            <div id="manage-forms-container" style="display: none;">
                <h2>Manage Account</h2>
                
                <form id="update-username-form" class="auth-form" style="margin-top: 2rem;">
                     <div class="settings-group">
                        <h3>Change Username</h3>
                        <p style="margin-bottom: 1rem; font-size: 0.9em; opacity: 0.8;">Changing your username will also update how you log in.</p>
                        <div class="form-group">
                            <label for="update-username-input">New Username</label>
                            <input type="text" id="update-username-input" required minlength="3" maxlength="15">
                        </div>
                        <button type="submit" class="btn modal-submit-btn">Update Username</button>
                        <p class="error-message" id="update-username-error"></p>
                        <p class="success-message" id="update-username-success"></p>
                    </div>
                </form>

                <form id="update-email-form" class="auth-form" style="margin-top: 2rem;">
                     <div class="settings-group">
                        <h3>Change Email</h3>
                         <p style="margin-bottom: 1rem; font-size: 0.9em; opacity: 0.8;">You will be asked to confirm your current password again.</p>
                        <div class="form-group">
                            <label for="update-email-password">Current Password</label>
                            <input type="password" id="update-email-password" required>
                        </div>
                        <div class="form-group">
                            <label for="update-email-input">New Email</label>
                            <input type="email" id="update-email-input" required>
                        </div>
                        <button type="submit" class="btn modal-submit-btn">Update Email</button>
                        <p class="error-message" id="update-email-error"></p>
                        <p class="success-message" id="update-email-success"></p>
                    </div>
                </form>

                <form id="update-password-form" class="auth-form" style="margin-top: 2rem;">
                    <div class="settings-group">
                        <h3>Change Password</h3>
                        <div class="form-group">
                            <label for="update-password-input">New Password</label>
                            <input type="password" id="update-password-input" required>
                        </div>
                        <button type="submit" class="btn modal-submit-btn">Update Password</button>
                        <p class="error-message" id="update-password-error"></p>
                        <p class="success-message" id="update-password-success"></p>
                    </div>
                </form>
                
                <div class="settings-group">
                    <h3>Delete Account</h3>
                    <p style="margin-bottom: 1rem; font-size: 0.9em; opacity: 0.8;">This is permanent and cannot be undone. All your data will be erased.</p>
                    <button type="button" id="delete-account-btn" class="btn" style="width: 100%; background-color: var(--accent-red); color: var(--text-on-accent); --shadow-color: var(--shadow-dark);">Delete My Account</button>
                </div>
            </div>
            <div class="modal-actions">
                 <button type="button" class="btn" data-close-modal="manage-account-modal">Close</button>
            </div>
        </div>
    </div>
    
    <div id="google-signin-loader-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 300px; text-align: center;">
            <h2 style="font-size: 1.5rem;">Connecting...</h2>
            <div class="loader-box" style="margin: 2rem auto;"></div>
            <p>Please complete the sign-in in the popup window.</p>
        </div>
    </div>

    <div id="username-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Choose your Username</h2>
            <p style="margin-bottom: 1.5rem;">This will be your unique name. It cannot be changed later!</p>
            <form id="username-form">
                <input type="text" id="new-username-input" placeholder="e.g., QuestMaster" required minlength="3" maxlength="15">
                <p class="error-message username-error"></p>
                <div class="modal-actions" style="justify-content: flex-end;">
                    <button type="submit" class="btn modal-submit-btn">Save Username</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="timer-menu-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;">
            <h2>Active Timer</h2><p style="margin-bottom: 1.5rem;">This quest has a timer running.</p>
            <div class="modal-actions" style="justify-content: space-around;">
                <button type="button" id="timer-menu-cancel-btn" class="btn">Cancel Timer</button>
                <button type="button" class="btn" data-close-modal="timer-menu-modal">Leave</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-title">Are you sure?</h2>
            <p id="confirm-text" style="margin-bottom: 1.5rem;">This action cannot be undone.</p>
            <div class="modal-actions">
                <button type="button" id="confirm-cancel-btn" class="btn">Cancel</button>
                <button type="submit" id="confirm-action-btn" class="btn modal-submit-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Template for Auth Forms -->
    <template id="account-modal-content">
        <div class="form-toggle">
            <button class="toggle-btn active" data-tab="signup">Sign Up</button>
            <button class="toggle-btn" data-tab="login">Login</button>
        </div>
        <form class="auth-form" data-form="signup">
            <div class="form-group"><label for="signup-username">Username</label><input type="text" class="signup-username" required minlength="3" maxlength="15"></div>
            <div class="form-group"><label for="signup-email">Email</label><input type="email" class="signup-email" required></div>
            <div class="form-group"><label for="signup-password">Password</label><input type="password" class="signup-password" required></div>
            <button type="submit" class="btn modal-submit-btn" style="width: 100%;">Create Account</button>
            <p class="error-message signup-error"></p>
        </form>
        <form class="auth-form" data-form="login" style="display: none;">
             <div class="form-group"><label for="login-email">Email or Username</label><input type="text" class="login-email" required></div>
             <div class="form-group"><label for="login-password">Password</label><input type="password" class="login-password" required></div>
             <button type="submit" class="btn modal-submit-btn" style="width: 100%;">Login</button>
             <p class="error-message login-error"></p>
             <div class="form-divider">OR</div>
             <div class="google-signin-btn-container"></div>
        </form>
    </template>

    <script type="module">
        // --- NOTE ON SECURITY ---
        // All client-side code (like this script) is visible in the browser.
        // Your Firebase config is meant to be public. True security is enforced 
        // by your Firestore Security Rules in the Firebase console, not by hiding code.
        
        // --- FIREBASE SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOKGyzZ984TpHBrrgpOvlHKFJlDngGOSM",
            authDomain: "procrastinope.firebaseapp.com",
            projectId: "procrastinope",
            storageBucket: "procrastinope.appspot.com",
            messagingSenderId: "513129540063",
            appId: "1:513129540063:web:5fa30d80d41aa121bffc6a",
            measurementId: "G-5PJTMZFS2C"
        };

        let app, auth, db;
        let currentUser = null;
        let unsubscribeFromFirestore = null;
        // IMPORT: Listener for friend requests
        let unsubscribeFromFriends = null;
        let appController = null;
        
        // --- GLOBAL VARIABLES AND HELPER FUNCTIONS ---
        // Moved from inside initializeAppLogic and other functions to module scope
        let activeMobileActionsItem = null; 
        let actionsTimeoutId = null;
        // Initialize settings here, it will be overwritten by loaded data
        let settings = { theme: 'system', accentColor: 'var(--accent-red)', volume: 0.3 }; 

        // DOM Elements (declared globally for access by various functions)
        const appWrapper = document.getElementById('app-wrapper');
        const loaderOverlay = document.getElementById('loader-overlay');
        const landingPage = document.getElementById('landing-page');
        const landingChoices = document.getElementById('landing-choices');
        const landingAuthContainer = document.getElementById('landing-auth-container');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmText = document.getElementById('confirm-text');

        // Audio context
        const audioCtx = window.AudioContext ? new AudioContext() : null;

        // --- Sound Playing Function ---
        function playSound(type) {
            if (!audioCtx || settings.volume === 0) return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            let v = settings.volume, d = 0.2;
            switch (type) {
                case 'complete': o.type = 'sine'; o.frequency.setValueAtTime(440, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.2); break;
                case 'levelUp': o.type = 'sawtooth'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.4); d = 0.4; v *= 1.2; break;
                case 'timerUp': o.type = 'square'; o.frequency.setValueAtTime(880, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(440, audioCtx.currentTime + 0.5); d = 0.5; break;
                case 'add': case 'addGroup': o.type = 'triangle'; o.frequency.setValueAtTime(300, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1); d = 0.15; break;
                case 'delete': o.type = 'square'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); break;
                case 'hover': o.type = 'sine'; o.frequency.setValueAtTime(800, audioCtx.currentTime); v *= 0.2; d = 0.05; break;
                case 'toggle': o.type = 'sawtooth'; o.frequency.setValueAtTime(200, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(400, audioCtx.currentTime + 0.1); d = 0.1; break;
                case 'open': o.type = 'triangle'; o.frequency.setValueAtTime(250, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(500, audioCtx.currentTime + 0.1); break;
                case 'close': o.type = 'triangle'; o.frequency.setValueAtTime(500, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(250, audioCtx.currentTime + 0.1); break;
            }
            g.gain.setValueAtTime(0, audioCtx.currentTime); g.gain.linearRampToValueAtTime(v, audioCtx.currentTime + 0.01);
            o.start(audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d);
        }

        // --- Modal Control Functions ---
        // Moved to top level to be accessible by setupAuthForms
        let openModal, closeModal; 

        openModal = (modal) => {
            if(modal) {
                if (activeMobileActionsItem) {
                    activeMobileActionsItem.classList.remove('actions-visible');
                    activeMobileActionsItem = null;
                }
                if (appWrapper) appWrapper.classList.add('blur-background');
                modal.classList.add('visible');
                playSound('open');
            }
        };
        closeModal = (modal) => {
            if(modal) {
                if (appWrapper) appWrapper.classList.remove('blur-background');
                modal.classList.remove('visible');
                playSound('close');
            }
        };

        // --- Authentication Form Setup ---
        // Moved to top level and will be called by showAuthFormsOnLanding
        function setupAuthForms(container, onAuthSuccess) {
            container.innerHTML = ''; // Clear previous content
            const template = document.getElementById('account-modal-content');
            const content = template.content.cloneNode(true);
            container.appendChild(content);

            const toggleBtns = container.querySelectorAll('.toggle-btn');
            const signupForm = container.querySelector('[data-form="signup"]');
            const loginForm = container.querySelector('[data-form="login"]');
            const googleBtnContainer = container.querySelector('.google-signin-btn-container');

            // Create and append Google Sign-In button
            const googleBtn = document.createElement('button');
            googleBtn.type = 'button'; // Prevent form submission
            googleBtn.className = 'google-btn-custom';
            googleBtn.innerHTML = `<svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 6.93l3.66 2.84c.87-2.6 3.3-4.39 6.16-4.39z"/><path fill="none" d="M1 1h22v22H1z"/></svg><span>Sign in with Google</span>`;
            if(googleBtnContainer) googleBtnContainer.appendChild(googleBtn);
            
            // Toggle between login and signup forms
            toggleBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    toggleBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const showSignup = btn.dataset.tab === 'signup';
                    signupForm.style.display = showSignup ? 'block' : 'none';
                    loginForm.style.display = showSignup ? 'none' : 'block';
                });
            });

            // Handle sign-up
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = signupForm.querySelector('.signup-username').value.trim().toLowerCase();
                const email = signupForm.querySelector('.signup-email').value;
                const password = signupForm.querySelector('.signup-password').value;
                const errorEl = signupForm.querySelector('.signup-error');
                errorEl.textContent = '';

                try {
                    // Check if username is taken
                    const usernamesRef = window.firebaseSDK.doc(db, "usernames", username);
                    const usernameSnap = await window.firebaseSDK.getDoc(usernamesRef);
                    if (usernameSnap.exists()) {
                        throw new Error('This username is already taken.');
                    }

                    const userCredential = await window.firebaseSDK.createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Save username in Firestore
                    const batch = window.firebaseSDK.writeBatch(db);
                    batch.set(usernamesRef, { userId: user.uid });
                    const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                    batch.set(userDocRef, { username, email, friends: [], friendRequests: [] }); // Initialize friends/requests
                    await batch.commit();

                    onAuthSuccess(); // Trigger auth success callback (which will eventually lead to app initialization)
                } catch (error) {
                    errorEl.textContent = getCoolErrorMessage(error);
                }
            });

            // Handle login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const emailOrUsername = loginForm.querySelector('.login-email').value;
                const password = loginForm.querySelector('.login-password').value;
                const errorEl = loginForm.querySelector('.login-error');
                errorEl.textContent = '';
                
                try {
                    let emailToLogin = emailOrUsername;
                    // If input doesn't look like an email, try to resolve it as a username
                    if (!emailOrUsername.includes('@') && emailOrUsername.length > 0) {
                        const usernamesRef = window.firebaseSDK.doc(db, "usernames", emailOrUsername.toLowerCase());
                        const usernameSnap = await window.firebaseSDK.getDoc(usernamesRef);
                        if (usernameSnap.exists()) {
                            const targetUserId = usernameSnap.data().userId;
                            const userDocRef = window.firebaseSDK.doc(db, "users", targetUserId);
                            const userDocSnap = await window.firebaseSDK.getDoc(userDocRef);
                            if(userDocSnap.exists() && userDocSnap.data().email) {
                               emailToLogin = userDocSnap.data().email;
                            } else { throw new Error("User data not found for this username."); }
                        } else { 
                            // If username not found, still try to treat input as email
                            // or let the Firebase auth error handle 'user-not-found'
                            // This condition ensures we don't throw an error prematurely if it IS an email
                            if (emailOrUsername.includes('@')) {
                                emailToLogin = emailOrUsername;
                            } else {
                                // If it's not an email and username lookup failed, throw user-not-found
                                throw { code: 'auth/user-not-found', message: 'User not found.' };
                            }
                        }
                    }
                    await window.firebaseSDK.signInWithEmailAndPassword(auth, emailToLogin, password);
                    onAuthSuccess(); // Trigger auth success callback
                } catch (error) {
                    errorEl.textContent = getCoolErrorMessage(error);
                }
            });

            // Handle Google Sign-In
            if(googleBtn) {
                googleBtn.addEventListener('click', async () => {
                    const provider = new window.firebaseSDK.GoogleAuthProvider();
                    const googleLoader = document.getElementById('google-signin-loader-modal');
                    try {
                        openModal(googleLoader); // Use top-level openModal
                        await window.firebaseSDK.signInWithPopup(auth, provider);
                        // onAuthStateChanged will handle the rest, but calling onAuthSuccess ensures immediate UI update if needed.
                        onAuthSuccess(); 
                    } catch (error) {
                        console.error("Google Sign-In Error: ", getCoolErrorMessage(error));
                        const errorEl = loginForm.querySelector('.login-error'); // Show error in the login form context
                        errorEl.textContent = getCoolErrorMessage(error);
                    } finally {
                        closeModal(googleLoader); // Use top-level closeModal
                    }
                });
            }
        }
        
        // --- Landing Page Logic ---
        function showLandingPage() {
            landingAuthContainer.style.display = 'none';
            landingChoices.style.display = 'block';
        }
        
        document.getElementById('landing-guest-btn').addEventListener('click', async () => {
            sessionStorage.setItem('isGuest', 'true');
            loaderOverlay.style.display = 'flex';
            if (!appController) {
                appController = await initializeAppLogic(null); // Initialize with null user for guest
            }
            landingPage.style.display = 'none';
            appWrapper.style.display = 'block';
            loaderOverlay.style.display = 'none';
        });

        document.getElementById('landing-login-btn').addEventListener('click', () => {
            showAuthFormsOnLanding('login');
        });

        // Modified to call the top-level setupAuthForms
        function showAuthFormsOnLanding(initialTab) {
            landingChoices.style.display = 'none';
            landingAuthContainer.style.display = 'block';
            
            const onAuthSuccess = () => {
                // The onAuthStateChanged listener will handle redirection automatically.
                // No need to manually open modals or change displays here for auth success.
            };
            
            // Call the globally defined setupAuthForms
            setupAuthForms(landingAuthContainer, onAuthSuccess);
            
            // Activate the correct tab
            landingAuthContainer.querySelector(`.toggle-btn[data-tab="${initialTab}"]`).click();
            
            // Add back button if it doesn't exist
            if (!landingAuthContainer.querySelector('#landing-back-btn')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'landing-back-btn';
                backBtn.className = 'btn';
                backBtn.textContent = 'Back';
                backBtn.onclick = showLandingPage; // Navigate back to initial choices
                landingAuthContainer.appendChild(backBtn);
            }
        }
        
        // --- Main Application Logic ---
        // Initialize appController after Firebase is ready and auth state is checked.
        async function initializeAppLogic(initialUser) {

            // FIX: Helper function to only focus on non-touch devices to prevent mobile keyboard auto-opening
            const focusOnDesktop = (el) => {
                if (!window.matchMedia('(pointer: coarse)').matches && el) {
                    el.focus();
                }
            };

            // --- Core App State Variables ---
            let user = initialUser; // Current logged-in user or null (for guests)
            // Settings are now declared globally at the top for consistency.
            // let settings = { theme: 'system', accentColor: 'var(--accent-red)', volume: 0.3 }; 
            
            let dailyTasks = [], standaloneMainQuests = [], generalTaskGroups = [];
            let playerData = { level: 1, xp: 0 };
            let currentListToAdd = null, currentEditingTaskId = null;
            const activeTimers = {};
            
            // Get DOM elements needed by app logic
            const dailyTaskListContainer = document.getElementById('daily-task-list');
            const standaloneTaskListContainer = document.getElementById('standalone-task-list');
            const generalTaskListContainer = document.getElementById('general-task-list-container');
            const playerLevelEl = document.getElementById('player-level');
            const xpBarEl = document.getElementById('xp-bar');
            const xpTextEl = document.getElementById('xp-text');
            const levelDisplayEl = document.querySelector('.level-display');
            const addTaskTriggerBtnDaily = document.querySelector('.add-task-trigger-btn[data-list="daily"]');
            const addStandaloneTaskBtn = document.getElementById('add-standalone-task-btn');
            const addGroupBtn = document.getElementById('add-group-btn');
            
            const addTaskModal = document.getElementById('add-task-modal');
            const addTaskModalTitle = document.getElementById('add-task-modal-title');
            const addTaskForm = document.getElementById('add-task-form');
            const newTaskInput = document.getElementById('new-task-input');
            
            const editTaskModal = document.getElementById('edit-task-modal');
            const editTaskForm = document.getElementById('edit-task-form');
            const editTaskInput = document.getElementById('edit-task-input');
            const editTaskIdInput = document.getElementById('edit-task-id');
            const editWeeklyGoalContainer = document.getElementById('edit-weekly-goal-container');

            const weeklyGoalContainer = document.getElementById('weekly-goal-container');
            const weeklyGoalSlider = document.getElementById('new-task-weekly-goal-slider');
            const weeklyGoalDisplay = document.getElementById('new-task-weekly-goal-display');
            const editWeeklyGoalSlider = document.getElementById('edit-task-weekly-goal-slider');
            const editWeeklyGoalDisplay = document.getElementById('edit-task-weekly-goal-display');

            const addGroupModal = document.getElementById('add-group-modal');
            const addGroupForm = document.getElementById('add-group-form');
            const newGroupInput = document.getElementById('new-group-input');
            const timerModal = document.getElementById('timer-modal');
            const timerForm = document.getElementById('timer-form');
            const timerDurationSlider = document.getElementById('timer-duration-slider');
            const timerDurationDisplay = document.getElementById('timer-duration-display');
            const timerUnitSelector = document.querySelector('.timer-unit-selector');
            const timerMenuModal = document.getElementById('timer-menu-modal');
            const timerMenuCancelBtn = document.getElementById('timer-menu-cancel-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const themeOptionsButtons = document.getElementById('theme-options-buttons');
            const colorOptions = document.getElementById('color-options');
            const volumeSlider = document.getElementById('volume-slider');
            const resetProgressBtn = document.getElementById('reset-progress-btn');
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');
            const dataManagementHeading = document.getElementById('data-management-heading');
            const settingsLoginBtn = document.getElementById('settings-login-btn');
            const manageAccountBtn = document.getElementById('manage-account-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');
            const accountModal = document.getElementById('account-modal');
            const manageAccountModal = document.getElementById('manage-account-modal');
            // confirmModal elements are declared globally
            const noDailyTasksMessage = document.getElementById('no-daily-tasks-message');
            const noGeneralTasksMessage = document.getElementById('no-general-tasks-message');
            const quoteEl = document.getElementById('quote-of-the-day');
            let confirmCallback = null;
            
            // IMPORT: Friends feature DOM elements
            const friendsBtnDesktop = document.getElementById('friends-btn-desktop');
            const friendsModal = document.getElementById('friends-modal');
            const mobileNav = document.getElementById('mobile-nav');
            const addFriendForm = document.getElementById('add-friend-form');
            const searchUsernameInput = document.getElementById('search-username-input');
            const friendStatusMessage = friendsModal.querySelector('.friend-status-message');
            const friendRequestCountBadge = document.getElementById('friend-request-count');
            const friendsListContainer = friendsModal.querySelector('.friends-list-container');
            const friendRequestsContainer = friendsModal.querySelector('.friend-requests-container');
            const deleteAccountBtn = document.getElementById('delete-account-btn');

            // --- MODAL OPEN/CLOSE (using global functions now) ---
            // `openModal` and `closeModal` are already defined globally.
            // `playSound` is also global.

            async function promptForUsernameIfNeeded() {
                if (!user) return; // Only for logged-in users

                const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                const docSnap = await window.firebaseSDK.getDoc(userDocRef);
                const existingData = docSnap.exists() ? docSnap.data().appData : null;
                
                // Only prompt if username is missing and it wasn't a direct email/password signup that already provided one.
                // If it's an email/password user, `createUserWithEmailAndPassword` in `setupAuthForms` already sets their username.
                const isEmailUser = user.providerData.some(p => p.providerId === 'password');

                if (!docSnap.exists() || !docSnap.data().username) {
                    const usernameModal = document.getElementById('username-modal');
                    const usernameForm = document.getElementById('username-form');
                    const newUsernameInput = document.getElementById('new-username-input');
                    const usernameErrorEl = usernameModal.querySelector('.username-error');
                    
                    usernameModal.setAttribute('data-persistent', 'true'); // Prevent closing by clicking outside

                    openModal(usernameModal);
                    focusOnDesktop(newUsernameInput);

                    return new Promise((resolve) => {
                        usernameForm.onsubmit = async (e) => {
                            e.preventDefault();
                            usernameErrorEl.textContent = '';
                            const username = newUsernameInput.value.trim().toLowerCase();
                            if (!username || username.length < 3) {
                                usernameErrorEl.textContent = 'Username must be at least 3 characters.';
                                return;
                            }

                            const submitButton = usernameForm.querySelector('button[type="submit"]');
                            submitButton.disabled = true;
                            submitButton.textContent = 'Saving...';
                            
                            try {
                                const usernamesRef = window.firebaseSDK.doc(db, "usernames", username);
                                const usernameSnap = await window.firebaseSDK.getDoc(usernamesRef);

                                if (usernameSnap.exists()) {
                                    throw new Error('This username is already taken.');
                                }

                                const batch = window.firebaseSDK.writeBatch(db);
                                batch.set(usernamesRef, { userId: user.uid });
                                batch.set(userDocRef, { 
                                    username: username, 
                                    email: user.email, // Ensure email is set if not already
                                    appData: existingData || {}, // Preserve existing data if any
                                    friends: [], // Initialize friends list
                                    friendRequests: [] // Initialize friend requests list
                                }, { merge: true });
                                await batch.commit();
                                
                                usernameModal.removeAttribute('data-persistent'); // Allow closing now
                                closeModal(usernameModal);
                                resolve(); // Resolve the promise, indicating username is set

                            } catch (error) {
                                usernameErrorEl.textContent = error.message || getCoolErrorMessage(error);
                            } finally {
                                submitButton.disabled = false;
                                submitButton.textContent = 'Save Username';
                            }
                        };
                    });
                }
                resolve(); // Resolve immediately if username is already set
            }
            
            // =========================================================================
            // DATA PERSISTENCE & OPTIMIZATION
            // =========================================================================

            /**
             * Debounce function to delay execution. This is a core optimization strategy
             * to reduce the number of writes to Firestore by grouping multiple rapid
             * changes into a single save operation.
             * @param {Function} func The function to debounce.
             * @param {number} delay The delay in milliseconds.
             * @returns {Function} The new debounced function.
             */
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), delay);
                };
            }

            // This is the actual function that writes data to localStorage or Firestore.
            async function saveData(data) {
                // Also save theme to a simple key for faster pre-load on app start
                if (data.settings && data.settings.theme) {
                    localStorage.setItem('userTheme', data.settings.theme);
                }

                if (!user) { // For guests, save to local storage
                    localStorage.setItem('anonymousUserData', JSON.stringify(data));
                    return;
                }
                
                // For logged-in users, save to Firestore
                try {
                    const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                    await window.firebaseSDK.setDoc(userDocRef, { appData: data }, { merge: true });
                } catch (error) { 
                    console.error("Error saving data to Firestore: ", getCoolErrorMessage(error)); 
                }
            }
            
            // Create a debounced version of the saveData function.
            // It will wait 1500ms (1.5 seconds) after the last action before saving to Firestore.
            const debouncedSaveData = debounce(saveData, 1500);

            // This function is called after any state change in the application.
            const saveState = () => {
                const data = { dailyTasks, standaloneMainQuests, generalTaskGroups, playerData, settings };
                
                // OPTIMIZATION:
                // - For guests, save instantly to localStorage (it's free and fast).
                // - For logged-in users, use the debounced function to avoid excessive Firestore writes.
                if (!user) {
                    saveData(data);
                } else {
                    debouncedSaveData(data);
                }
            };
            
            // =========================================================================
            // END OF DATA PERSISTENCE & OPTIMIZATION
            // =========================================================================


            function loadAndDisplayData(data) {
                dailyTasks = data.dailyTasks || [];
                standaloneMainQuests = data.standaloneMainQuests || [];
                generalTaskGroups = data.generalTaskGroups || [];
                playerData = data.playerData || { level: 1, xp: 0 };
                // Overwrite the default settings with loaded data, ensure all keys are present
                settings = { 
                    theme: data.settings?.theme || 'system', 
                    accentColor: data.settings?.accentColor || 'var(--accent-red)',
                    volume: data.settings?.volume === undefined ? 0.3 : data.settings.volume // Explicitly check for undefined for volume
                }; 
                
                // Ensure groups have an isExpanded property
                generalTaskGroups.forEach(group => {
                    if (typeof group.isExpanded === 'undefined') group.isExpanded = false;
                });
                applySettings(); // Apply loaded settings immediately
                renderAllLists();
                updateProgressUI();
            }

            async function initialLoad() {
                return new Promise((resolve) => {
                    if (!user) { // Guest user
                        const localData = JSON.parse(localStorage.getItem('anonymousUserData')) || {};
                        loadAndDisplayData(localData);
                        resolve();
                        return;
                    }
                    
                    // Logged-in user
                    // IMPORT: Listen for friend requests in real-time
                    listenForFriendRequests();

                    const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                    let isFirstLoad = true;
                    unsubscribeFromFirestore = window.firebaseSDK.onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists() && docSnap.data().appData) {
                            loadAndDisplayData(docSnap.data().appData);
                        } else {
                            loadAndDisplayData({}); // Load empty state for new user
                        }
                        if (isFirstLoad) {
                            isFirstLoad = false;
                            resolve();
                        }
                    }, (error) => {
                        console.error("Error listening to Firestore:", getCoolErrorMessage(error));
                        if (isFirstLoad) {
                             isFirstLoad = false;
                             resolve(); // Resolve even on error to allow app to load
                        }
                    });
                });
            }

            async function updateUserUI() {
                if (user) { // Logged in state
                    settingsLoginBtn.style.display = 'none';
                    logoutBtn.style.display = 'inline-flex';
                    manageAccountBtn.style.display = 'inline-flex'; // Show manage account for both password and Google users

                    const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                    const docSnap = await window.firebaseSDK.getDoc(userDocRef);
                    // Use username if available, otherwise fall back to email or a placeholder
                    const username = docSnap.exists() && docSnap.data().username ? docSnap.data().username : (user.email || 'User');

                    userDisplay.textContent = `Logged in as: ${username}`;
                    userDisplay.style.display = 'flex';
                    dataManagementHeading.textContent = "Cloud Data";
                    exportDataBtn.style.display = 'none';
                    importDataBtn.style.display = 'none';
                    resetProgressBtn.textContent = 'Reset Cloud Data';
                    
                    // IMPORT: Show friends buttons for logged-in users
                    friendsBtnDesktop.style.display = 'flex';
                    mobileNav.querySelector('[data-section="friends"]').style.display = 'flex';

                } else { // Guest or logged out state
                    settingsLoginBtn.style.display = 'inline-flex';
                    logoutBtn.style.display = 'none';
                    manageAccountBtn.style.display = 'none';
                    userDisplay.textContent = 'Playing as Guest';
                    userDisplay.style.display = 'flex';
                    dataManagementHeading.textContent = "Guest Data (Local)";
                    exportDataBtn.style.display = 'inline-flex';
                    importDataBtn.style.display = 'inline-flex';
                    resetProgressBtn.textContent = 'Reset Progress';
                    
                    // IMPORT: Hide friends buttons for guests
                    friendsBtnDesktop.style.display = 'none';
                    mobileNav.querySelector('[data-section="friends"]').style.display = 'none';
                }
            }
            const XP_PER_TASK = 35;
            const XP_PER_TIMER_MINUTE = 2;
            const getXpForNextLevel = (level) => 50 + (level * 50);
            const quotes = ["The secret of getting ahead is getting started.", "A year from now you may wish you had started today.", "The future depends on what you do today.", "The best way to predict the future is to create it.", "Don't watch the clock; do what it does. Keep going."];
            function showRandomQuote() { quoteEl.textContent = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`; }
            function getStartOfWeek(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday is day 1, Sunday is day 0 (becomes day 1 of next week in some locales, but this correctly shifts it back to Monday)
                return new Date(d.setDate(diff)).setHours(0, 0, 0, 0);
            }
            const checkDailyReset = () => {
                const today = new Date().toDateString();
                const lastVisit = localStorage.getItem('lastVisitDate');
                if (today !== lastVisit) {
                    // Reset streaks for dailies
                    dailyTasks.forEach(task => {
                        // If yesterday was the last completion day and streak is active, increment. Otherwise, reset.
                        if (task.completedToday && task.lastCompleted === new Date(Date.now() - 86400000).toDateString()) {
                            task.streak = (task.streak || 0) + 1;
                        } else if (!task.completedToday) { // If it wasn't completed today, reset streak
                            task.streak = 0;
                        }
                        task.completedToday = false; // Reset daily completion status
                        // Reset weekly completions if a new week has started
                        if (task.weeklyGoal > 0) {
                             const now = new Date();
                             if (task.weekStartDate === undefined || task.weekStartDate < getStartOfWeek(now)) {
                                task.weekStartDate = getStartOfWeek(now);
                                task.weeklyCompletions = 0;
                             }
                        }
                    });
                    localStorage.setItem('lastVisitDate', today);
                    saveState();
                }
            };
            function addXp(amount) {
                if (!amount || amount === 0) return;
                playerData.xp += Math.round(amount);
                if (playerData.xp < 0) playerData.xp = 0;
                const requiredXp = getXpForNextLevel(playerData.level);
                if (playerData.xp >= requiredXp) levelUp(requiredXp);
                updateProgressUI();
            }
            function levelUp(requiredXp) {
                playerData.level++;
                playerData.xp -= requiredXp;
                playSound('levelUp');
                levelDisplayEl.classList.add('level-up');
                // Remove class after animation
                levelDisplayEl.addEventListener('animationend', () => levelDisplayEl.classList.remove('level-up'), { once: true });
                
                const newRequiredXp = getXpForNextLevel(playerData.level);
                if (playerData.xp >= newRequiredXp) levelUp(newRequiredXp); // Handle multiple level ups
            }
            function updateProgressUI() {
                const requiredXp = getXpForNextLevel(playerData.level);
                const progressPercent = Math.min((playerData.xp / requiredXp) * 100, 100);
                playerLevelEl.textContent = playerData.level;
                xpTextEl.textContent = `${Math.floor(playerData.xp)} / ${requiredXp} XP`;
                xpBarEl.style.width = `${progressPercent}%`;
            }
            function checkOverdueTasks() {
                const now = Date.now();
                // Iterate through all tasks from all lists
                [...dailyTasks, ...standaloneMainQuests, ...generalTaskGroups.flatMap(g => g.tasks || [])].forEach(task => {
                    const taskEl = document.querySelector(`.task-item[data-id="${task.id}"]`);
                    // Only mark as overdue if not completed today and if it's an old task
                    if (taskEl && !task.completedToday && (now - task.createdAt) > 86400000) { 
                        taskEl.classList.add('overdue');
                    } else if (taskEl) {
                        taskEl.classList.remove('overdue'); // Ensure it's removed if conditions are no longer met
                    }
                });
            }
            function checkAllTasksCompleted() {
                const allDailiesDone = dailyTasks.length > 0 && dailyTasks.every(t => t.completedToday);
                const noStandaloneQuests = standaloneMainQuests.length === 0;
                const noGroupedQuests = generalTaskGroups.every(g => !g.tasks || g.tasks.length === 0);
                return { allDailiesDone, allTasksDone: allDailiesDone && noStandaloneQuests && noGroupedQuests };
            }
            
            const renderDailyTasks = () => { dailyTaskListContainer.innerHTML = ''; noDailyTasksMessage.style.display = dailyTasks.length === 0 ? 'block' : 'none'; dailyTasks.forEach(task => dailyTaskListContainer.appendChild(createTaskElement(task, 'daily'))); };
            const renderStandaloneTasks = () => { standaloneTaskListContainer.innerHTML = ''; standaloneMainQuests.forEach(task => standaloneTaskListContainer.appendChild(createTaskElement(task, 'standalone'))); };
            const renderGeneralTasks = () => { generalTaskListContainer.innerHTML = ''; generalTaskGroups.forEach(group => generalTaskListContainer.appendChild(createGroupElement(group))); noGeneralTasksMessage.style.display = (standaloneMainQuests.length === 0 && generalTaskGroups.length === 0) ? 'block' : 'none'; };
            const createGroupElement = (group) => {
                const el = document.createElement('div'); el.className = 'main-quest-group'; if (group.isExpanded) el.classList.add('expanded'); el.dataset.groupId = group.id;
                el.innerHTML = `<header class="main-quest-group-header"><div class="group-title-container"><svg class="expand-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg><h3>${group.name}</h3></div><div class="group-actions"><button class="btn icon-btn edit-group-btn" aria-label="Edit group name"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button><button class="btn icon-btn delete-group-btn" aria-label="Delete group"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button><button class="btn add-task-to-group-btn" aria-label="Add task">+</button></div></header><ul class="task-list-group" data-group-id="${group.id}"></ul>`;
                const ul = el.querySelector('ul'); if (group.tasks) group.tasks.forEach(task => ul.appendChild(createTaskElement(task, 'group'))); return el;
            };
            const createTaskElement = (task, type) => {
                const li = document.createElement('li'); li.className = 'task-item'; li.dataset.id = task.id; if (type === 'standalone') li.classList.add('standalone-quest');
                let streakHTML = ''; if (type === 'daily' && task.streak > 0) streakHTML = `<div class="streak-counter" title="Streak: ${task.streak}"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.653 9.473c.071.321.11.65.11.986 0 2.21-1.791 4-4 4s-4-1.79-4-4c0-.336.039-.665.11-.986C7.333 11.23 6 14.331 6 18h12c0-3.669-1.333-6.77-3.347-8.527zM12 2C9.239 2 7 4.239 7 7c0 .961.261 1.861.713 2.638C9.223 8.36 10.55 7.5 12 7.5s2.777.86 4.287 2.138C17 8.861 17 7.961 17 7c0-2.761-2.239-5-5-5z"/></svg><span>${task.streak}</span></div>`;
                let goalHTML = ''; if (type === 'daily' && task.weeklyGoal > 0) { goalHTML = `<div class="weekly-goal-tag" title="Weekly goal"><span>${task.weeklyCompletions}/${task.weeklyGoal}</span></div>`; if (task.weeklyCompletions >= task.weeklyGoal) li.classList.add('weekly-goal-met'); }
                
                // Timer progress ring calculation
                let timerProgressOffset = '';
                if (task.timerStartTime && task.timerDuration) {
                    const elapsed = (Date.now() - task.timerStartTime) / 1000;
                    const remainingSeconds = Math.max(0, task.timerDuration - elapsed);
                    const r = 10; // radius of progress ring circle
                    const c = r * 2 * Math.PI; // circumference
                    const p = remainingSeconds > 0 ? remainingSeconds / task.timerDuration : 0; // progress percentage
                    const offset = c - (p * c);
                    timerProgressOffset = `stroke-dashoffset: ${offset};`;
                }

                li.innerHTML = `<button class="complete-btn"></button>
                    <div class="task-content">${streakHTML}<span class="task-text">${task.text}</span>${goalHTML}</div>
                    <div class="task-buttons-wrapper">
                        <button class="btn icon-btn timer-clock-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><svg class="progress-ring" viewBox="0 0 24 24"><circle class="progress-ring-circle" r="10" cx="12" cy="12" style="${timerProgressOffset}"></circle></svg></button>
                        <div class="task-actions">
                            <button class="btn icon-btn edit-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></button>
                            <button class="btn icon-btn delete-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button>
                        </div>
                    </div>`;
                if (task.completedToday) { li.classList.add('daily-completed'); li.querySelector('.complete-btn').classList.add('checked'); }
                if (task.timerFinished) li.classList.add('timer-finished');
                if (task.timerStartTime && task.timerDuration) {
                    li.classList.add('timer-active');
                }
                return li;
            };
            
            const addTask = (text, list, goal) => {
                const common = { id: Date.now().toString(), text, createdAt: Date.now() };
                if (list === 'daily') dailyTasks.push({ ...common, completedToday: false, lastCompleted: null, streak: 0, weeklyGoal: goal || 0, weeklyCompletions: 0, weekStartDate: getStartOfWeek(new Date()) });
                else if (list === 'standalone') standaloneMainQuests.push({ ...common });
                else { // Adding to a group
                    const g = generalTaskGroups.find(g => g.id === list); 
                    if (g) { 
                        if (!g.tasks) g.tasks = []; 
                        g.tasks.push({ ...common }); 
                    }
                }
                renderAllLists();
                saveState(); 
                playSound('add');
            };
            const addGroup = (name) => { 
                generalTaskGroups.push({ id: 'group_' + Date.now(), name, tasks: [], isExpanded: false }); 
                renderAllLists();
                saveState(); 
                playSound('addGroup'); 
            };
            const deleteGroup = (id) => { 
                const groupName = generalTaskGroups.find(g => g.id === id)?.name || 'this group'; 
                showConfirm(`Delete "${groupName}"?`, 'All tasks within this group will also be deleted.', () => { 
                    generalTaskGroups = generalTaskGroups.filter(g => g.id !== id); 
                    renderAllLists(); 
                    saveState(); 
                    playSound('delete'); 
                }); 
            };
            const findTaskAndContext = (id) => {
                let task = dailyTasks.find(t => t && t.id === id); if (task) return { task, list: dailyTasks, type: 'daily' };
                task = standaloneMainQuests.find(t => t && t.id === id); if(task) return { task, list: standaloneMainQuests, type: 'standalone'};
                for (const g of generalTaskGroups) { 
                    if (g && g.tasks) { 
                        const taskInGroup = g.tasks.find(t => t && t.id === id); 
                        if (taskInGroup) return { task: taskInGroup, list: g.tasks, group: g, type: 'group' }; 
                    } 
                } return {}; // Task not found
            };
            const deleteTask = (id) => { 
                stopTimer(id, false); // Stop timer if running, without re-rendering immediately
                const {list} = findTaskAndContext(id); 
                if (list) {
                    const i = list.findIndex(t => t.id === id); 
                    if(i > -1) list.splice(i, 1); 
                }
                renderAllLists(); // Re-render everything
                saveState(); 
                playSound('delete'); 
            };
            const completeTask = (id) => {
                stopTimer(id, false); // Stop timer if running
                const { task, type, list, group } = findTaskAndContext(id);
                if (!task) return;
                
                // Remove timer finished state if it was there
                if (task.timerFinished) delete task.timerFinished;
                
                addXp(XP_PER_TASK); 
                playSound('complete');
                
                if (type === 'daily') {
                    if(task.completedToday) return; // Already completed today
                    task.completedToday = true;
                    task.lastCompleted = new Date().toDateString();
                    if (task.weeklyGoal > 0) { 
                        const now = new Date();
                        // If today is a new week, reset weekly completions
                        if (task.weekStartDate === undefined || task.weekStartDate < getStartOfWeek(now)) {
                           task.weekStartDate = getStartOfWeek(now);
                           task.weeklyCompletions = 1; 
                        } else {
                           task.weeklyCompletions = (task.weeklyCompletions || 0) + 1; 
                        }
                    }
                } else { // For non-daily tasks (standalone or group)
                    createConfetti(document.querySelector(`.task-item[data-id="${id}"]`)); // Create confetti animation
                    
                    // Remove task from its list
                    if (list) { 
                        const i = list.findIndex(t => t.id === id); 
                        if(i > -1) list.splice(i, 1); 
                    }
                    // If the group is now empty, remove the group itself
                    if (group && (!group.tasks || group.tasks.length === 0)) { 
                        const groupIndex = generalTaskGroups.findIndex(g => g.id === group.id); 
                        if(groupIndex > -1) generalTaskGroups.splice(groupIndex, 1); 
                    }
                }
                
                saveState();
                renderAllLists(); // Re-render to show changes (completed status, removed task)

                // Check for celebratory completion
                const { allDailiesDone, allTasksDone } = checkAllTasksCompleted(); 
                if (allTasksDone) createFullScreenConfetti(true); // Full party mode
                else if (allDailiesDone) createFullScreenConfetti(false); // Smaller confetti for daily completion
            };
            const uncompleteDailyTask = (id) => { 
                const task = dailyTasks.find(t => t.id === id); 
                if (task && task.completedToday) { 
                    task.completedToday = false; 
                    if (task.weeklyGoal > 0 && task.lastCompleted === new Date().toDateString()) {
                        task.weeklyCompletions = Math.max(0, (task.weeklyCompletions || 0) - 1); // Decrement weekly goal count
                    }
                    addXp(-XP_PER_TASK); // Deduct XP
                    playSound('delete'); 
                    saveState(); 
                    renderAllLists(); 
                } 
            };
            const editTask = (id, text, goal) => {
                const { task, type } = findTaskAndContext(id);
                if (task) {
                    task.text = text;
                    if (type === 'daily') { // Weekly goal can only be set for daily tasks
                        task.weeklyGoal = goal || 0; // Ensure goal is a number, 0 if not specified
                        // If current completions exceed new goal, cap it.
                        if (task.weeklyCompletions > task.weeklyGoal) {
                             task.weeklyCompletions = task.weeklyGoal;
                        }
                    }
                    saveState();
                    renderAllLists();
                }
            };
            function finishTimer(id) {
                playSound('timerUp');
                stopTimer(id, false); // Stop interval without re-rendering immediately
                const { task } = findTaskAndContext(id);
                if (task) {
                    task.timerFinished = true; // Mark as finished
                    delete task.timerStartTime;
                    delete task.timerDuration;
                    saveState();
                    renderAllLists(); // Re-render to show the finished state
                }
            }
            function startTimer(id, mins) {
                stopTimer(id, false); // Stop any existing timer for this task
                const { task } = findTaskAndContext(id);
                if (!task) return;

                task.timerStartTime = Date.now();
                task.timerDuration = mins * 60; // Convert minutes to seconds
                delete task.timerFinished; // Remove finished state if present
                
                saveState();
                renderAllLists(); // Re-render to show timer active state and progress ring
            }
            function stopTimer(id, shouldRender = true) {
                // Clear the interval associated with this task ID
                if (activeTimers[id]) {
                    clearInterval(activeTimers[id]);
                    delete activeTimers[id];
                }
                const { task } = findTaskAndContext(id);
                if (task) {
                    delete task.timerStartTime;
                    delete task.timerDuration;
                    if (shouldRender) { // Only re-render if requested
                        saveState();
                        renderAllLists();
                    }
                }
            }
            function resumeTimers() {
                // Clear any existing active timer intervals before setting new ones
                Object.keys(activeTimers).forEach(id => clearInterval(activeTimers[id]));
                activeTimers = {}; // Reset the map

                let needsSaveAndRender = false; // Flag to see if any timer state changed
                
                // Collect all tasks that have active timers
                const tasksWithTimers = [
                    ...dailyTasks.filter(t => t.timerStartTime && t.timerDuration),
                    ...standaloneMainQuests.filter(t => t.timerStartTime && t.timerDuration),
                    ...generalTaskGroups.flatMap(g => g.tasks || []).filter(t => t.timerStartTime && t.timerDuration)
                ];

                tasksWithTimers.forEach(t => {
                    const elapsed = (Date.now() - (t.timerStartTime || 0)) / 1000;
                    const remainingSeconds = Math.max(0, (t.timerDuration || 0) - elapsed);
                    
                    if (remainingSeconds > 0) {
                        // Set up the interval for this timer
                         activeTimers[t.id] = setInterval(() => {
                            const currentElapsed = (Date.now() - (t.timerStartTime || 0)) / 1000;
                            const currentRemaining = Math.max(0, (t.timerDuration || 0) - currentElapsed);
                            
                            const taskEl = document.querySelector(`.task-item[data-id="${t.id}"]`);
                            // If the element is gone or the timer was stopped, clear this interval
                            if (!taskEl || !activeTimers[t.id]) {
                                clearInterval(activeTimers[t.id]);
                                delete activeTimers[t.id];
                                return;
                            }

                            if (currentRemaining > 0) {
                                // Update progress ring visual
                                const ring = taskEl.querySelector('.progress-ring-circle');
                                if (ring) {
                                    const r = ring.r.baseVal.value;
                                    if (r > 0) {
                                        const c = r * 2 * Math.PI;
                                        const p = currentRemaining / t.timerDuration;
                                        ring.style.strokeDashoffset = c - (p * c);
                                    }
                                }
                            } else {
                                // Timer has reached zero, finish it
                                finishTimer(t.id); // finishTimer handles clearing interval and re-rendering
                            }
                        }, 1000); // Update every second
                    } else {
                        // If remainingSeconds is 0 or less, it means the timer already expired before resume was called.
                        // Mark it as finished and trigger a save/render.
                        if (!t.timerFinished) {
                            t.timerFinished = true;
                            delete t.timerStartTime;
                            delete t.timerDuration;
                            needsSaveAndRender = true;
                        }
                    }
                });
                
                // If any timers expired while the app was inactive, save and re-render.
                if (needsSaveAndRender) {
                    saveState();
                    renderAllLists();
                }
            }
            
            // Event listener for task interactions (completion, deletion, editing, timer)
            document.querySelector('.quests-layout').addEventListener('click', (e) => {
                const taskItem = e.target.closest('.task-item');
                const groupHeader = e.target.closest('.main-quest-group-header');

                // Handles showing/hiding action buttons on mobile when a task/group is tapped
                function handleMobileActions(element) {
                     if (window.innerWidth > 1023) return; // Only for mobile
                     // If a button within the actions menu was clicked, don't toggle visibility
                     if (e.target.closest('button')) { 
                         clearTimeout(actionsTimeoutId); // Clear timeout if an action was performed
                         return;
                     }
                     
                     clearTimeout(actionsTimeoutId); // Clear previous timeout
                     
                     // If another item is already showing actions, hide it
                     if (activeMobileActionsItem && activeMobileActionsItem !== element) {
                         activeMobileActionsItem.classList.remove('actions-visible');
                     }
                     
                     const wasVisible = element.classList.contains('actions-visible');
                     element.classList.toggle('actions-visible');
                     
                     if (!wasVisible) { // If actions are now visible
                         activeMobileActionsItem = element; // Set this as the active item
                         // Set a timeout to auto-hide actions after a few seconds
                         actionsTimeoutId = setTimeout(() => {
                             if(element.classList.contains('actions-visible')) { // Check if it's still visible
                                 element.classList.remove('actions-visible');
                                 activeMobileActionsItem = null; // Clear active item
                             }
                         }, 3000); // Hide after 3 seconds
                     } else { // If actions were just hidden by tapping again
                         activeMobileActionsItem = null; // Clear active item
                     }
                }
                
                if (groupHeader) { 
                    const groupId = groupHeader.parentElement.dataset.groupId;
                    const g = generalTaskGroups.find(g => g.id === groupId);

                    // If the expand icon was clicked, toggle group expansion and prevent opening actions menu
                    if (window.innerWidth <= 1023 && e.target.closest('.expand-icon')) {
                        if (g) g.isExpanded = !g.isExpanded; 
                        saveState(); 
                        renderAllLists();
                        return; // Stop propagation to prevent mobile actions menu from opening
                    }
                    
                    const isButton = e.target.closest('button');
                    if (isButton) {
                        if (e.target.closest('.add-task-to-group-btn')) { 
                            currentListToAdd = groupId; 
                            weeklyGoalContainer.style.display = 'none'; // Weekly goals are not for group tasks
                            addTaskModalTitle.textContent = `Add to "${g?.name || 'Group'}"`; 
                            openModal(addTaskModal); 
                            focusOnDesktop(newTaskInput); 
                        } 
                        else if (e.target.closest('.delete-group-btn')) { 
                            deleteGroup(groupId); 
                        }
                        // Edit group name functionality could be added here if needed.
                    } else { // If not a button, handle tap for mobile actions or desktop expansion
                         if (window.innerWidth <= 1023) { // On mobile, tap header to show actions
                             handleMobileActions(groupHeader);
                         } else { // On desktop, tap header to toggle expansion
                            if (g) g.isExpanded = !g.isExpanded; 
                            saveState(); 
                            renderAllLists();
                         }
                    }
                    return; // Prevent further processing if it's a group header interaction
                }

                // Handle task item interactions
                if (taskItem) {
                    const id = taskItem.dataset.id;
                    
                    // If task is already completed for today, tapping it will uncomplete it
                    if (taskItem.classList.contains('daily-completed')) {
                        uncompleteDailyTask(id);
                        return; // Stop here, action handled
                    }
                    
                    // Handle showing/hiding action buttons on mobile
                    handleMobileActions(taskItem);

                    // If a button inside the task item was clicked
                    if(e.target.closest('button')) {
                        currentEditingTaskId = id; // Set current task ID for modals
                        
                        if (e.target.closest('.complete-btn')) { 
                            completeTask(id); 
                        }
                        else if (e.target.closest('.delete-btn')) { 
                            deleteTask(id); 
                        }
                        else if (e.target.closest('.timer-clock-btn')) { 
                            const { task } = findTaskAndContext(id); 
                            if (task && task.timerStartTime) { // If timer is active
                                openModal(timerMenuModal); // Show cancel timer modal
                            } else { // If timer is not active
                                openModal(timerModal); // Show set timer modal
                                focusOnDesktop(timerDurationSlider); // Focus on slider
                            }
                        }
                        else if (e.target.closest('.edit-btn')) {
                            const { task, type } = findTaskAndContext(id);
                            if (task) {
                                editTaskIdInput.value = task.id;
                                editTaskInput.value = task.text;
                                // Update modal title and weekly goal section based on task type
                                editTaskModal.querySelector('#edit-task-modal-title').textContent = (type === 'daily') ? 'Edit Daily Quest' : 'Edit Main Quest';
                                if (type === 'daily') {
                                    const goal = task.weeklyGoal || 0;
                                    editWeeklyGoalSlider.value = goal;
                                    updateGoalDisplay(editWeeklyGoalSlider, editWeeklyGoalDisplay); // Update display text
                                    editWeeklyGoalContainer.style.display = 'block';
                                } else {
                                    editWeeklyGoalContainer.style.display = 'none';
                                }
                                openModal(editTaskModal);
                                focusOnDesktop(editTaskInput);
                            }
                        }
                    }
                } 
            });

            // --- Form Submission Handlers ---
            addTaskForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const t = newTaskInput.value.trim(); 
                if (t && currentListToAdd) { 
                    const goal = (currentListToAdd === 'daily') ? parseInt(weeklyGoalSlider.value, 10) : 0; // Only apply goal to daily tasks
                    addTask(t, currentListToAdd, goal); 
                    newTaskInput.value = ''; // Clear input
                    weeklyGoalSlider.value = 0; // Reset slider
                    updateGoalDisplay(weeklyGoalSlider, weeklyGoalDisplay); // Update display text
                    closeModal(addTaskModal); 
                } 
            });
            editTaskForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const id = editTaskIdInput.value; 
                const newText = editTaskInput.value.trim(); 
                const newGoal = parseInt(editWeeklyGoalSlider.value, 10) || 0; 
                if(id && newText) { 
                    editTask(id, newText, newGoal); 
                    closeModal(editTaskModal); 
                } 
            });
            timerForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const v = parseInt(timerDurationSlider.value, 10);
                const u = timerUnitSelector.querySelector('.selected').dataset.unit;
                let minutes = 0; 
                switch(u){ 
                    case 'seconds': minutes = v / 60; break;
                    case 'minutes': minutes = v; break;
                    case 'hours': minutes = v * 60; break;
                    case 'days': minutes = v * 1440; break; // 24 * 60
                    case 'weeks': minutes = v * 10080; break; // 7 * 24 * 60
                    case 'months': minutes = v * 43200; break; // ~30 * 24 * 60
                } 
                if(minutes > 0 && currentEditingTaskId) {
                    startTimer(currentEditingTaskId, minutes); // Start timer in minutes
                    closeModal(timerModal); 
                    currentEditingTaskId = null; // Clear context
                } 
            });
            timerMenuCancelBtn.addEventListener('click', () => { 
                if (currentEditingTaskId) stopTimer(currentEditingTaskId); // Stop timer
                closeModal(timerMenuModal); 
                currentEditingTaskId = null; // Clear context
            });
            
            // Update timer duration display as slider changes
            timerDurationSlider.addEventListener('input', () => timerDurationDisplay.textContent = timerDurationSlider.value);
            
            // Handle timer unit selection
            timerUnitSelector.addEventListener('click', (e) => { 
                const t = e.target.closest('.timer-unit-btn'); 
                if (t) { 
                    timerUnitSelector.querySelector('.selected').classList.remove('selected'); 
                    t.classList.add('selected'); 
                    playSound('toggle'); 
                } 
            });
            
            addGroupForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const n = newGroupInput.value.trim(); 
                if (n) { 
                    addGroup(n); 
                    newGroupInput.value = ''; // Clear input
                    closeModal(addGroupModal); 
                } 
            });
            
            // Button handlers for opening modals
            addTaskTriggerBtnDaily.addEventListener('click', () => { 
                currentListToAdd = 'daily'; 
                weeklyGoalContainer.style.display = 'block'; // Show weekly goal for daily tasks
                addTaskModalTitle.textContent = 'Add Daily Quest'; 
                weeklyGoalSlider.value = 0; // Reset slider
                updateGoalDisplay(weeklyGoalSlider, weeklyGoalDisplay); // Update display text
                openModal(addTaskModal); 
                focusOnDesktop(newTaskInput); 
            });
            addStandaloneTaskBtn.addEventListener('click', () => { 
                currentListToAdd = 'standalone'; 
                weeklyGoalContainer.style.display = 'none'; // Hide weekly goal for standalone tasks
                addTaskModalTitle.textContent = 'Add Main Quest'; 
                openModal(addTaskModal); 
                focusOnDesktop(newTaskInput); 
            });
            addGroupBtn.addEventListener('click', () => { 
                openModal(addGroupModal); 
                focusOnDesktop(newGroupInput); 
            });
            settingsBtn.addEventListener('click', () => openModal(settingsModal));

            // Generic modal close button handler
            document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', (e) => {
                const modalId = e.currentTarget.dataset.closeModal;
                const modal = document.getElementById(modalId);
                if (modal && modal.getAttribute('data-persistent') !== 'true') { // Prevent closing persistent modals
                    closeModal(modal); 
                    if (modalId === 'friends-modal') {
                        // FIX: Restore the active mobile nav button when closing friends modal
                        const activeBtn = mobileNav.querySelector(`.mobile-nav-btn.active`);
                        const prevSection = activeBtn?.dataset.section || 'daily'; // Default to daily
                        // Trigger the show section logic for the previously active tab
                        document.querySelectorAll('.task-group').forEach(group => {
                            group.classList.toggle('mobile-visible', group.dataset.section === prevSection);
                        });
                    }
                }
            }));
            
            // Handle closing modals by clicking outside
            [addTaskModal, editTaskModal, addGroupModal, settingsModal, confirmModal, timerModal, accountModal, manageAccountModal, document.getElementById('username-modal'), document.getElementById('google-signin-loader-modal'), friendsModal].forEach(m => { 
                if (m) m.addEventListener('click', (e) => { 
                    // Close if click is on overlay itself and modal is not persistent
                    if (e.target === m && m.getAttribute('data-persistent') !== 'true') {
                        closeModal(m); 
                    }
                }); 
            });

            // Shows a confirmation modal
            function showConfirm(title, text, cb) { 
                confirmTitle.textContent = title; 
                confirmText.textContent = text; 
                confirmCallback = cb; // Store the callback function
                openModal(confirmModal); 
            }
            // Confirm button action
            confirmActionBtn.addEventListener('click', () => { 
                if (confirmCallback) confirmCallback(); // Execute the stored callback
                closeModal(confirmModal); 
                confirmCallback = null; // Clear callback
            });
            // Cancel button action
            confirmCancelBtn.addEventListener('click', () => { 
                closeModal(confirmModal); 
                confirmCallback = null; // Clear callback
            });

            // Applies theme and accent color settings
            const applySettings = () => { 
                document.documentElement.style.setProperty('--accent', settings.accentColor); 
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.toggle('selected', s.dataset.color === settings.accentColor)); 
                volumeSlider.value = settings.volume; 

                const isDarkModePreference = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const useDarkMode = settings.theme === 'dark' || (settings.theme === 'system' && isDarkModePreference);
                document.documentElement.classList.toggle('dark-mode', useDarkMode);

                // Update theme button selection
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('selected')); 
                const selectedThemeBtn = document.querySelector(`.theme-btn[data-theme="${settings.theme}"]`);
                if (selectedThemeBtn) selectedThemeBtn.classList.add('selected');
            };
            
            // Theme selection buttons
            themeOptionsButtons.addEventListener('click', (e) => { 
                const t = e.target.closest('.theme-btn'); 
                if (t) { 
                    settings.theme = t.dataset.theme; 
                    saveState(); 
                    applySettings(); 
                    playSound('toggle'); 
                } 
            });
            // Accent color selection
            colorOptions.addEventListener('click', (e) => { 
                if(e.target.classList.contains('color-swatch')) { 
                    settings.accentColor = e.target.dataset.color; 
                    saveState(); 
                    applySettings(); 
                } 
            });
            // Volume slider
            volumeSlider.addEventListener('input', () => { 
                settings.volume = parseFloat(volumeSlider.value); 
                saveState(); 
            });
            volumeSlider.addEventListener('change', () => playSound('toggle')); // Play sound on change
            
            // Updates the text for the weekly goal slider
            function updateGoalDisplay(slider, display) {
                const value = slider.value;
                if (value === '0') {
                    display.textContent = 'None';
                } else {
                    display.textContent = `${value} day${value > 1 ? 's' : ''}`;
                }
            }
            weeklyGoalSlider.addEventListener('input', () => updateGoalDisplay(weeklyGoalSlider, weeklyGoalDisplay));
            editWeeklyGoalSlider.addEventListener('input', () => updateGoalDisplay(editWeeklyGoalSlider, editWeeklyGoalDisplay));
            
            // Data management buttons
            resetProgressBtn.addEventListener('click', () => showConfirm('Reset all progress?', 'This cannot be undone. All your tasks, progress, and settings will be lost.', () => { 
                playerData = { level: 1, xp: 0 }; 
                dailyTasks = []; 
                standaloneMainQuests = []; 
                generalTaskGroups = []; 
                localStorage.removeItem('anonymousUserData'); // Also clear guest data
                renderAllLists(); 
                saveState(); 
                playSound('delete'); 
            }));
            exportDataBtn.addEventListener('click', () => { 
                const dataToExport = user ? localStorage.getItem('anonymousUserData') : JSON.stringify({
                    dailyTasks: dailyTasks,
                    standaloneMainQuests: standaloneMainQuests,
                    generalTaskGroups: generalTaskGroups,
                    playerData: playerData,
                    settings: settings
                });
                const b = new Blob([dataToExport || '{}'], {type: "application/json"}), a = document.createElement("a"); 
                a.href = URL.createObjectURL(b); 
                a.download = `procrasti-nope_backup_${user ? 'guest' : user.uid}_${new Date().toISOString().split('T')[0]}.json`; 
                a.click(); 
                URL.revokeObjectURL(a.href); // Clean up URL object
            });
            importDataBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => { 
                const f = e.target.files[0]; 
                if(!f) return; 
                showConfirm("Import Data?", `Importing will overwrite your current ${user ? 'guest' : 'cloud'} progress. Are you sure?`, () => { 
                    const r = new FileReader(); 
                    r.onload = (e) => { 
                        try {
                            const importedData = JSON.parse(e.target.result);
                            // Basic validation, ensure it has the expected structure
                            if (importedData && (importedData.dailyTasks || importedData.settings)) {
                                if (!user) { // Importing as guest
                                    localStorage.setItem('anonymousUserData', e.target.result);
                                } else { // Importing for logged-in user (will be saved to cloud)
                                    // Manually merge data, then saveState will handle cloud upload
                                    loadAndDisplayData(importedData); 
                                    // Save immediately as it's an import action
                                    saveData({ ...importedData, ...{ appData: importedData } }); // Structure for Firebase save
                                }
                                // Reload UI to reflect imported data
                                location.reload(); 
                            } else {
                                alert("Invalid data file. Please ensure it's a valid Procrasti-Nope backup.");
                            }
                        } catch (err) {
                            alert("Error parsing file. Please ensure it's a valid JSON backup.");
                            console.error("Import error:", err);
                        }
                    }; 
                    r.readAsText(f); 
                }); 
                e.target.value = ''; // Clear the input value so the same file can be selected again
            });

            // Sound on hover for interactive elements
            document.body.addEventListener('mouseover', e => { 
                const t = e.target.closest('.btn, .color-swatch, .complete-btn, .main-title, .toggle-btn, .mobile-nav-btn, .task-item, .main-quest-group-header'); // Add more elements as needed
                if (!t || (e.relatedTarget && t.contains(e.relatedTarget))) return; // Only trigger if mouse enters element, not if it's already inside
                playSound('hover'); 
            });
            
            // Manage Account modal logic
            manageAccountBtn.addEventListener('click', () => {
                const reauthContainer = manageAccountModal.querySelector('#reauth-container');
                const manageFormsContainer = manageAccountModal.querySelector('#manage-forms-container');
                const isGoogleUser = currentUser && currentUser.providerData.some(p => p.providerId === 'google.com');

                // Reset form states
                manageAccountModal.querySelectorAll('.error-message, .success-message').forEach(el => el.textContent = '');
                manageAccountModal.querySelectorAll('form').forEach(form => form.reset());

                if (isGoogleUser) {
                    reauthContainer.style.display = 'none';
                    manageFormsContainer.style.display = 'block';
                    // Hide options not applicable or handled differently for Google users
                    manageAccountModal.querySelector('#update-email-form').style.display = 'none'; // Email change handled via re-auth
                    manageAccountModal.querySelector('#update-password-form').style.display = 'none'; // Password change handled via re-auth
                    manageAccountModal.querySelector('#update-username-form').style.display = 'block'; // Username change specific to Google
                    // Clear password fields that are no longer relevant for Google users
                    manageAccountModal.querySelector('#update-email-password').value = '';
                    manageAccountModal.querySelector('#reauth-password').value = '';
                } else { // Email/Password user
                    reauthContainer.style.display = 'block';
                    manageFormsContainer.style.display = 'none'; // Hide forms until re-authenticated
                    // Ensure all forms are potentially visible after re-auth
                    manageAccountModal.querySelector('#update-email-form').style.display = 'block';
                    manageAccountModal.querySelector('#update-password-form').style.display = 'block';
                    manageAccountModal.querySelector('#update-username-form').style.display = 'block';
                }
                openModal(manageAccountModal);
            });

            // Re-authentication form for sensitive actions
            const reauthForm = document.getElementById('reauth-form');
            reauthForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                const password = document.getElementById('reauth-password').value;
                const errorEl = document.getElementById('reauth-error');
                errorEl.textContent = '';

                if (!currentUser || !currentUser.email) { // Should not happen if currentUser is set
                    errorEl.textContent = 'Error: No user logged in.';
                    return;
                }

                const credential = window.firebaseSDK.EmailAuthProvider.credential(currentUser.email, password);

                try {
                    await window.firebaseSDK.reauthenticateWithCredential(currentUser, credential);
                    // On success, hide re-auth and show management forms
                    document.getElementById('reauth-container').style.display = 'none';
                    document.getElementById('manage-forms-container').style.display = 'block';
                    // Clear password field after successful re-auth
                    document.getElementById('reauth-password').value = '';
                } catch (error) {
                    errorEl.textContent = getCoolErrorMessage(error);
                }
            });

            // Update email form
            const updateEmailForm = document.getElementById('update-email-form');
            updateEmailForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newEmail = document.getElementById('update-email-input').value;
                const password = document.getElementById('update-email-password').value; // Password for re-authentication
                const errorEl = document.getElementById('update-email-error');
                const successEl = document.getElementById('update-email-success');
                errorEl.textContent = '';
                successEl.textContent = '';

                if (!password) {
                    errorEl.textContent = 'Please enter your current password to confirm changes.';
                    return;
                }

                try {
                    // Re-authenticate before updating sensitive info
                    const credential = window.firebaseSDK.EmailAuthProvider.credential(currentUser.email, password);
                    await window.firebaseSDK.reauthenticateWithCredential(currentUser, credential);

                    // Update email in Firebase Auth
                    await window.firebaseSDK.updateEmail(currentUser, newEmail);
                    
                    // Update email in Firestore user document
                    const userDocRef = window.firebaseSDK.doc(db, "users", currentUser.uid);
                    await window.firebaseSDK.updateDoc(userDocRef, { email: newEmail });

                    successEl.textContent = 'Email updated successfully!';
                    updateEmailForm.reset(); // Clear form fields
                    // Update the display name if it uses email as fallback
                    updateUserUI(); 

                } catch (error) {
                    errorEl.textContent = getCoolErrorMessage(error);
                }
            });

            // Update password form
            const updatePasswordForm = document.getElementById('update-password-form');
            updatePasswordForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                const newPassword = document.getElementById('update-password-input').value;
                const errorEl = document.getElementById('update-password-error');
                const successEl = document.getElementById('update-password-success');
                errorEl.textContent = '';
                successEl.textContent = '';

                try {
                    await window.firebaseSDK.updatePassword(currentUser, newPassword);
                    successEl.textContent = 'Password updated successfully!';
                    updatePasswordForm.reset(); // Clear form fields
                } catch (error) {
                     errorEl.textContent = getCoolErrorMessage(error);
                }
            });

            // Update username form (specific for Google users or users changing username)
            const updateUsernameForm = document.getElementById('update-username-form');
            updateUsernameForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                const newUsername = document.getElementById('update-username-input').value.trim().toLowerCase();
                const errorEl = document.getElementById('update-username-error');
                const successEl = document.getElementById('update-username-success');
                errorEl.textContent = '';
                successEl.textContent = '';

                if (!currentUser) {
                    errorEl.textContent = "You must be logged in to change your username.";
                    return;
                }
                
                if (!newUsername || newUsername.length < 3) {
                    errorEl.textContent = 'Username must be at least 3 characters.';
                    return;
                }

                try {
                    const userDocRef = window.firebaseSDK.doc(db, "users", currentUser.uid);
                    const userDocSnap = await window.firebaseSDK.getDoc(userDocRef);
                    const currentUsername = userDocSnap.data().username;

                    if (newUsername === currentUsername) {
                        errorEl.textContent = "This is already your username.";
                        return;
                    }
                    
                    // Check if the new username is available in the 'usernames' collection
                    const newUsernameRef = window.firebaseSDK.doc(db, "usernames", newUsername);
                    const newUsernameSnap = await window.firebaseSDK.getDoc(newUsernameRef);
                    
                    if (newUsernameSnap.exists()) {
                        errorEl.textContent = "This username is already taken.";
                        return;
                    }

                    // If username is available, perform batch update:
                    // 1. Delete old username entry from 'usernames' collection
                    // 2. Add new username entry to 'usernames' collection
                    // 3. Update username field in user's document
                    const batch = window.firebaseSDK.writeBatch(db);
                    // Only delete old username if it existed
                    if (currentUsername) {
                        const oldUsernameRef = window.firebaseSDK.doc(db, "usernames", currentUsername);
                        batch.delete(oldUsernameRef);
                    }
                    batch.set(newUsernameRef, { userId: currentUser.uid }); // Map new username to user ID
                    batch.update(userDocRef, { username: newUsername }); // Update username in user doc
                    await batch.commit();

                    successEl.textContent = "Username updated successfully!";
                    updateUserUI(); // Refresh the display name in settings
                    updateUsernameForm.reset();
                } catch (error) {
                    errorEl.textContent = getCoolErrorMessage(error);
                }
            });
            
            // Initialize SortableJS for drag-and-drop functionality
            function initSortable() {
                // Callback function when a task is dropped
                function onTaskDrop(evt) {
                    document.body.classList.remove('is-dragging'); // Remove drag class from body
                    const taskId = evt.item.dataset.id;
                    if (!taskId) return; // Should not happen if task elements are correctly generated

                    // Find the task and its original list
                    const { task, list: sourceListArray } = findTaskAndContext(taskId);
                    if (!task || !sourceListArray) { // Task or source list not found
                        renderAllLists(); // Re-render to reset state in case of error
                        return; 
                    }
                    // Remove task from its original position
                    const originalIndex = sourceListArray.findIndex(t => t.id === taskId);
                    if (originalIndex > -1) sourceListArray.splice(originalIndex, 1);
                    else { // Should not happen if task was found
                        renderAllLists(); 
                        return;
                    }

                    // Determine the destination list
                    const toListEl = evt.to; // The UL element where the item was dropped
                    const toGroupId = toListEl.dataset.groupId; // If it's a group list
                    let destListArray;

                    if (toListEl.id === 'daily-task-list') destListArray = dailyTasks;
                    else if (toListEl.id === 'standalone-task-list') destListArray = standaloneMainQuests;
                    else if (toGroupId) { // Dropped into a group's task list
                        const group = generalTaskGroups.find(g => g.id === toGroupId);
                        if (group) {
                            if (!group.tasks) group.tasks = []; // Ensure tasks array exists
                            destListArray = group.tasks;
                        }
                    }

                    // If destination list could not be determined, put task back in original list
                    if (!destListArray) { 
                        sourceListArray.splice(originalIndex, 0, task); // Put it back
                        renderAllLists(); // Re-render to visually correct it
                        return;
                    }
                    
                    // Insert task into the destination list at the new index
                    destListArray.splice(evt.newIndex, 0, task);
                    
                    saveState(); // Save changes to persistence
                    renderAllLists(); // Re-render to reflect the new order
                }

                // Common SortableJS options
                const commonTaskOptions = {
                    animation: 150, // Animation speed in ms
                    delay: 50, // Delay before drag starts (touch devices)
                    delayOnTouchOnly: true,
                    ghostClass: 'sortable-ghost', // Class for the placeholder element
                    onStart: () => document.body.classList.add('is-dragging'), // Add class to body when dragging starts
                    onEnd: onTaskDrop // Callback when drag ends
                };

                // Apply SortableJS to daily tasks list
                new Sortable(dailyTaskListContainer, { ...commonTaskOptions, group: 'tasks' }); // Group tasks together
                // Apply SortableJS to standalone tasks list
                new Sortable(standaloneTaskListContainer, { ...commonTaskOptions, group: 'tasks' });
                // Apply SortableJS to each group's task list
                document.querySelectorAll('.task-list-group').forEach(listEl => {
                    new Sortable(listEl, { ...commonTaskOptions, group: 'tasks' });
                });
                // Apply SortableJS to general task groups (for reordering groups)
                new Sortable(generalTaskListContainer, {
                    animation: 150,
                    handle: '.main-quest-group-header', // Drag only by the header
                    delay: 50,
                    delayOnTouchOnly: true,
                    ghostClass: 'sortable-ghost',
                    onStart: () => document.body.classList.add('is-dragging'),
                    onEnd: (e) => { // Callback for group reordering
                        document.body.classList.remove('is-dragging');
                        // Reorder groups in the data array
                        const [item] = generalTaskGroups.splice(e.oldIndex, 1);
                        generalTaskGroups.splice(e.newIndex, 0, item);
                        saveState(); // Save the new group order
                        // No re-render needed here, as only order changed visually.
                    }
                });
            }

            // Creates a burst of confetti at a specific location
            function createConfetti(el) { 
                if (!el) return;
                const r = el.getBoundingClientRect(); // Get element's position and size
                createFullScreenConfetti(false, { x: r.left + r.width / 2, y: r.top + r.height / 2 }); // Burst at element's center
            }
            // Creates confetti effects
            function createFullScreenConfetti(party, o = null) { // o = {x, y} origin coordinates
                const count = party ? 200 : 100; // More confetti for full party mode
                for (let i = 0; i < count; i++) {
                    const c = document.createElement('div'); c.className = 'confetti';
                    // Random initial position, centered if origin (o) is provided
                    const sx = o ? o.x : Math.random() * window.innerWidth; 
                    const sy = o ? o.y : -20; // Start slightly above screen
                    c.style.left = `${sx}px`;
                    c.style.top = `${sy}px`;
                    // Random color
                    c.style.backgroundColor = ['var(--accent-pink)', 'var(--accent-blue)', 'var(--accent-green)', 'var(--accent-orange)', 'var(--accent-purple)'][Math.floor(Math.random() * 5)];
                    document.body.appendChild(c);
                    
                    // Animation properties
                    const angle = Math.random() * Math.PI * 2; // Random direction
                    const velocity = 50 + Math.random() * 100; // Random speed
                    const exitX = Math.cos(angle) * velocity * (Math.random() * 5); // Horizontal displacement
                    const exitY = (Math.sin(angle) * velocity) + (window.innerHeight - sy); // Vertical displacement (away from origin)

                    // Apply animation
                    c.animate([
                        { transform: 'translate(0,0) rotate(0deg)', opacity: 1 }, // Start state
                        { transform: `translate(${exitX}px, ${exitY}px) rotate(${Math.random() * 720}deg)`, opacity: 0 } // End state
                    ], {
                        duration: 3000 + Math.random() * 2000, // Random duration
                        easing: 'cubic-bezier(0.1,0.5,0.5,1)' // Easing function
                    }).onfinish = () => c.remove(); // Remove element from DOM when animation ends
                }
                // If it's a full party mode, add a temporary background overlay
                if (party) {
                    const p = document.createElement('div'); p.className = 'party-time-overlay';
                    document.body.appendChild(p);
                    setTimeout(() => p.remove(), 5000); // Remove overlay after 5 seconds
                }
            }
            
            // Renders all task lists (daily, standalone, groups) and initializes sortable
            const renderAllLists = () => { 
                renderDailyTasks(); 
                renderStandaloneTasks(); 
                renderGeneralTasks(); 
                checkOverdueTasks(); // Update overdue status
                initSortable();      // Re-initialize sortable for dynamically added/moved items
                resumeTimers();      // Resume any active timers
            };
            
            // Handles login button click in settings menu
            settingsLoginBtn.addEventListener('click', () => {
                const accountModalContent = accountModal.querySelector('.modal-content');
                setupAuthForms(accountModalContent, () => { // Pass callback for when auth is successful
                    closeModal(accountModal); // Close auth modal
                    closeModal(settingsModal); // Close settings modal
                });
                openModal(accountModal);
            });

            // Logout functionality
            logoutBtn.addEventListener('click', () => {
                showConfirm("Logout?", "Are you sure you want to log out? You will be returned to the landing page.", () => {
                    closeModal(settingsModal); // Close settings modal
                    sessionStorage.removeItem('isGuest'); // Clear guest session flag
                    localStorage.removeItem('userTheme'); // Clear theme preference for fresh login
                    window.firebaseSDK.signOut(auth).catch(error => console.error("Logout Error:", getCoolErrorMessage(error))); // Sign out from Firebase
                    // onAuthStateChanged will handle redirecting to landing page and app shutdown
                });
            });
            
            
            // =========================================================================
            // IMPORT: FRIENDS FEATURE LOGIC
            // =========================================================================

            /**
             * Sets up a real-time listener for the current user's friend requests.
             * This is efficient because it only listens to one document.
             * It updates the UI with a notification badge.
             */
            function listenForFriendRequests() {
                if (!user) return; // Only for logged-in users
                // Unsubscribe from any previous listener to prevent duplicates.
                if (unsubscribeFromFriends) unsubscribeFromFriends();
                
                const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                // Listen for changes to the user document, specifically for friendRequests array
                unsubscribeFromFriends = window.firebaseSDK.onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        const requests = doc.data().friendRequests || [];
                        // Update badge with request count
                        if (requests.length > 0) {
                            friendRequestCountBadge.textContent = requests.length;
                            friendRequestCountBadge.style.display = 'inline';
                        } else {
                            friendRequestCountBadge.style.display = 'none'; // Hide if no requests
                        }
                    }
                }, (error) => {
                    console.error("Error listening to friend requests: ", getCoolErrorMessage(error));
                });
            }

            /**
             * Fetches and renders the current user's friends list and pending requests
             * when the friends modal is opened. This is done on-demand to save reads.
             */
            async function renderFriendsAndRequests() {
                if (!user) return; // Only for logged-in users
                
                const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                const userDoc = await window.firebaseSDK.getDoc(userDocRef);
                if (!userDoc.exists()) return; // User doc not found, something is wrong

                const userData = userDoc.data();
                const friendUIDs = userData.friends || [];
                const requestUIDs = userData.friendRequests || [];
                
                // Render Friends List
                if (friendUIDs.length === 0) {
                    friendsListContainer.innerHTML = `<p style="text-align: center; padding: 1rem;">Go add some friends!</p>`;
                } else {
                    friendsListContainer.innerHTML = ''; // Clear existing list
                    // Efficiently fetch multiple user profiles using a query with 'in' clause
                    const friendsQuery = window.firebaseSDK.query(
                        window.firebaseSDK.collection(db, "users"), 
                        window.firebaseSDK.where(window.firebaseSDK.documentId(), 'in', friendUIDs)
                    );
                    const friendDocs = await window.firebaseSDK.getDocs(friendsQuery);
                    friendDocs.forEach(doc => {
                         const friend = doc.data();
                         const level = friend.appData?.playerData?.level || 1; // Get friend's level, default to 1
                         const friendEl = document.createElement('div');
                         friendEl.className = 'friend-item';
                         // HTML structure for a friend item
                         friendEl.innerHTML = `<div class="friend-level-display">LVL ${level}</div><span class="friend-name">${friend.username}</span><div class="friend-item-actions"><button class="btn icon-btn remove-friend-btn" data-uid="${doc.id}" aria-label="Remove friend">&times;</button></div>`;
                         friendsListContainer.appendChild(friendEl);
                    });
                }

                // Render Requests List
                if (requestUIDs.length === 0) {
                    friendRequestsContainer.innerHTML = `<p style="text-align: center; padding: 1rem;">No new requests.</p>`;
                } else {
                    friendRequestsContainer.innerHTML = ''; // Clear existing list
                    // Fetch details of users who sent requests
                    const requestsQuery = window.firebaseSDK.query(
                        window.firebaseSDK.collection(db, "users"), 
                        window.firebaseSDK.where(window.firebaseSDK.documentId(), 'in', requestUIDs)
                    );
                    const requestDocs = await window.firebaseSDK.getDocs(requestsQuery);
                    requestDocs.forEach(doc => {
                        const requestUser = doc.data();
                        const requestEl = document.createElement('div');
                        requestEl.className = 'friend-request-item';
                        // HTML structure for a friend request item
                        requestEl.innerHTML = `<span>${requestUser.username}</span><div class="friend-request-actions"><button class="btn icon-btn accept-request-btn" data-uid="${doc.id}" aria-label="Accept request">&#10003;</button><button class="btn icon-btn decline-request-btn" data-uid="${doc.id}" aria-label="Decline request">&times;</button></div>`;
                        friendRequestsContainer.appendChild(requestEl);
                    });
                }
            }
            
            // Handles the action of sending a friend request
            async function handleAddFriend(e) {
                e.preventDefault();
                const usernameToFind = searchUsernameInput.value.trim().toLowerCase();
                friendStatusMessage.textContent = ''; // Clear previous messages
                
                if (!user || !usernameToFind) return; // Ensure user is logged in and input is not empty

                // Get current user's data to check for self-addition or existing friendship
                const currentUserDoc = await window.firebaseSDK.getDoc(window.firebaseSDK.doc(db, "users", user.uid));
                const currentUserData = currentUserDoc.data();

                if (usernameToFind === currentUserData.username) {
                    friendStatusMessage.textContent = "You can't add yourself!";
                    friendStatusMessage.style.color = 'var(--accent-red-light)';
                    return;
                }
                
                // Efficiently check if the username exists in the 'usernames' collection.
                const usernamesRef = window.firebaseSDK.doc(db, "usernames", usernameToFind);
                const usernameSnap = await window.firebaseSDK.getDoc(usernamesRef);

                if (!usernameSnap.exists()) { // Username not found
                    friendStatusMessage.textContent = "User not found.";
                    friendStatusMessage.style.color = 'var(--accent-red-light)';
                    return;
                }
                
                const targetUserId = usernameSnap.data().userId;
                const targetUserRef = window.firebaseSDK.doc(db, "users", targetUserId);
                
                // Check if already friends or if request is pending
                if (currentUserData.friends?.includes(targetUserId)) {
                    friendStatusMessage.textContent = "You are already friends!";
                    friendStatusMessage.style.color = 'var(--accent-orange-light)';
                    return;
                }
                if (currentUserData.friendRequests?.includes(targetUserId)) {
                     friendStatusMessage.textContent = "Friend request already sent.";
                     friendStatusMessage.style.color = 'var(--accent-orange-light)';
                     return;
                }

                // Use a transaction to safely update both users' documents.
                try {
                    // Add current user's ID to the target user's friendRequests array
                    await window.firebaseSDK.updateDoc(targetUserRef, {
                        friendRequests: window.firebaseSDK.arrayUnion(user.uid)
                    });
                    friendStatusMessage.textContent = `Friend request sent to ${usernameToFind}!`;
                    friendStatusMessage.style.color = 'var(--accent-green-light)';
                    searchUsernameInput.value = ''; // Clear input field
                } catch (error) {
                    friendStatusMessage.textContent = "Could not send request.";
                    friendStatusMessage.style.color = 'var(--accent-red-light)';
                    console.error("Error sending friend request:", getCoolErrorMessage(error));
                }
            }
            
            // Handles accepting or declining a friend request
            async function handleRequestAction(e, action) {
                const button = e.target.closest('button');
                if (!button) return;

                const senderUid = button.dataset.uid; // The UID of the user who sent the request
                const currentUserRef = window.firebaseSDK.doc(db, "users", user.uid);
                
                // Use a batch write for atomic operations
                const batch = window.firebaseSDK.writeBatch(db);
                
                // Always remove the request from the current user's list.
                batch.update(currentUserRef, { friendRequests: window.firebaseSDK.arrayRemove(senderUid) });

                if (action === 'accept') {
                    const senderUserRef = window.firebaseSDK.doc(db, "users", senderUid);
                    // Add each other to their respective friends lists.
                    batch.update(currentUserRef, { friends: window.firebaseSDK.arrayUnion(senderUid) });
                    batch.update(senderUserRef, { friends: window.firebaseSDK.arrayUnion(user.uid) });
                }
                // If action is 'decline', only the removal from requests is needed.
                
                await batch.commit(); // Execute the batch
                renderFriendsAndRequests(); // Re-render the lists to reflect changes
            }
            
            // Removes a friend from the friends list
            async function removeFriend(e) {
                const button = e.target.closest('button');
                if (!button) return;
                const friendUidToRemove = button.dataset.uid; // The UID of the friend to remove
                
                // Prompt for confirmation before proceeding
                showConfirm("Remove Friend?", "Are you sure you want to remove this friend? This action cannot be undone.", async () => {
                    const currentUserRef = window.firebaseSDK.doc(db, "users", user.uid);
                    const friendUserRef = window.firebaseSDK.doc(db, "users", friendUidToRemove);
                    
                    // Use a batch write to remove each other from friends lists
                    const batch = window.firebaseSDK.writeBatch(db);
                    batch.update(currentUserRef, { friends: window.firebaseSDK.arrayRemove(friendUidToRemove) });
                    batch.update(friendUserRef, { friends: window.firebaseSDK.arrayRemove(user.uid) });
                    
                    await batch.commit();
                    renderFriendsAndRequests(); // Re-render lists
                });
            }

            // Event listeners for interactions within the Friends Modal
            friendsBtnDesktop.addEventListener('click', () => {
                openModal(friendsModal);
                renderFriendsAndRequests(); // Load and display friends/requests when modal opens
            });
            
            addFriendForm.addEventListener('submit', handleAddFriend); // Handle sending friend requests
            
            // Event delegation for accept/decline buttons within friend requests list
            friendRequestsContainer.addEventListener('click', e => {
                 if (e.target.closest('.accept-request-btn')) handleRequestAction(e, 'accept');
                 if (e.target.closest('.decline-request-btn')) handleRequestAction(e, 'decline');
            });
            
            // Event delegation for remove friend button within friends list
            friendsListContainer.addEventListener('click', e => {
                if (e.target.closest('.remove-friend-btn')) removeFriend(e);
            });
            
            // Handle switching tabs within the friends modal
            friendsModal.querySelector('.form-toggle').addEventListener('click', (e) => {
                if (e.target.matches('.toggle-btn')) {
                    const tab = e.target.dataset.tab; // Get target tab ID (my-friends, requests, add-friend)
                    // Update active button state
                    friendsModal.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    // Show/hide corresponding tab content
                    friendsModal.querySelectorAll('.tab-content').forEach(form => form.classList.toggle('active', form.id === `${tab}-tab`));
                }
            });

            // =========================================================================
            // IMPORT: MOBILE NAVIGATION LOGIC
            // =========================================================================
            mobileNav.addEventListener('click', (e) => {
                const button = e.target.closest('.mobile-nav-btn');
                if (!button) return; // Exit if click was not on a nav button

                const section = button.dataset.section; // Get target section (daily, main, friends)
                
                // Keep track of the last selected section (excluding friends) to return to.
                if (section !== 'friends') {
                    lastSection = section;
                }

                // Update active button state
                mobileNav.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Handle navigation
                if (section === 'friends') {
                    openModal(friendsModal); // Open the friends modal
                    renderFriendsAndRequests(); // Load data into friends modal
                } else {
                    // Show only the selected task group section on mobile
                    document.querySelectorAll('.task-group').forEach(group => {
                        group.classList.toggle('mobile-visible', group.dataset.section === section);
                    });
                }
                playSound('toggle'); // Sound feedback for navigation
            });

            // Account Deletion Logic
            deleteAccountBtn.addEventListener('click', () => {
                showConfirm('Delete Account?', 'This action is irreversible and will permanently delete your account and all associated data. Are you absolutely sure?', async () => {
                    try {
                        // For Google users, re-authentication isn't needed via password
                        const isGoogleUser = currentUser.providerData.some(p => p.providerId === 'google.com');
                        
                        if (!isGoogleUser) { // For email/password users, require password confirmation
                           const password = document.getElementById('reauth-password').value; // Get password from manage account form
                           // If the user hasn't re-authenticated yet, prompt them or ensure they do
                           if (!password) { 
                                // Show error, or better, force re-authentication by showing re-auth form first
                                alert("Please re-enter your password to confirm deletion."); // Simple alert for now
                                return;
                           }
                           const credential = window.firebaseSDK.EmailAuthProvider.credential(currentUser.email, password);
                           await window.firebaseSDK.reauthenticateWithCredential(currentUser, credential);
                        }

                        // Get username before deleting user doc, necessary for deleting from 'usernames' collection
                        const userDocRef = window.firebaseSDK.doc(db, "users", currentUser.uid);
                        const userDocSnap = await window.firebaseSDK.getDoc(userDocRef);
                        const username = userDocSnap.exists() ? userDocSnap.data().username : null;

                        // Perform deletions in a batch write for atomicity
                        const batch = window.firebaseSDK.writeBatch(db);
                        batch.delete(userDocRef); // Delete user's main document
                        if (username) { // If username exists, delete its entry in the 'usernames' collection
                            const usernameDocRef = window.firebaseSDK.doc(db, "usernames", username);
                            batch.delete(usernameDocRef);
                        }
                        // Consider other collections like 'friendRequests' if they were stored per-user

                        await batch.commit(); // Commit all deletions
                        
                        // Delete user from Firebase Authentication itself
                        await window.firebaseSDK.deleteUser(currentUser);
                        
                        // Close modals and trigger logout
                        closeModal(manageAccountModal);
                        window.firebaseSDK.signOut(auth); // Sign out from Firebase
                        // Reload page to ensure full cleanup and redirect to landing page
                        window.location.reload(); 
                    } catch (error) {
                        console.error("Error deleting account:", getCoolErrorMessage(error));
                        // Display error to user, maybe in the manage account modal
                        const errorEl = document.getElementById('reauth-error') || document.getElementById('update-password-error'); // Try to find an error element
                        if (errorEl) errorEl.textContent = getCoolErrorMessage(error);
                        else alert("Error deleting account: " + getCoolErrorMessage(error));
                    }
                });
            });


            // --- Main App Initialization Flow ---
            async function loadUserSession() {
                await initialLoad(); // Load data from Firestore or localStorage
                await updateUserUI(); // Update UI based on login status and user data
                await promptForUsernameIfNeeded(); // Prompt for username if necessary
                await updateUserUI(); // Update UI again in case username was set
                checkDailyReset(); // Check for daily resets (e.g., new day)
                resumeTimers(); // Resume any active timers after page load/refresh
            }
            
            // Function to run one-time setup tasks
            const initOnce = () => {
                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applySettings);
                showRandomQuote(); // Display a random quote on load
                setInterval(checkOverdueTasks, 60 * 1000); // Check for overdue tasks every minute
            };

            initOnce(); // Run one-time setup
            await loadUserSession(); // Load user data and initialize app

            // Return object with methods to manage the app lifecycle
            return {
                isPartial: false, // Indicate the app controller is fully initialized
                shutdown: () => { // Clean up listeners and intervals when app is closed (e.g., logout)
                     Object.keys(activeTimers).forEach(id => clearInterval(activeTimers[id]));
                     if (unsubscribeFromFirestore) unsubscribeFromFirestore(); // Cleanup Firestore listener
                     if (unsubscribeFromFriends) unsubscribeFromFriends(); // Cleanup friends listener
                     // Remove global listeners if any were added
                },
                updateUser: async (newUser) => { // Method to handle user switching (e.g., login/logout)
                    user = newUser;
                    await loadUserSession(); // Reload session data with the new user
                }
            };
        }

        // =========================================================================
        // UTILITY/SHARED AUTH FUNCTIONS
        // =========================================================================
        // Provides user-friendly error messages for Firebase auth errors.
        function getCoolErrorMessage(error) {
            const defaultMessage = "An unexpected vortex appeared! Please try again.";
            if (!error) return defaultMessage;
            
            // Specific Firebase Auth error codes
            switch (error.code) {
                case 'auth/invalid-email': return "Hmm, that email doesn't look right. Check for typos?";
                case 'auth/user-disabled': return "This account has been disabled. Contact support for help.";
                case 'auth/user-not-found': return "No account found with this email or username. Time to sign up?";
                case 'auth/wrong-password': return "Incorrect password. Did you forget? It happens to the best of us!";
                case 'auth/email-already-in-use': return "An account with this email already exists. Try logging in!";
                case 'auth/weak-password': return "Password should be at least 6 characters long. Make it strong!";
                case 'auth/requires-recent-login': return "This is a sensitive action. Please log in again to continue.";
                case 'auth/popup-closed-by-user': return "Sign-in cancelled. Did you change your mind?";
                case 'auth/account-exists-with-different-credential': return "You've already signed up with this email using a different method (e.g., Google). Try logging in that way!";
                case 'auth/too-many-requests': return "You have made too many sign-in attempts. Please wait a bit before trying again.";
                case 'auth/invalid-credential': return "Invalid login credentials. Please check your username and password.";
                case 'auth/network-request-failed': return "Network error. Please check your internet connection.";
                // Firestore specific errors
                case 'permission-denied': return "Permission Denied! Please check your Firestore Security Rules.";
                // Generic errors
                default:
                    console.error("Firebase/App Error:", error); // Log original error for debugging
                    // Check for custom error messages or generic fallback
                    return error.message || defaultMessage;
            }
        }

        // --- Merge Guest Data Logic ---
        // This function is called when a logged-in user might have previous guest data.
        function mergeGuestDataWithCloud(cloudData = {}) {
            const guestDataString = localStorage.getItem('anonymousUserData');
            if (!guestDataString) return cloudData; // No guest data to merge

            try {
                const guestData = JSON.parse(guestDataString);
                // Deep clone cloud data to avoid modifying it directly if it's a reference
                const mergedData = JSON.parse(JSON.stringify(cloudData)); 

                // Helper to merge task lists, prioritizing existing tasks and adding new ones
                const mergeTasks = (cloudTasks = [], guestTasks = []) => {
                    const existingTexts = new Set(cloudTasks.map(t => t.text)); // Use text as a proxy for task uniqueness for simplicity
                    const newTasks = guestTasks.filter(t => !existingTexts.has(t.text)); // Add tasks from guest that don't exist in cloud
                    return [...cloudTasks, ...newTasks]; // Combine lists
                };
                
                mergedData.dailyTasks = mergeTasks(cloudData.dailyTasks, guestData.dailyTasks);
                mergedData.standaloneMainQuests = mergeTasks(cloudData.standaloneMainQuests, guestData.standaloneMainQuests);

                // Merge general task groups
                if (guestData.generalTaskGroups) {
                    if (!mergedData.generalTaskGroups) mergedData.generalTaskGroups = []; // Initialize if cloud has no groups
                    guestData.generalTaskGroups.forEach(guestGroup => {
                        // Try to find an existing group by name in cloud data
                        const cloudGroup = mergedData.generalTaskGroups.find(cg => cg.name === guestGroup.name);
                        if (cloudGroup) { // If group exists, merge its tasks
                            cloudGroup.tasks = mergeTasks(cloudGroup.tasks, guestGroup.tasks);
                        } else { // Otherwise, add the guest group as a new group
                            mergedData.generalTaskGroups.push(guestGroup);
                        }
                    });
                }

                // Merge player data (XP and Level)
                if (guestData.playerData) {
                    if (!mergedData.playerData) { // If cloud has no player data, use guest data
                        mergedData.playerData = guestData.playerData;
                    } else {
                        // Add XP from guest to cloud XP
                        mergedData.playerData.xp = (mergedData.playerData.xp || 0) + (guestData.playerData.xp || 0);
                        // Take the higher level between cloud and guest
                        mergedData.playerData.level = Math.max(mergedData.playerData.level || 1, guestData.playerData.level || 1);
                    }
                }
                
                // Merge settings, prioritizing cloud settings over guest settings if both exist
                mergedData.settings = { ...guestData.settings, ...cloudData.settings }; 
                
                return mergedData;
            } catch (error) {
                console.error("Failed to merge guest data:", error);
                return cloudData; // Return original cloud data if merging fails
            }
        }

        // --- Firebase Auth State Observer ---
        // This is the main entry point for managing user sessions and initializing the app.
        window.firebaseSDK.onAuthStateChanged(auth, async (user) => {
            // Clean up any existing listeners to prevent memory leaks
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore(); 
                unsubscribeFromFirestore = null;
            }
            if (unsubscribeFromFriends) {
                unsubscribeFromFriends();
                unsubscribeFromFriends = null;
            }
            
            currentUser = user; // Update the global currentUser variable
            
            if (user) { // User is logged in
                // Check for and merge guest data if present
                const guestDataString = localStorage.getItem('anonymousUserData');
                if (guestDataString) {
                    try {
                        const userDocRef = window.firebaseSDK.doc(db, "users", user.uid);
                        const docSnap = await window.firebaseSDK.getDoc(userDocRef);
                        const cloudData = docSnap.exists() && docSnap.data().appData ? docSnap.data().appData : {};
                        const mergedData = mergeGuestDataWithCloud(cloudData);
                        // Save the merged data back to Firestore
                        await window.firebaseSDK.setDoc(userDocRef, { appData: mergedData }, { merge: true });
                        localStorage.removeItem('anonymousUserData'); // Clear guest data
                        sessionStorage.removeItem('isGuest'); // Clear guest session flag
                    } catch (mergeError) {
                        console.error("Failed to merge guest data on login:", mergeError);
                    }
                }

                // Initialize the app controller if it hasn't been already
                if (!appController) {
                    appController = await initializeAppLogic(user); 
                } else {
                    // If appController already exists (e.g., page refresh), update it with new user info
                    await appController.updateUser(user);
                }
                
                // Transition from landing/loading to the main app view
                landingPage.style.display = 'none';
                appWrapper.style.display = 'block';
                loaderOverlay.style.display = 'none';

            } else { // User is logged out
                // Check if they are continuing as a guest
                if (sessionStorage.getItem('isGuest')) {
                    if (!appController) {
                        // Initialize app logic for guest mode
                        appController = await initializeAppLogic(null);
                    }
                    // Transition to app view for guest
                    landingPage.style.display = 'none';
                    appWrapper.style.display = 'block';
                    loaderOverlay.style.display = 'none';
                } else {
                    // User is fully logged out, show landing page
                    loaderOverlay.style.display = 'none';
                    landingPage.style.display = 'flex';
                    appWrapper.style.display = 'none';
                    // Shut down the app controller to stop listeners and clear state
                    if(appController) appController.shutdown();
                    appController = null;
                }
            }
        });

        // --- Initialize Firebase App ---
        try {
            app = window.firebaseSDK.initializeApp(firebaseConfig);
            auth = window.firebaseSDK.getAuth(app);
            db = window.firebaseSDK.getFirestore(app);
            // The onAuthStateChanged listener will be triggered after Firebase is initialized.
        } catch (err) {
            console.error("Firebase initialization failed:", err);
            // Display error message if Firebase fails to initialize
            loaderOverlay.innerHTML = `<p style="color: var(--text);">Error: Could not connect to backend. Please check your Firebase configuration or internet connection.</p>`;
            loaderOverlay.style.display = 'flex'; // Ensure loader is visible to show error
        }

    </script>
</body>
</html>